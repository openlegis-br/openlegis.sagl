var lacunaWebPKIExtension=null;LacunaWebPKI=function(a){this.license=null,this.defaultFailCallback=null,this.angularScope=null,this.brand=null,this.restPkiUrl=null,a&&(this.license=a)},function(a){if(a.Promise=function(a){this.successCallback=function(){},this.failCallback=null,this.angularScope=a},a.Promise.prototype.success=function(a){return this.successCallback=a,this},a.Promise.prototype.error=function(a){return this.failCallback=function(b){a(b.message,b.error,b.origin,b.code)},this},a.Promise.prototype.fail=function(a){return this.failCallback=a,this},a.Promise.prototype._invokeSuccess=function(b,c){if(c>0){var d=this;setTimeout(function(){d._invokeSuccess(b)},c)}else{var e=this.successCallback||function(){a._log("Success ignored (no callback registered)")};this._apply(function(){e(b)})}},a.Promise.prototype._invokeError=function(a,b){if(b>0){var c=this;setTimeout(function(){c._invokeError(a)},b)}else{var d=this.failCallback||function(a){throw"Web PKI error originated at "+a.origin+": "+a.message+"\n"+a.complete+"\ncode: "+a.code};this._apply(function(){d({message:a.message,error:a.complete,origin:a.origin,code:a.code})})}},a.Promise.prototype._apply=function(a){if(this.angularScope){var b=this.angularScope.$root.$$phase;"$apply"==b||"$digest"==b?a():this.angularScope.$apply(function(){a()})}else a()},a._installUrl="https://get.webpkiplugin.com/",a._chromeExtensionId="dcngeagmmhegagicpcmpinaoklddcgon",a._firefoxExtensionId="webpki@lacunasoftware.com",a._chromeExtensionFirstVersionWithSelfUpdate="2.0.20",a._chromeExtensionRequiredVersion="2.6.6",a._firefoxExtensionRequiredVersion="0.0.0",a._chromeNativeWinRequiredVersion="2.2.8",a._chromeNativeLinuxRequiredVersion="2.4.1",a._chromeNativeMacRequiredVersion="2.4.1",a._ieAddonRequiredVersion="2.2.4",a._chromeInstallationStates={INSTALLED:0,EXTENSION_NOT_INSTALLED:1,EXTENSION_OUTDATED:2,NATIVE_NOT_INSTALLED:3,NATIVE_OUTDATED:4},a._certKeyUsages={crlSign:2,dataEncipherment:16,decipherOnly:32768,digitalSignature:128,encipherOnly:1,keyAgreement:8,keyCertSign:4,keyEncipherment:32,nonRepudiation:64},a._nativeInfo={},a.installationStates={INSTALLED:0,NOT_INSTALLED:1,OUTDATED:2,BROWSER_NOT_SUPPORTED:3},a.padesPolicies={basic:"basic",brazilAdrBasica:"brazilAdrBasica"},a.cadesPolicies={bes:"cadesBes",brazilAdrBasica:"brazilAdrBasica"},a.cadesAcceptablePolicies={pkiBrazil:["brazilAdrBasica","brazilAdrTempo","brazilAdrValidacao","brazilAdrCompleta","brazilAdrArquivamento"]},a.standardTrustArbitrators={pkiBrazil:{type:"standard",standardArbitrator:"pkiBrazil"},pkiItaly:{type:"standard",standardArbitrator:"pkiItaly"},pkiPeru:{type:"standard",standardArbitrator:"pkiPeru"},windows:{type:"standard",standardArbitrator:"windows"}},a.outputModes={showSaveFileDialog:"showSaveFileDialog",saveInFolder:"saveInFolder",autoSave:"autoSave"},a.trustArbitratorTypes={trustedRoot:"trustedRoot",tsl:"tsl",standard:"standard"},a.padesPaperSizes={custom:"custom",a0:"a0",a1:"a1",a2:"a2",a3:"a3",a4:"a4",a5:"a5",a6:"a6",a7:"a7",a8:"a8",letter:"letter",legal:"legal",ledger:"ledger"},a.padesHorizontalAlign={left:"left",center:"center",rigth:"rigth"},a.padesVerticalAlign={top:"top",center:"center",bottom:"bottom"},a.padesMeasurementUnits={centimeters:"centimeters",pdfPoints:"pdfPoints"},a.padesPageOrientations={auto:"auto",portrait:"portrait",landscape:"landscape"},a.markElementTypes={text:"text",image:"image"},a.markTextStyle={normal:0,bold:1,italic:2},a.passwordPolicies={lettersAndNumbers:1,upperAndLowerCase:2,specialCharacters:4},a.pkcs11Modules={safeSign:{win:"aetpkss1.dll",linux:"libaetpkss.so.3",mac:"libaetpkss.dylib"},safeNet:{win:"eTPKCS11.dll",linux:"libeToken.so",mac:"libeToken.dylib"}},a.errorCodes={UNDEFINED:"undefined",INTERNAL:"internal",USER_CANCELLED:"user_cancelled",OS_NOT_SUPPORTED:"os_not_supported",ADDON_TIMEOUT:"addon_timeout",ADDON_NOT_DETECTED:"addon_not_detected",ADDON_SEND_COMMAND_FAILURE:"addon_send_command_failure",CERTIFICATE_NOT_FOUND:"certificate_not_found",COMMAND_UNKNOWN:"command_unknown",COMMAND_NOT_SUPPORTED:"command_not_supported",COMMAND_PARAMETER_NOT_SET:"command_parameter_not_set",COMMAND_INVALID_PARAMETER:"command_invalid_parameter",NATIVE_CONNECT_FAILURE:"native_connect_failure",NATIVE_DISCONNECTED:"native_disconnected",NATIVE_NO_RESPONSE:"native_no_response",REST_PKI_GET_PENDING_SIGNATURE:"rest_pki_get_pending_signature",REST_PKI_POST_SIGNATURE:"rest_pki_post_signature",REST_PKI_INVALID_CERTIFICATE:"rest_pki_invalid_certificate",LICENSE_NOT_SET:"license_not_set",LICENSE_INVALID:"license_invalid",LICENSE_RESTRICTED:"license_restricted",LICENSE_EXPIRED:"license_expired",LICENSE_DOMAIN_NOT_ALLOWED:"license_domain_not_allowed",VALIDATION_ERROR:"validation_error",P11_ERROR:"p11_error",P11_TOKEN_NOT_FOUND:"p11_token_not_found",P11_NOT_SUPPORTED:"p11_not_supported",KEYSET_NOT_FOUND:"keyset_not_found",ALGORITHM_NOT_SUPPORTED:"algorithm_not_supported",SIGNED_PDF_TO_MARK:"signed_pdf_to_mark",JSON_ERROR:"json_error",IO_ERROR:"io_error",KEYCHAIN_ERROR:"keychain_error",KEYCHAIN_SIGN_ERROR:"keychain_sign_error",DECODE_ERROR:"decode_error",CSP_KEYSET_NOT_DEFINED:"csp_keyset_not_defined",CSP_INVALID_ALGORITHM:"csp_invalid_algorithm",CSP_INVALID_PROVIDER_TYPE:"csp_invalid_provider_type"},a._compareVersions=function(a,b){function c(a){return/^\d+$/.test(a)}function d(a){for(var b=0;b<a.length;++b)if(!c(a[b]))return!1;return!0}var e=a.split("."),f=b.split(".");if(!d(e)||!d(f))return NaN;for(var g=0;g<e.length;++g){if(f.length===g)return 1;var h=parseInt(e[g],10),i=parseInt(f[g],10);if(h!==i)return h>i?1:-1}return e.length!=f.length?-1:0},a._log=function(a){window.console&&window.console.log(a)},a._parseDataUrl=function(b){var c=/^data:(.+);base64,(.+)$/.exec(b);return c?{mimeType:c[1],content:c[2]}:(a._log("failed to parse data url"),null)},a._downloadResource=function(b,c){a._log("resolving resource reference: "+b);var d=new XMLHttpRequest;d.open("GET",b),d.responseType="blob",d.onload=function(){var b=new FileReader;b.onloadend=function(){a._log("resource reference resolved");var d=a._parseDataUrl(b.result);c(d)},b.readAsDataURL(d.response)},d.send()},a._getRequestOsP11Modules=function(b){if(!b||!b.length)return null;osModules=[];for(var c=0;c<b.length;c++)"Windows"===a._nativeInfo.os?osModules.push(b[c].win):"Linux"===a._nativeInfo.os?osModules.push(b[c].linux):"Darwin"===a._nativeInfo.os&&osModules.push(b[c].mac);return osModules},a._createContext=function(b){var c=new a.Promise(this.angularScope);b&&b.success&&c.success(b.success),b&&b.fail?c.fail(b.fail):b&&b.error?c.error(b.error):c.fail(this.defaultFailCallback);var d={promise:c,license:this.license};return d},a.init=function(b){b?"function"==typeof b&&(b={ready:b}):b={},b.license&&(this.license=b.license),b.defaultError&&(this.defaultFailCallback=function(a){b.defaultError(a.message,a.error,a.origin,a.code)}),b.defaultFail&&(this.defaultFailCallback=b.defaultFail),b.angularScope&&(this.angularScope=b.angularScope),b.brand&&(this.brand=b.brand),b.restPkiUrl&&(this.restPkiUrl=b.restPkiUrl);var c=this,d=function(d){d.isInstalled?b.ready?b.ready():a._log("Web PKI ready (no callback registered)"):b.notInstalled?b.notInstalled(d.status,d.message,d.browserSpecificStatus):c.redirectToInstallPage()},e=this._createContext({success:d,fail:b.fail,error:b.error});return a._requestHandler.checkInstalled(e),e.promise},a.getVersion=function(b){var c=this._createContext(b);return a._requestHandler.sendCommand(c,"getVersion",null),c.promise},a.listCertificates=function(b){if(b){if(b.filter&&"function"!=typeof b.filter)throw"boolean"==typeof b.filter?'args.filter must be a function (hint: if you used "pki.filters.xxx()", try removing the "()")':"args.filter must be a function, received "+typeof b.filter}else b={};var c=this._createContext(b);return a._requestHandler.sendCommand(c,"listCertificates",null,function(c){return a._processCertificates(c,b.filter,b.selectId,b.selectOptionFormatter)}),c.promise},a._processCertificates=function(b,c,d,e){for(var f=[],g=0;g<b.length;g++){var h=b[g];if(h.validityStart=new Date(h.validityStart),h.validityEnd=new Date(h.validityEnd),h.keyUsage=a._processKeyUsage(h.keyUsage),h.pkiBrazil&&h.pkiBrazil.dateOfBirth){var i=h.pkiBrazil.dateOfBirth;h.pkiBrazil.dateOfBirth=new Date(parseInt(i.slice(0,4),10),parseInt(i.slice(5,7),10)-1,parseInt(i.slice(8,10),10))}c?c(h)&&f.push(h):f.push(h)}if(d){e||(e=function(a){return a.subjectName+" (issued by "+a.issuerName+")"});for(var j=document.getElementById(d);j.options.length>0;)j.remove(0);for(var k=0;k<f.length;k++){var l=f[k],m=document.createElement("option");m.value=l.thumbprint,m.text=e(l),j.add(m)}}return f},a._processKeyUsage=function(b){return{crlSign:0!==(b&a._certKeyUsages.crlSign),dataEncipherment:0!==(b&a._certKeyUsages.dataEncipherment),decipherOnly:0!==(b&a._certKeyUsages.decipherOnly),digitalSignature:0!==(b&a._certKeyUsages.digitalSignature),encipherOnly:0!==(b&a._certKeyUsages.encipherOnly),keyAgreement:0!==(b&a._certKeyUsages.keyAgreement),keyCertSign:0!==(b&a._certKeyUsages.keyCertSign),keyEncipherment:0!==(b&a._certKeyUsages.keyEncipherment),nonRepudiation:0!==(b&a._certKeyUsages.nonRepudiation)}},a.filters={isPkiBrazilPessoaFisica:function(a){if("undefined"==typeof a)throw'filter called without cert argument (hint: if you are using "pki.filters.isPkiBrazilPessoaFisica()", try "pki.filters.isPkiBrazilPessoaFisica")';return a.pkiBrazil&&""!==(a.pkiBrazil.cpf||"")&&""===(a.pkiBrazil.cnpj||"")},hasPkiBrazilCpf:function(a){if("undefined"==typeof a)throw'filter called without cert argument (hint: if you are using "pki.filters.hasPkiBrazilCpf()", try "pki.filters.hasPkiBrazilCpf")';return a.pkiBrazil&&""!==(a.pkiBrazil.cpf||"")},hasPkiBrazilCnpj:function(a){if("undefined"==typeof a)throw'filter called without cert argument (hint: if you are using "pki.filters.hasPkiBrazilCnpj()", try "pki.filters.hasPkiBrazilCnpj")';return a.pkiBrazil&&""!==(a.pkiBrazil.cnpj||"")},pkiBrazilCpfEquals:function(a){if("string"!=typeof a)throw'cpf must be a string (hint: if you are using "pki.filters.pkiBrazilCpfEquals", try "pki.filters.pkiBrazilCpfEquals(\'somecpf\')")';return function(b){return b.pkiBrazil&&b.pkiBrazil.cpf===a}},pkiBrazilCnpjEquals:function(a){if("string"!=typeof a)throw'cnpj must be a string (hint: if you are using "pki.filters.pkiBrazilCnpjEquals", try "pki.filters.pkiBrazilCnpjEquals(\'somecnpj\')")';return function(b){return b.pkiBrazil&&b.pkiBrazil.cnpj===a}},hasPkiItalyCodiceFiscale:function(a){if("undefined"==typeof a)throw'filter called without cert argument (hint: if you are using "pki.filters.hasPkiItalyCodiceFiscale()", try "pki.filters.hasPkiItalyCodiceFiscale")';return a.pkiItaly&&""!==(a.pkiItaly.codiceFiscale||"")},pkiItalyCodiceFiscaleEquals:function(a){if("string"!=typeof a)throw'cf must be a string (hint: if you are using "pki.filters.pkiItalyCodiceFiscaleEquals", try "pki.filters.pkiItalyCodiceFiscaleEquals(\'someCodice\')")';return function(b){return b.pkiItaly&&b.pkiItaly.codiceFiscale===a}},isWithinValidity:function(a){if("undefined"==typeof a)throw'filter called without cert argument (hint: if you are using "pki.filters.isWithinValidity()", try "pki.filters.isWithinValidity")';var b=new Date;return a.validityStart<=b&&b<=a.validityEnd},all:function(){var a;return a=1===arguments.length&&"object"==typeof arguments[0]?arguments[0]:arguments,function(b){for(var c=0;c<a.length;c++){var d=a[c];if(!d(b))return!1}return!0}},any:function(){var a;return a=1===arguments.length&&"object"==typeof arguments[0]?arguments[0]:arguments,function(b){for(var c=0;c<a.length;c++){var d=a[c];if(d(b))return!0}return!1}}},a.readCertificate=function(b){"string"==typeof b&&(b={thumbprint:b});var c=this._createContext(b);return a._requestHandler.sendCommand(c,"readCertificate",{certificateThumbprint:b.thumbprint}),c.promise},a.saveFile=function(b){var c=this._createContext({});return a._requestHandler.sendCommand(c,"saveFile",b),c.promise},a.pollNative=function(b){b||(b={});var c=this._createContext(b),d=a._chromeNativeWinRequiredVersion,e=a._chromeNativeLinuxRequiredVersion,f=a._chromeNativeMacRequiredVersion;return a._requestHandler.sendCommand(c,"pollNative",{requiredNativeWinVersion:d,requiredNativeLinuxVersion:e,requiredNativeMacVersion:f}),c.promise},a.signHash=function(b){var c=this._createContext(b),d={certificateThumbprint:b.thumbprint,hash:b.hash,digestAlgorithm:b.digestAlgorithm};return a._requestHandler.sendCommand(c,"signHash",d),c.promise},a.signData=function(b){var c=this._createContext(b),d={certificateThumbprint:b.thumbprint,data:b.data,digestAlgorithm:b.digestAlgorithm};return a._requestHandler.sendCommand(c,"signData",d),c.promise},a.signWithRestPki=function(b){var c=this._createContext(b),d={certificateThumbprint:b.thumbprint,token:b.token,restPkiUrl:this.restPkiUrl};return a._requestHandler.sendCommand(c,"signWithRestPki",d),c.promise},a.preauthorizeSignatures=function(b){b||(b={});var c=this._createContext(b),d={certificateThumbprint:b.certificateThumbprint,signatureCount:b.signatureCount};return a._requestHandler.sendCommand(c,"preauthorizeSignatures",d),c.promise},a.showFolderBrowser=function(b){b?"string"==typeof b&&(b={message:b}):b={};var c=this._createContext(b),d={message:b.message};return a._requestHandler.sendCommand(c,"showFolderBrowser",d),c.promise},a.showFileBrowser=function(b){b||(b={});var c=this._createContext(b),d={multiselect:b.multiselect,filters:b.filters,dialogTitle:b.dialogTitle};return a._requestHandler.sendCommand(c,"showFileBrowser",d),c.promise},a.downloadToFolder=function(b){b||(b={});var c=b.url||"";if(c.indexOf("://")<0){var d=document.createElement("a");d.href=c,c=d.href}var e=this._createContext(b),f={url:c,folderId:b.folderId,filename:b.filename};return a._requestHandler.sendCommand(e,"downloadToFolder",f),e.promise},a.openFolder=function(b){b?"string"==typeof b&&(b={folderId:b}):b={};var c=this._createContext(b);return a._requestHandler.sendCommand(c,"openFolder",b.folderId),c.promise},a.openFile=function(b){b?"string"==typeof b&&(b={fileId:b}):b={};var c=this._createContext(b);return a._requestHandler.sendCommand(c,"openFile",b.fileId),c.promise},a.redirectToInstallPage=function(){document.location.href=a._installUrl+(this.brand||"")+"?returnUrl="+encodeURIComponent(document.URL)+"&jslib=2.7.0"},a.updateExtension=function(b){b||(b={});var c=this._createContext(b);return a._requestHandler.sendCommand(c,"updateExtension",null),c.promise},a.detectedBrowser=function(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+)/g.exec(b)||[],"IE "+(a[1]||"")):"Chrome"===c[1]&&(a=b.match(/\b(OPR|Edge)\/(\d+)/),null!==a)?a.slice(1).join(" ").replace("OPR","Opera"):(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c.join(" "))}(),a.signPdf=function(b){var c=this._createContext(b),d={fileId:b.fileId,certificateThumbprint:b.certificateThumbprint,output:{mode:b.output.mode,folderId:b.output.folderId,dialogTitle:b.output.dialogTitle,fileNameSuffix:b.output.fileNameSuffix},trustArbitrators:b.trustArbitrators,clearPolicyTrustArbitrators:b.clearPolicyTrustArbitrators,visualRepresentation:b.visualRepresentation,pdfMarks:b.pdfMarks,bypassMarksIfSigned:b.bypassMarksIfSigned,policy:b.policy};return d.visualRepresentation&&d.visualRepresentation.image&&d.visualRepresentation.image.resource&&!d.visualRepresentation.image.resource.content&&d.visualRepresentation.image.resource.url&&!/^(https?:)?\/\//.exec(d.visualRepresentation.image.resource.url)?a._downloadResource(d.visualRepresentation.image.resource.url,function(b){d.visualRepresentation.image.resource=b,a._requestHandler.sendCommand(c,"signPdf",d)}):a._requestHandler.sendCommand(c,"signPdf",d),c.promise},a.signCades=function(b){var c=this._createContext(b),d={fileId:b.fileId,certificateThumbprint:b.certificateThumbprint,output:{mode:b.output.mode,folderId:b.output.folderId,dialogTitle:b.output.dialogTitle,fileNameSuffix:b.output.fileNameSuffix},trustArbitrators:b.trustArbitrators,clearPolicyTrustArbitrators:b.clearPolicyTrustArbitrators,cmsToCosignFileId:b.cmsToCosignFileId,autoDetectCosign:b.autoDetectCosign,includeEncapsulatedContent:null===b.includeEncapsulatedContent||void 0===b.includeEncapsulatedContent||b.includeEncapsulatedContent,policy:b.policy};return a._requestHandler.sendCommand(c,"signCades",d),c.promise},a.openPades=function(b){var c=this._createContext(b),d={signatureFileId:b.signatureFileId,validate:b.validate,dateReference:b.dateReference,trustArbitrators:b.trustArbitrators,clearPolicyTrustArbitrators:b.clearPolicyTrustArbitrators,specificPolicy:b.specificPolicy};return a._requestHandler.sendCommand(c,"openPades",d),c.promise},a.openCades=function(b){var c=this._createContext(b),d={signatureFileId:b.signatureFileId,originalFileId:b.originalFileId,validate:b.validate,dateReference:b.dateReference,trustArbitrators:b.trustArbitrators,clearPolicyTrustArbitrators:b.clearPolicyTrustArbitrators,specificPolicy:b.specificPolicy,acceptablePolicies:b.acceptablePolicies};return a._requestHandler.sendCommand(c,"openCades",d),c.promise},a.listTokens=function(b){var c=this._createContext(b),d={pkcs11Modules:a._getRequestOsP11Modules(b.pkcs11Modules)};return a._requestHandler.sendCommand(c,"listTokens",d),c.promise},a.generateTokenRsaKeyPair=function(b){var c=this._createContext(b),d={pkcs11Modules:a._getRequestOsP11Modules(b.pkcs11Modules),subjectName:b.subjectName,tokenSerialNumber:b.tokenSerialNumber,keyLabel:b.keyLabel,keySize:b.keySize};return a._requestHandler.sendCommand(c,"generateTokenRsaKeyPair",d),c.promise},a.generateSoftwareRsaKeyPair=function(b){var c=this._createContext(b),d={subjectName:b.subjectName,keySize:b.keySize};return a._requestHandler.sendCommand(c,"generateSoftwareRsaKeyPair",d),c.promise},a.importTokenCertificate=function(b){var c=this._createContext(b),d={pkcs11Modules:a._getRequestOsP11Modules(b.pkcs11Modules),tokenSerialNumber:b.tokenSerialNumber,certificateContent:b.certificateContent,certificateLabel:b.certificateLabel};return a._requestHandler.sendCommand(c,"importTokenCertificate",d),c.promise},a.importCertificate=function(b){var c=this._createContext(b),d={certificateContent:b.certificateContent,passwordPolicies:b.passwordPolicies,passwordMinLength:b.passwordMinLength,savePkcs12:b.savePkcs12};return a._requestHandler.sendCommand(c,"importCertificate",d),c.promise},void 0===a._requestHandler){var b=a.detectedBrowser.indexOf("IE")>=0,c=a.detectedBrowser.indexOf("Chrome")>=0,d=a.detectedBrowser.indexOf("Firefox")>=0;if(b)a._requestHandler=new function(){var b={},c=0,d=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},e=function(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()},f=function(a,d){var f=e();return b[f]={promise:a,pollStart:c,responseProcessor:d},f},g=function(){return lacunaWebPKIExtension},h=function(){if(g()){var a=g().GetAvailableResults();if(null===a)throw"Add-on method GetAvailableResults failed";var d=JSON.parse(a),e=[];for(var f in b){var i=b[f],j=!1;if(i.sendFailed)j=!0;else{for(var k=null,l=0;l<d.length;l++)if(d[l].requestId==f){k=d[l];break}null!==k?(k.success?(i.responseProcessor&&(k.response=i.responseProcessor(k.response)),i.promise._invokeSuccess(k.response)):i.promise._invokeError(k.exception),j=!0):c>=i.pollStart+120&&(i.promise._invokeError({message:"The operation has timed out",error:"The operation has timed out",origin:"helper",code:"addon_timeout"}),j=!0)}j&&e.push(f)}for(var m=0;m<e.length;m++)delete b[e[m]];c+=1}setTimeout(h,500)},i=function(b,c){if(a._log("checking extension"),null===g())return void(c>1?setTimeout(function(){i(b,c-1)},200):b.promise._invokeSuccess({isInstalled:!1,status:a.installationStates.NOT_INSTALLED,message:"The Web PKI add-on is not installed"}));var d=new a.Promise(null);d.success(function(c){a._nativeInfo={os:"Windows",installedVersion:c},a._compareVersions(c,a._ieAddonRequiredVersion)<0?b.promise._invokeSuccess({isInstalled:!1,status:a.installationStates.OUTDATED,message:"The Web PKI add-on is outdated (installed version: "+c+", latest version: "+a._ieAddonRequiredVersion+")"}):b.promise._invokeSuccess({isInstalled:!0})}),d.fail(function(a){b.promise._invokeError(a)}),j({license:b.license,promise:d},"getVersion",null)},j=function(a,c,d,e){if(g()){var h,i=f(a.promise,e),j={requestId:i,license:a.license,command:c,request:d};try{var k=g().SendCommand(JSON.stringify(j));k===!1&&(h="Failed to send command to add-on")}catch(l){h="Exception when sending command to add-on: "+l}h&&(a.promise._invokeError({message:"Failed to send command to add-on",error:h,origin:"helper",code:"addon_send_command_failure"},200),b[i].sendFailed=!0)}else a.promise._invokeError({message:"Add-on not detected",error:"Add-on not detected",origin:"helper",code:"addon_not_detected"},200)},k=function(a){setTimeout(function(){i(a,25)},200)};this.sendCommand=j,this.checkInstalled=k,h()};else{var e="0.0.0",f=null;c?(e=a._chromeExtensionRequiredVersion,f=a._chromeExtensionFirstVersionWithSelfUpdate):d&&(e=a._firefoxExtensionRequiredVersion),a._requestHandler=new function(){var b="com.lacunasoftware.WebPKI.RequestEvent",d="com.lacunasoftware.WebPKI.ResponseEvent",g={},h=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},i=function(){return h()+h()+"-"+h()+"-"+h()+"-"+h()+"-"+h()+h()+h()},j=function(a,b){var c=i();return g[c]={promise:a,responseProcessor:b},c},k=function(a,d,e,f){var g=j(a.promise,f),h={requestId:g,license:a.license,command:d,request:e};if(c){var i=new CustomEvent("build",{detail:h});i.initEvent(b),document.dispatchEvent(i)}else window.postMessage({port:b,message:h},"*")},l=function(a){setTimeout(function(){m(a,25)},200)},m=function(b,c){a._log("polling extension");var d=document.getElementById(a._chromeExtensionId)||document.getElementById(a._firefoxExtensionId.replace(/[^A-Za-z0-9_]/g,"_"));return null===d?void(c>1?setTimeout(function(){m(b,c-1)},200):b.promise._invokeSuccess({isInstalled:!1,status:a.installationStates.NOT_INSTALLED,message:"The Web PKI extension is not installed",browserSpecificStatus:a._chromeInstallationStates.EXTENSION_NOT_INSTALLED})):void n(b)},n=function(b){a._log("checking extension version");var c=new a.Promise(null);c.success(function(c){if(a._compareVersions(c,e)<0){var d=null!==f&&a._compareVersions(c,f)>=0;b.promise._invokeSuccess({isInstalled:!1,status:a.installationStates.OUTDATED,browserSpecificStatus:a._chromeInstallationStates.EXTENSION_OUTDATED,message:"The Web PKI extension is outdated (installed version: "+c+", required version: "+e+")",chromeExtensionCanSelfUpdate:d})}else o(b)}),c.fail(function(a){b.promise._invokeError(a)}),k({license:b.license,promise:c},"getExtensionVersion",null)},o=function(b){a._log("initializing extension");var c=new a.Promise(null);c.success(function(c){c.isReady?(a._nativeInfo=c.nativeInfo,"Windows"===c.nativeInfo.os&&a._compareVersions(c.nativeInfo.installedVersion,a._chromeNativeWinRequiredVersion)<0?b.promise._invokeSuccess({isInstalled:!1,status:a.installationStates.OUTDATED,browserSpecificStatus:a._chromeInstallationStates.NATIVE_OUTDATED,message:"The Web PKI native component is outdated (installed version: "+c.nativeInfo.installedVersion+", required version: "+a._chromeNativeWinRequiredVersion+")",platformInfo:c.platformInfo,nativeInfo:c.nativeInfo}):"Linux"===c.nativeInfo.os&&a._compareVersions(c.nativeInfo.installedVersion,a._chromeNativeLinuxRequiredVersion)<0?b.promise._invokeSuccess({isInstalled:!1,status:a.installationStates.OUTDATED,browserSpecificStatus:a._chromeInstallationStates.NATIVE_OUTDATED,message:"The Web PKI native component is outdated (installed version: "+c.nativeInfo.installedVersion+", required version: "+a._chromeNativeLinuxRequiredVersion+")",platformInfo:c.platformInfo,nativeInfo:c.nativeInfo}):"Darwin"===c.nativeInfo.os&&a._compareVersions(c.nativeInfo.installedVersion,a._chromeNativeMacRequiredVersion)<0?b.promise._invokeSuccess({isInstalled:!1,status:a.installationStates.OUTDATED,browserSpecificStatus:a._chromeInstallationStates.NATIVE_OUTDATED,message:"The Web PKI native component is outdated (installed version: "+c.nativeInfo.installedVersion+", required version: "+a._chromeNativeMacRequiredVersion+")",platformInfo:c.platformInfo,nativeInfo:c.nativeInfo}):b.promise._invokeSuccess({isInstalled:!0})):b.promise._invokeSuccess({isInstalled:!1,status:p(c.status),browserSpecificStatus:c.status,message:c.message,platformInfo:c.platformInfo,nativeInfo:c.nativeInfo})}),c.fail(function(a){b.promise._invokeError(a)}),k({license:b.license,promise:c},"initialize",null)},p=function(b){return b===a._chromeInstallationStates.INSTALLED?a.installationStates.INSTALLED:b===a._chromeInstallationStates.EXTENSION_OUTDATED||b===a._chromeInstallationStates.NATIVE_OUTDATED?a.installationStates.OUTDATED:a.installationStates.NOT_INSTALLED},q=function(a){var b=g[a.requestId];delete g[a.requestId],a.success?(b.responseProcessor&&(a.response=b.responseProcessor(a.response)),b.promise._invokeSuccess(a.response)):b.promise._invokeError(a.exception)};this.sendCommand=k,this.checkInstalled=l,c?document.addEventListener(d,function(a){q(a.detail)}):window.addEventListener("message",function(a){a&&a.data&&a.data.port===d&&q(a.data.message)})}}}}(LacunaWebPKI.prototype);