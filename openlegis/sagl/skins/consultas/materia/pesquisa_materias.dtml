<dtml-var header_html>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">

<style>
    /* ============================================
       CLASSES CUSTOMIZADAS APENAS QUANDO NECESSÁRIO
       PADRONIZAÇÃO COM TEMA GLOBAL DO SISTEMA
       Cores principais do tema: --bs-primary (#44a2d2)
       Fonte padrão: --bs-body-font-size (0.93rem)
       Fonte botões: --bs-btn-font-size (13px)
       ============================================ */
    
    /* 1. Filter Toggle Icon - animação específica */
    .filter-toggle-icon {
        transition: transform 0.35s ease-in-out;
        display: inline-block;
    }
    .filter-toggle-icon.expanded {
        transform: rotate(90deg);
    }
    
    /* 1.1. Garantir legibilidade do botão de filtros avançados no hover */
    button[data-bs-target="#advancedSearch"],
    button[data-bs-target="#advancedSearch"]:hover,
    button[data-bs-target="#advancedSearch"]:focus,
    button[data-bs-target="#advancedSearch"]:active {
        color: var(--bs-body-color, #212529) !important;
        background-color: transparent !important;
    }
    button[data-bs-target="#advancedSearch"]:hover {
        color: var(--bs-primary, #44a2d2) !important;
        background-color: transparent !important;
    }
    button[data-bs-target="#advancedSearch"] span.fw-semibold,
    button[data-bs-target="#advancedSearch"]:hover span.fw-semibold,
    button[data-bs-target="#advancedSearch"]:focus span.fw-semibold {
        color: inherit !important;
    }
    button[data-bs-target="#advancedSearch"] i,
    button[data-bs-target="#advancedSearch"]:hover i {
        color: var(--bs-primary, #44a2d2) !important;
    }
    
    /* 1.2. Garantir legibilidade do card-header dos filtros avançados no hover */
    #advancedSearch .card-header,
    #advancedSearch .card-header:hover,
    #advancedSearch .card-header h5,
    #advancedSearch .card-header h5:hover {
        background-color: #fff !important;
        color: var(--bs-body-color, #212529) !important;
    }
    #advancedSearch .card-header i,
    #advancedSearch .card-header i:hover {
        color: var(--bs-primary, #44a2d2) !important;
    }
    
    /* 2. TomSelect customizações */
    .ts-dropdown {
        font-size: var(--bs-body-font-size, 1rem);
    }
    
    .ts-dropdown .optgroup-header {
        font-size: 0.9em;
        padding-top: 8px;
        padding-bottom: 2px;
        background-color: var(--bs-gray-100, #f8f9fa);
    }
    
    /* Harmonizar tamanho de fonte das opções no dropdown */
    .ts-dropdown .option,
    .ts-dropdown .ts-option {
        font-size: var(--bs-body-font-size, 1rem);
        padding: 0.5rem 0.75rem;
        line-height: 1.5;
    }
    
    /* Garantir que o texto das opções tenha tamanho consistente */
    .ts-dropdown .option .text,
    .ts-dropdown .ts-option .text,
    .ts-dropdown .option,
    .ts-dropdown .ts-option {
        font-size: var(--bs-body-font-size, 1rem);
    }
    
    /* Input de busca no dropdown */
    .ts-dropdown input[type="text"],
    .ts-dropdown input[type="search"],
    .ts-dropdown .input-wrap input {
        font-size: var(--bs-body-font-size, 1rem);
        padding: 0.5rem 0.75rem;
    }
    
    /* Garantir que o texto de "no results" e outros textos no dropdown tenham tamanho consistente */
    .ts-dropdown .no-results,
    .ts-dropdown .create {
        font-size: var(--bs-body-font-size, 1rem);
        padding: 0.5rem 0.75rem;
    }
    
    /* 2.1. Padronização visual entre selects múltiplos e simples */
    /* Garantir que selects simples e múltiplos tenham aparência consistente quando selecionados */
    
    /* Estilo padronizado para chips em selects múltiplos - mais discretos */
    .ts-wrapper.multi .ts-control .item {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.125rem 0.375rem;
        margin: 0;
        background-color: var(--bs-tertiary-bg, #f8f9fa);
        color: var(--bs-body-color, #212529);
        border: 1px solid var(--bs-border-color-translucent, rgba(0, 0, 0, 0.075));
        border-radius: 0.25rem;
        font-size: var(--bs-body-font-size, 1rem);
        line-height: 1.5;
        font-weight: 400;
        height: auto;
        max-height: calc(1.5em + 0.25rem);
    }
    
    /* Estilo para o item selecionado em selects simples - mais discreto */
    .ts-wrapper.single .ts-control .item {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.125rem 0.375rem;
        margin: 0;
        background-color: var(--bs-tertiary-bg, #f8f9fa);
        color: var(--bs-body-color, #212529);
        border: 1px solid var(--bs-border-color-translucent, rgba(0, 0, 0, 0.075));
        border-radius: 0.25rem;
        font-size: var(--bs-body-font-size, 1rem);
        line-height: 1.5;
        font-weight: 400;
        height: auto;
        max-height: calc(1.5em + 0.25rem);
    }
    
    /* Garantir padding e font-size consistente no controle - usar mesma fonte dos inputs */
    /* Altura fixa para não mudar quando há itens selecionados */
    .ts-wrapper.single .ts-control,
    .ts-wrapper.multi .ts-control {
        padding: 0.375rem 0.75rem;
        min-height: calc(1.5em + 0.75rem + 2px);
        height: calc(1.5em + 0.75rem + 2px);
        font-size: var(--bs-body-font-size, 1rem);
        line-height: 1.5;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.25rem;
        overflow: hidden;
    }
    
    /* Garantir que o controle tenha tamanho de fonte e altura consistente em todos os estados */
    .ts-wrapper.single .ts-control,
    .ts-wrapper.multi .ts-control,
    .ts-wrapper.single:not(.has-items) .ts-control,
    .ts-wrapper.multi:not(.has-items) .ts-control,
    .ts-wrapper.single.has-items .ts-control,
    .ts-wrapper.multi.has-items .ts-control {
        font-size: var(--bs-body-font-size, 1rem);
        height: calc(1.5em + 0.75rem + 2px);
        min-height: calc(1.5em + 0.75rem + 2px);
    }
    
    /* Botão de remoção consistente para selects múltiplos - mais discreto */
    .ts-wrapper.multi .ts-control .item .remove {
        border-left: 1px solid var(--bs-border-color-translucent, rgba(0, 0, 0, 0.075));
        padding-left: 0.375rem;
        margin-left: 0.375rem;
        cursor: pointer;
        opacity: 0.5;
        color: var(--bs-body-color, #212529);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        align-self: center;
    }
    
    .ts-wrapper.multi .ts-control .item .remove:hover {
        opacity: 1;
        background-color: var(--bs-danger-bg-subtle, rgba(220, 53, 69, 0.1));
        color: var(--bs-danger, #dc3545);
    }
    
    /* Botão clear para selects simples */
    .ts-wrapper.single .ts-control .clear-button {
        color: #6c757d;
        opacity: 0.6;
    }
    
    .ts-wrapper.single .ts-control .clear-button:hover {
        opacity: 1;
        color: #212529;
    }
    
    /* Garantir que o input de busca tenha o mesmo estilo em ambos */
    .ts-wrapper.single .ts-control input,
    .ts-wrapper.multi .ts-control input {
        font-size: var(--bs-body-font-size, 1rem);
        padding: 0;
        margin: 0;
        color: inherit;
        height: auto;
        line-height: 1.5;
        border: none;
        background: transparent;
        flex: 1;
        min-width: 50px;
    }
    
    /* Placeholder consistente */
    .ts-wrapper.single .ts-control .placeholder,
    .ts-wrapper.multi .ts-control .placeholder {
        color: #6c757d;
        font-size: var(--bs-body-font-size, 1rem);
        padding: 0;
        line-height: 1.5;
    }
    
    /* Garantir que o placeholder tenha o mesmo tamanho mesmo quando o controle está vazio */
    .ts-wrapper.single:not(.has-items) .ts-control .placeholder,
    .ts-wrapper.multi:not(.has-items) .ts-control .placeholder {
        font-size: var(--bs-body-font-size, 1rem);
    }
    
    /* Garantir altura fixa mesmo quando há itens selecionados */
    .ts-wrapper.single.has-items .ts-control,
    .ts-wrapper.multi.has-items .ts-control {
        min-height: calc(1.5em + 0.75rem + 2px);
        height: calc(1.5em + 0.75rem + 2px);
        font-size: var(--bs-body-font-size, 1rem);
    }
    
    /* Harmonizar selects nativos com TomSelect */
    /* Aplicar apenas a selects que não estão dentro de um wrapper TomSelect */
    select.form-select:not(.ts-hidden-accessible) {
        padding: 0.375rem 0.75rem;
        font-size: var(--bs-body-font-size, 1rem);
        line-height: 1.5;
        min-height: calc(1.5em + 0.75rem + 2px);
    }
    
    /* Garantir que selects dentro de wrapper TomSelect não sejam afetados */
    .ts-wrapper select.form-select {
        padding: 0;
        font-size: inherit;
        line-height: inherit;
        min-height: auto;
    }
    
    /* 3. Skeleton Loading - funcionalidade específica */
    .skeleton-loading {
        animation: skeleton-loading 1.5s infinite ease-in-out;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
    }
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .skeleton-row {
        height: 38px;
        margin-bottom: 8px;
        border-radius: var(--bs-border-radius, 0.25rem);
    }
    
    /* 4. Acessibilidade - usar classes Bootstrap quando possível */
    [aria-busy="true"] {
        opacity: 0.7;
        cursor: progress;
    }
    
    /* 5. Badges de Filtro - usar Bootstrap badge + utilities */
    .filter-badge {
        display: inline-flex;
        align-items: center;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    /* 6. Sortable Header - funcionalidade específica de ordenação */
    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 2rem !important;
        white-space: nowrap;
    }
    .sortable-header:hover {
        color: var(--bs-primary, #44a2d2);
        background-color: rgba(68, 162, 210, 0.05) !important; /* Opacidade do tema primário */
    }
    .sortable-header::after {
        content: '⇅';
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.875rem;
        color: var(--bs-secondary, #6c757d);
        opacity: 0.4;
        font-weight: normal;
        transition: all 0.15s ease;
    }
    .sortable-header:hover::after {
        opacity: 0.7;
        color: var(--bs-primary, #44a2d2);
    }
    .sortable-header.asc::after {
        content: '↑';
        color: var(--bs-primary, #44a2d2);
        opacity: 1;
        font-weight: bold;
    }
    .sortable-header.desc::after {
        content: '↓';
        color: var(--bs-primary, #44a2d2);
        opacity: 1;
        font-weight: bold;
    }
    .sortable-header.asc,
    .sortable-header.desc {
        background-color: rgba(68, 162, 210, 0.08) !important; /* Opacidade do tema primário */
        font-weight: 600;
    }
    /* 7. Toast Container - usar position utilities do Bootstrap quando possível */
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1055;
    }
    
    /* 8. Card View Container - grid específico para cards */
    .card-view-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    @media (max-width: 576px) {
        .card-view-container {
            grid-template-columns: 1fr;
        }
    }
    @media (min-width: 992px) {
        .card-view-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    @media (min-width: 1400px) {
        .card-view-container {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    /* 9. Card Matéria - layout específico (usar Bootstrap card + esta classe) */
    .card-materia {
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
        transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0, 0, 0, 0.1);
        /* Otimizações para evitar borda serrilhada no hover */
        will-change: transform, box-shadow;
        backface-visibility: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        /* Força renderização suave dos cantos */
        border-radius: var(--bs-border-radius, 0.375rem);
        isolation: isolate; /* Cria novo contexto de empilhamento */
        /* Renderização suave de bordas com aceleração de hardware */
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        /* Anti-aliasing específico para bordas arredondadas */
        -webkit-perspective: 1000px;
        perspective: 1000px;
        /* Força renderização de subpixels para bordas suaves */
        -webkit-transform-style: preserve-3d;
        transform-style: preserve-3d;
    }
    /* Pseudo-elemento para borda suave no hover */
    .card-materia::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: inherit;
        border: 1px solid transparent;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
    }
    .card-materia:hover {
        /* Usa translate3d para melhor renderização */
        -webkit-transform: translate3d(0, -4px, 0);
        transform: translate3d(0, -4px, 0);
        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.15) !important;
        border-color: transparent; /* Remove borda padrão no hover */
    }
    .card-materia:hover::before {
        opacity: 1;
        border-color: var(--bs-primary, #44a2d2); /* Cor primária do tema */
    }
    .card-materia:focus-within {
        outline: 2px solid var(--bs-primary, #44a2d2); /* Cor primária do tema */
        outline-offset: 2px;
    }
    .card-materia .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
    }
    
    /* CARD HEADER - Padronização com tema global */
    .card-materia .card-header {
        background-color: rgba(68, 162, 210, 0.12) !important; /* Fundo destacado com cor primária do tema - mantém legibilidade */
        border-bottom: 2px solid rgba(68, 162, 210, 0.2) !important; /* Borda inferior para mais destaque */
        padding: 1rem 1.25rem !important; /* Espaçamento adequado */
    }
    
    /* Seções com background unificado - usando cores do tema */
    .card-section-detalhes,
    .card-section-status {
        background-color: rgba(68, 162, 210, 0.08) !important; /* Opacidade da cor primária do tema */
        border-left: 3px solid var(--bs-primary, #44a2d2); /* Cor primária do tema */
        border-radius: var(--bs-border-radius, 0.375rem);
        padding: 1.25rem;
        margin-bottom: 1.25rem;
    }
    
    /* Redução da margem inferior da seção de status para aproximar do footer */
    .card-section-status {
        margin-bottom: 0.5rem;
    }
    
    /* Texto das informações sem negrito para diferenciar do label */
    .card-section-detalhes span,
    .card-section-status span {
        font-weight: 400 !important; /* Peso normal para valores, labels mantêm negrito */
    }
    
    /* 10. Highlight de texto de busca */
    mark {
        background-color: #FFEB3B;
        padding: 0.1em 0.2em;
        border-radius: var(--bs-border-radius-sm, 0.25rem);
    }
    
    /* Melhorias de legibilidade e espaçamento */
    .card-body .mb-4 {
        margin-bottom: 1.5rem !important;
    }
    .card-body strong.text-uppercase {
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        font-weight: 600;
        color: var(--bs-dark, #212529);
    }
    .card-body .text-break {
        line-height: 1.7;
        font-size: 0.95rem;
        color: var(--bs-body-color, #212529);
    }
    /* Melhor contraste para texto secundário */
    .card-body .text-secondary {
        color: var(--bs-gray-700, #495057) !important;
        font-weight: 500;
    }
    /* Ícones importantes mais visíveis (mantém text-primary e text-muted conforme HTML) */
    .card-body .text-primary.fa,
    .card-body .text-primary.fas,
    .card-body .text-primary.far {
        color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
    }
    .card-body .text-muted.fa,
    .card-body .text-muted.fas,
    .card-body .text-muted.far {
        color: var(--bs-gray-600, #6c757d) !important;
    }
    
    /* 11. Badge clicável - cursor pointer - melhorado feedback visual */
    .badge-clickable {
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        /* Otimizações para evitar borda serrilhada no hover */
        will-change: transform;
        backface-visibility: hidden;
        transform: translateZ(0); /* Força aceleração de hardware */
    }
    /* Estado normal - garantir legibilidade do texto em badges com fundo claro */
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable *,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable i {
        color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
        font-weight: 500;
    }
    /* Garantir que links visitados também mantenham cor legível */
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:link,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:visited,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:link *,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:visited * {
        color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
    }
    /* Estado focus para badges com bg-opacity-10 - mudar para fundo sólido e texto branco */
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:focus,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:focus-visible,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:focus *,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:focus-visible * {
        background-color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
        color: #fff !important;
        border-color: var(--bs-primary, #44a2d2) !important;
        outline: 2px solid var(--bs-primary, #44a2d2) !important;
        outline-offset: 2px !important;
    }
    .badge-clickable:hover {
        transform: translate3d(0, -2px, 0) scale(1.05); /* Usa translate3d para melhor renderização */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    /* Hover para botões de Texto Integral e Redação Final - texto branco */
    .badge.bg-primary.badge-clickable:hover,
    .badge.bg-primary.badge-clickable:hover * {
        background-color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
        color: #fff !important;
        border-color: var(--bs-primary, #44a2d2) !important;
    }
    /* Hover específico para badges com bg-opacity-10 - garantir texto branco legível */
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:hover,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:hover *,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:hover i,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:link:hover,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:visited:hover,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:link:hover *,
    .badge.bg-primary.bg-opacity-10.text-primary.badge-clickable:visited:hover * {
        background-color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
        color: #fff !important;
        border-color: var(--bs-primary, #44a2d2) !important;
    }
    /* Estados active para botões de Texto Integral quando não está em hover */
    .badge.bg-primary.badge-clickable:active:not(:hover),
    .badge.bg-primary.badge-clickable:active:not(:hover) * {
        background-color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
        color: #fff !important;
        border-color: var(--bs-primary, #44a2d2) !important;
    }
    /* Estado focus - garantir texto legível (branco sobre fundo azul) */
    .badge.bg-primary.badge-clickable:focus,
    .badge.bg-primary.badge-clickable:focus-visible,
    .badge.bg-primary.badge-clickable:focus *,
    .badge.bg-primary.badge-clickable:focus-visible * {
        background-color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
        color: #fff !important;
        border-color: var(--bs-primary, #44a2d2) !important;
        outline: 2px solid var(--bs-primary, #44a2d2) !important;
        outline-offset: 2px !important;
    }
    /* Quando focus e hover juntos, manter texto branco */
    .badge.bg-primary.badge-clickable:focus:hover,
    .badge.bg-primary.badge-clickable:focus-visible:hover,
    .badge.bg-primary.badge-clickable:focus:hover *,
    .badge.bg-primary.badge-clickable:focus-visible:hover * {
        background-color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
        color: #fff !important;
        border-color: var(--bs-primary, #44a2d2) !important;
    }
    /* Visited mantém estado normal (texto azul escuro) a menos que esteja em hover ou focus */
    .badge.bg-primary.badge-clickable:visited:not(:hover):not(:focus):not(:focus-visible),
    .badge.bg-primary.badge-clickable:visited:not(:hover):not(:focus):not(:focus-visible) * {
        background-color: rgba(68, 162, 210, 0.1) !important; /* Opacidade da cor primária do tema */
        color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
        border-color: rgba(68, 162, 210, 0.25) !important;
    }
    .badge.bg-success.badge-clickable:hover,
    .badge.bg-success.badge-clickable:hover * {
        background-color: var(--bs-success, #28a745) !important;
        color: #fff !important;
        border-color: var(--bs-success, #28a745) !important;
    }
    /* Estados active para botões de Redação Final */
    .badge.bg-success.badge-clickable:active,
    .badge.bg-success.badge-clickable:active * {
        background-color: var(--bs-success, #28a745) !important;
        color: #fff !important;
        border-color: var(--bs-success, #28a745) !important;
    }
    /* Estado focus para botões de Redação Final - garantir legibilidade */
    .badge.bg-success.badge-clickable:focus,
    .badge.bg-success.badge-clickable:focus-visible,
    .badge.bg-success.badge-clickable:focus *,
    .badge.bg-success.badge-clickable:focus-visible * {
        background-color: var(--bs-success, #28a745) !important;
        color: #fff !important;
        border-color: var(--bs-success, #28a745) !important;
        outline: 2px solid var(--bs-success, #28a745) !important;
        outline-offset: 2px !important;
    }
    /* Visited mantém estado normal a menos que esteja em hover ou focus */
    .badge.bg-success.badge-clickable:visited:not(:hover):not(:focus):not(:focus-visible),
    .badge.bg-success.badge-clickable:visited:not(:hover):not(:focus):not(:focus-visible) * {
        background-color: rgba(40, 167, 69, 0.1) !important;
        color: var(--bs-success, #28a745) !important;
        border-color: rgba(40, 167, 69, 0.25) !important;
    }
    /* Hover para badge de Pasta Digital - texto preto */
    .badge.bg-warning.badge-clickable:hover,
    .badge.bg-warning.badge-clickable:hover * {
        background-color: var(--bs-warning, #ffc107) !important;
        color: #000 !important;
        border-color: var(--bs-warning, #ffc107) !important;
    }
    /* Estado focus para badge de Pasta Digital - garantir legibilidade */
    .badge.bg-warning.badge-clickable:focus,
    .badge.bg-warning.badge-clickable:focus-visible,
    .badge.bg-warning.badge-clickable:focus *,
    .badge.bg-warning.badge-clickable:focus-visible * {
        background-color: var(--bs-warning, #ffc107) !important;
        color: #000 !important;
        border-color: var(--bs-warning, #ffc107) !important;
        outline: 2px solid var(--bs-warning, #ffc107) !important;
        outline-offset: 2px !important;
    }
    /* Quando focus e hover juntos, manter texto preto */
    .badge.bg-warning.badge-clickable:focus:hover,
    .badge.bg-warning.badge-clickable:focus-visible:hover,
    .badge.bg-warning.badge-clickable:focus:hover *,
    .badge.bg-warning.badge-clickable:focus-visible:hover * {
        background-color: var(--bs-warning, #ffc107) !important;
        color: #000 !important;
        border-color: var(--bs-warning, #ffc107) !important;
    }
    /* Estados active para badge de Pasta Digital */
    .badge.bg-warning.badge-clickable:active,
    .badge.bg-warning.badge-clickable:active * {
        background-color: var(--bs-warning, #ffc107) !important;
        color: #000 !important;
        border-color: var(--bs-warning, #ffc107) !important;
    }
    /* Visited mantém estado normal a menos que esteja em hover ou focus */
    .badge.bg-warning.badge-clickable:visited:not(:hover):not(:focus):not(:focus-visible),
    .badge.bg-warning.badge-clickable:visited:not(:hover):not(:focus):not(:focus-visible) * {
        background-color: rgba(255, 193, 7, 0.1) !important;
        color: #856404 !important;
        border-color: rgba(255, 193, 7, 0.25) !important;
    }
    
    /* 12. Card title link - indicar que é clicável */
    .card-title-link {
        transition: color 0.2s ease;
        cursor: pointer;
    }
    .card-title-link:hover {
        color: var(--bs-primary, #44a2d2) !important; /* Cor primária do tema */
    }
    .card-title-link:focus {
        outline: 2px solid var(--bs-primary, #44a2d2); /* Cor primária do tema */
        outline-offset: 2px;
        border-radius: 0.25rem;
    }
    .card-title-link .fa-external-link-alt {
        opacity: 0.5;
        transition: opacity 0.2s ease;
        font-size: 0.85em;
    }
    .card-title-link:hover .fa-external-link-alt {
        opacity: 1;
    }
    
    /* 12. Card header com badge - padding condicional */
    .card-header-with-badge {
        padding-right: 6rem;
    }
    
    /* 13. Skeleton title - para loading */
    .skeleton-title {
        height: 20px;
        width: 200px;
        margin-bottom: 15px;
    }
    
    /* 14. Canvas container - max width e centralizado */
    .canvas-container {
        max-width: 800px;
        margin: 0 auto;
    }
    /* Container específico para gráfico por tipo - mesma aparência do gráfico por autor */
    #resumo-estatistico .canvas-container {
        min-height: 300px; /* Altura mínima - será ajustada dinamicamente pelo JS */
        max-height: 450px; /* Altura máxima para evitar gráficos muito altos */
        height: auto;
        overflow: visible !important; /* Permitir que os labels saiam do container */
        max-width: none !important; /* Remover limitação de largura máxima */
        width: 100% !important; /* Garantir que use toda a largura disponível */
        padding-right: 80px !important; /* Padding extra maior à direita para os labels de até 4 dígitos */
    }
    #resumo-estatistico {
        overflow: visible !important; /* Permitir que os labels saiam do container */
        width: 100% !important; /* Garantir que use toda a largura disponível */
        padding-right: 0 !important; /* Remover padding padrão que possa limitar */
    }
    #resumo-estatistico canvas {
        max-width: none !important; /* Remover limitação de largura máxima do canvas */
        width: 100% !important; /* Garantir que use toda a largura disponível */
    }
    /* Container específico para gráfico por autor - precisa de mais altura */
    #resumo-estatistico-autor .canvas-container {
        min-height: 800px;
        height: auto;
        overflow: visible !important; /* Permitir que os labels saiam do container */
        max-width: none !important; /* Remover limitação de largura máxima */
        width: 100% !important; /* Garantir que use toda a largura disponível */
        padding-right: 80px !important; /* Padding extra maior à direita para os labels de até 4 dígitos */
    }
    #resumo-estatistico-autor {
        overflow: visible !important; /* Permitir que os labels saiam do container */
        width: 100% !important; /* Garantir que use toda a largura disponível */
        padding-right: 0 !important; /* Remover padding padrão que possa limitar */
    }
    #resumo-estatistico-autor canvas {
        max-width: none !important; /* Remover limitação de largura máxima do canvas */
        width: 100% !important; /* Garantir que use toda a largura disponível */
    }
    /* Container específico para gráfico por assunto */
    #resumo-estatistico-assunto .canvas-container {
        min-height: 400px;
        height: auto;
        overflow: visible !important; /* Permitir que os labels saiam do container */
        max-width: none !important; /* Remover limitação de largura máxima */
        width: 100% !important; /* Garantir que use toda a largura disponível */
        padding-right: 80px !important; /* Padding extra maior à direita para os labels de até 4 dígitos */
    }
    #resumo-estatistico-assunto {
        overflow: visible !important; /* Permitir que os labels saiam do container */
        width: 100% !important; /* Garantir que use toda a largura disponível */
        padding-right: 0 !important; /* Remover padding padrão que possa limitar */
    }
    #resumo-estatistico-assunto canvas {
        max-width: none !important; /* Remover limitação de largura máxima do canvas */
        width: 100% !important; /* Garantir que use toda a largura disponível */
    }
    
    /* 15. Input datepicker - garantir fundo branco */
    .flatpickr-input.bg-white {
        background-color: #fff !important;
    }
    
    /* 16. Skip links - acessibilidade */
    .skip-link {
        position: fixed;
        top: -100px;
        left: 0;
        background: var(--bs-primary, #44a2d2); /* Cor primária do tema */
        color: #fff;
        padding: 12px 20px;
        text-decoration: none;
        z-index: 9999;
        border-radius: 0 0 4px 4px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: top 0.2s ease-in-out;
    }
    .skip-link:focus {
        top: 0;
        outline: 3px solid var(--bs-warning, #ffc107);
        outline-offset: 2px;
    }
    
    /* 17. Focus visible - melhorar navegação por teclado */
    *:focus-visible {
        outline: 2px solid var(--bs-primary, #44a2d2); /* Cor primária do tema */
        outline-offset: 2px;
    }
    
    /* 18. Tabela responsiva - ocultar colunas em mobile */
    @media (max-width: 767px) {
        .table-responsive .d-none-mobile {
            display: none !important;
        }
    }
    /* 11. Timeline de Tramitação - componente específico (se usado) */
    .timeline {
        position: relative;
        padding-left: 1.875rem;
        border-left: 2px solid var(--bs-gray-300, #dee2e6);
    }
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
    }
    .timeline-dot {
        position: absolute;
        left: -2.5rem;
        top: 0.3rem;
        width: 1.125rem;
        height: 1.125rem;
        border-radius: 50%;
        background-color: var(--bs-gray-400, #ced4da);
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px var(--bs-gray-400, #ced4da);
    }
    .timeline-item.concluido .timeline-dot {
        background-color: var(--bs-success, #28a745);
        box-shadow: 0 0 0 2px var(--bs-success, #28a745);
    }
    .timeline-item.atual .timeline-dot {
        background-color: var(--bs-primary, #44a2d2); /* Cor primária do tema */
        box-shadow: 0 0 0 2px var(--bs-primary, #44a2d2); /* Cor primária do tema */
        transform: scale(1.2);
    }
    /* 12. TomSelect customizações - necessário para integração */
    .ts-wrapper.single .ts-control > input,
    .ts-wrapper.multi .ts-control > div {
        color: var(--bs-body-color, #495057);
    }
    .ts-control .item::placeholder {
        color: var(--bs-secondary, #6c757d);
        opacity: 1;
    }
    .ts-wrapper .ts-control {
        position: relative;
        padding-right: 2.2em;
    }
    .ts-wrapper .ts-control:after {
        position: absolute;
        right: 1em;
        top: 50%;
        width: 0;
        height: 0;
        pointer-events: none;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 6px solid var(--bs-gray-600, #6c757d);
        transform: translateY(-50%);
        opacity: 0.65;
    }
    .ts-wrapper.focus .ts-control:after {
        border-top-color: var(--bs-primary, #44a2d2); /* Cor primária do tema */
        opacity: 1;
    }
    
    /* 13. Animações - usar quando necessário */
    .fade-in {
        animation: fadeIn 0.5s;
    }
    .fade-out {
        animation: fadeOut 0.35s forwards;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    /* 14. Melhorias de acessibilidade e UX */
    #btn-toggle-filtros[style*="display: none"] {
        opacity: 0;
        transform: translateY(-10px);
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    /* 15. Filtros Avançados - usar classes Bootstrap quando possível */
    #advancedSearch h6 {
        font-size: 0.875rem; /* Aumentado de 0.75rem para melhor legibilidade */
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    /* 17. Melhorar contraste de textos de ajuda para acessibilidade */
    .form-text.text-muted {
        color: var(--bs-gray-700, #495057) !important; /* Melhor contraste que text-muted padrão */
    }
    
    /* 16. Responsividade - usar classes Bootstrap quando possível */
    @media (max-width: 768px) {
        #advancedSearch .card-body {
            padding: 1rem !important;
        }
    }
    
    /* 17. Focus visible - melhorar navegação por teclado */
    *:focus-visible {
        outline: 2px solid var(--bs-primary, #44a2d2); /* Cor primária do tema */
        outline-offset: 2px;
    }
    
    /* 18. Skip links - acessibilidade */
    .skip-link {
        position: fixed;
        top: -100px;
        left: 0;
        background: var(--bs-primary, #44a2d2); /* Cor primária do tema */
        color: #fff;
        padding: 12px 20px;
        text-decoration: none;
        z-index: 9999;
        border-radius: 0 0 4px 4px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: top 0.2s ease-in-out;
    }
    .skip-link:focus {
        top: 0;
        outline: 3px solid var(--bs-warning, #ffc107);
        outline-offset: 2px;
    }
    
</style>

<!-- Skip Links para Acessibilidade -->
<a href="#form-pesquisa" class="skip-link">Pular para filtros de pesquisa</a>
<a href="#container-principal-resultados" class="skip-link">Pular para resultados</a>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"><!-- z-index necessário para sobrepor modais -->
    <div class="toast" id="filter-cleared-toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fa fa-info-circle text-info me-2"></i>
            <strong class="me-auto">Informação</strong>
            <small>Agora</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fechar"></button>
        </div>
        <div class="toast-body">
            Filtros limpos com sucesso!
        </div>
    </div>
</div>

<div class="row mb-2">
      <div class="col-12 col-md-8 align-self-center">
        <h1 class="firstHeading font-size-18">Pesquisa de Matérias Legislativas</h1>
      </div>
      <div class="col-12 col-md-4 text-start text-md-end">
         <dtml-if expr="AUTHENTICATED_USER.has_role(['Operador', 'Operador Materia'])">      
             <a class="btn btn-primary d-print-none" href="<dtml-var portal_url>/cadastros/materia/materia_form_resumido"><i class="fa fa-fw fa-plus"></i> Incluir Matéria</a>
         </dtml-if>
      </div>
 </div>

<div class="d-grid gap-2 mb-3">
    <button class="btn btn-outline-primary" type="button" id="btn-toggle-filtros" data-bs-toggle="collapse" data-bs-target="#filtro-container" aria-expanded="false">
        <i class="fa fa-filter me-2"></i> Mostrar / Editar Filtros
    </button>
</div>

<main id="main-content">
<form method="get" action="&dtml-URL0;/materias_legislativas_json" id="form-pesquisa" role="search" aria-label="Formulário de pesquisa de matérias legislativas">
    <input type="hidden" name="formato" value="" id="formato">
    <input type="hidden" name="pagina" value="1" id="pagina">
    <input type="hidden" name="ordem_campo" value="" id="ordem_campo">
    <input type="hidden" name="ordem_direcao" value="" id="ordem_direcao">

    <div class="collapse show" id="filtro-container">
        <div class="card mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-filter text-primary me-2"></i>Filtros Básicos
                </h5>
            </div>
            <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="tip_id_basica" class="form-label form-label-sm mb-1 fw-semibold">
                        <i class="fas fa-file-alt text-muted me-1"></i>Tipo de Matéria:
                    </label>
                    <select name="tip_id_basica" id="tip_id_basica" class="form-select" multiple 
                       placeholder="Selecione um ou mais tipos..." data-tomselect aria-label="Selecione tipo de matéria">
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="num_ident_basica" class="form-label form-label-sm mb-1 fw-semibold">
                        <i class="fas fa-hashtag text-muted me-1"></i>Número:
                    </label>
                    <input type="text" name="num_ident_basica" id="num_ident_basica" 
                           class="form-control" 
                           placeholder="Ex: 123"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           aria-describedby="num_ident_basica_feedback">
                    <div class="invalid-feedback" id="num_ident_basica_feedback">
                        Por favor, insira apenas números.
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="ano_ident_basica" class="form-label form-label-sm mb-1 fw-semibold">
                        <i class="fas fa-calendar text-muted me-1"></i>Ano:
                    </label>
                    <input type="text" name="ano_ident_basica" id="ano_ident_basica" 
                           class="form-control" 
                           placeholder="Ex: 2025"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           maxlength="4"
                           aria-describedby="ano_ident_basica_feedback">
                    <div class="invalid-feedback" id="ano_ident_basica_feedback">
                        Por favor, insira um ano válido com 4 dígitos.
                    </div>
                </div>
            </div>
            <div class="row g-3 mt-0">
                <div class="col-md-6">
                    <label for="cod_autor" class="form-label form-label-sm mb-1 fw-semibold">
                        <i class="fas fa-user-edit text-muted me-1"></i>Autoria:
                    </label>
                    <select name="cod_autor" id="cod_autor" 
                            class="form-select" 
                            placeholder="Selecione um autor..."
                            aria-label="Selecione autor"></select>
                    <div class="d-flex gap-3 mt-2">
                        <div class="form-check form-check-sm">
                            <input class="form-check-input" type="checkbox" name="chk_primeiro_autor" id="chk_primeiro_autor" value="1">
                            <label class="form-check-label" for="chk_primeiro_autor">
                                Apenas como 1º autor
                            </label>
                        </div>
                        <div class="form-check form-check-sm">
                            <input class="form-check-input" type="checkbox" name="chk_coautor" id="chk_coautor" value="1">
                            <label class="form-check-label" for="chk_coautor">
                                Apenas como coautor
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="des_assunto" class="form-label form-label-sm mb-1 fw-semibold">
                        <i class="fas fa-search text-muted me-1"></i>Assunto ou Ementa:
                    </label>
                    <input type="text" name="des_assunto" id="des_assunto" 
                           class="form-control" 
                           placeholder="Digite palavras-chave para buscar..."
                           aria-describedby="des_assunto_feedback">
                    <small id="des_assunto_feedback" class="form-text text-muted d-none" role="status" aria-live="polite">
                        <i class="fa fa-spinner fa-spin me-1"></i> Buscando...
                    </small>
                    <div class="form-check form-switch mt-2">
                        <input type="checkbox" class="form-check-input" name="chk_textual" id="chk_textual" value="1">
                        <label class="form-check-label" for="chk_textual">
                            <i class="fas fa-file-alt text-muted me-1"></i>Pesquisar nos Textos Integrais
                        </label>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <button type="button" 
                        class="btn btn-link py-2 text-decoration-none d-flex align-items-center" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#advancedSearch" 
                        aria-expanded="false" 
                        aria-controls="advancedSearch"
                        aria-label="Expandir filtros avançados">
                    <i class="fas fa-chevron-right filter-toggle-icon me-2"></i>
                    <span class="fw-semibold">Filtros Avançados</span>
                    <span id="badge-filtros" 
                          class="badge bg-secondary ms-2"
                          data-bs-toggle="tooltip" 
                          data-bs-placement="top" 
                          title="Nenhum filtro ativo"
                          aria-label="Filtros ativos">
                        0
                    </span>
                </button>
            </div>
        </div>

        <div id="advancedSearch" class="collapse">
            <div class="card mt-3 border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 fw-semibold">
                        <i class="fas fa-sliders-h text-primary me-2"></i>Filtros Avançados
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Seção: Identificação -->
                    <div class="mb-4">
                        <h6 class="text-muted text-uppercase small mb-3 fw-semibold border-bottom pb-2">
                            <i class="fas fa-hashtag me-2"></i>Identificação
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="num_protocolo" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-file-alt text-muted me-1"></i>Número do Protocolo
                                </label>
                                <input type="text" 
                                       name="num_protocolo" 
                                       id="num_protocolo" 
                                       class="form-control" 
                                       placeholder="Ex: 123"
                                       aria-label="Número do protocolo de entrada da matéria"
                                       aria-describedby="num_protocolo_help">
                                <small id="num_protocolo_help" class="form-text text-muted">
                                    Número do protocolo de entrada da matéria no sistema
                                </small>
                            </div>
                            <div class="col-md-4">
                                <label for="num_processo" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-gavel text-muted me-1"></i>Número do Processo
                                </label>
                                <input type="text" 
                                       name="num_processo" 
                                       id="num_processo" 
                                       class="form-control" 
                                       placeholder="Ex: 456"
                                       aria-label="Número do processo administrativo da matéria"
                                       aria-describedby="num_processo_help">
                                <small id="num_processo_help" class="form-text text-muted">
                                    Número do processo administrativo relacionado à matéria
                                </small>
                            </div>
                            <div class="col-md-4">
                                <label for="ind_tramitacao" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-exchange-alt text-muted me-1"></i>Em Tramitação?
                                </label>
                                <select name="ind_tramitacao" id="ind_tramitacao" class="form-select">
                                    <option value="" selected>Tanto faz</option>
                                    <option value="1">Sim</option>
                                    <option value="0">Não</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Seção: Datas -->
                    <div class="mb-4">
                        <h6 class="text-muted text-uppercase small mb-3 fw-semibold border-bottom pb-2">
                            <i class="fas fa-calendar-alt me-2"></i>Datas
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="daterange_input" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="far fa-calendar text-muted me-1"></i>Data de Apresentação
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="text" 
                                           id="daterange_input" 
                                           class="form-control bg-white" 
                                           placeholder="Selecione um período..." 
                                           aria-label="Período de data de apresentação da matéria"
                                           aria-describedby="daterange_input_help">
                                    <small id="daterange_input_help" class="form-text text-muted d-block mt-1">Formato: DD/MM/AAAA - DD/MM/AAAA</small>
                                </div>
                                <div class="btn-group btn-group-sm w-100 mt-2" role="group" id="date-presets">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="hoje">Hoje</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="semana">7 dias</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="mes_atual">Este Mês</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="mes_passado">Mês Passado</button>
                                </div>
                                <input type="hidden" name="dat_apresentacao" id="dat_apresentacao_hidden">
                                <input type="hidden" name="dat_apresentacao2" id="dat_apresentacao2_hidden">
                            </div>
                            <div class="col-md-6">
                                <label for="daterange_publicacao" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="far fa-newspaper text-muted me-1"></i>Data de Publicação
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="text" 
                                           id="daterange_publicacao" 
                                           class="form-control bg-white" 
                                           placeholder="Selecione um período..." 
                                           aria-label="Período de data de publicação da matéria"
                                           aria-describedby="daterange_publicacao_help">
                                    <small id="daterange_publicacao_help" class="form-text text-muted d-block mt-1">Formato: DD/MM/AAAA - DD/MM/AAAA</small>
                                </div>
                                <div class="btn-group btn-group-sm w-100 mt-2" role="group" id="date-presets-publicacao">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="hoje">Hoje</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="semana">7 dias</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="mes_atual">Este Mês</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="mes_passado">Mês Passado</button>
                                </div>
                                <input type="hidden" name="dat_publicacao" id="dat_publicacao_hidden">
                                <input type="hidden" name="dat_publicacao2" id="dat_publicacao2_hidden">
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Seção: Tramitação -->
                    <div class="mb-4">
                        <h6 class="text-muted text-uppercase small mb-3 fw-semibold border-bottom pb-2">
                            <i class="fas fa-sitemap me-2"></i>Tramitação
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="cod_status" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-info-circle text-muted me-1"></i>Situação Atual
                                </label>
                                <select name="cod_status" id="cod_status" 
                                        class="form-select" 
                                        placeholder="Selecione uma situação..."
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="Filtrar por situação atual da tramitação">
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="cod_unid_tramitacao" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-map-marker-alt text-muted me-1"></i>Localização Atual
                                </label>
                                <select name="cod_unid_tramitacao" id="cod_unid_tramitacao" 
                                        class="form-select" 
                                        placeholder="Selecione uma unidade..."
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="Filtrar por unidade onde a matéria está atualmente">
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="cod_unid_tramitacao2" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-route text-muted me-1"></i>Tramitou Em
                                </label>
                                <select name="cod_unid_tramitacao2" id="cod_unid_tramitacao2" 
                                        class="form-select" 
                                        placeholder="Selecione onde tramitou..."
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="Filtrar por unidades onde a matéria já tramitou">
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Seção: Classificação -->
                    <div class="mb-4">
                        <h6 class="text-muted text-uppercase small mb-3 fw-semibold border-bottom pb-2">
                            <i class="fas fa-tags me-2"></i>Classificação
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="lst_assunto_materia" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-tag text-muted me-1"></i>Assunto / Classificação
                                </label>
                                <select name="lst_assunto_materia" id="lst_assunto_materia" class="form-select" placeholder="Selecione um assunto..." aria-label="Selecione um assunto"></select>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Seção: Autoria e Relatoria -->
                    <div class="mb-3">
                        <h6 class="text-muted text-uppercase small mb-3 fw-semibold border-bottom pb-2">
                            <i class="fas fa-users me-2"></i>Autoria e Relatoria
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="tip_autor" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-user-tag text-muted me-1"></i>Tipo de Autor
                                </label>
                                <select name="tip_autor" id="tip_autor" class="form-select" placeholder="Selecione um tipo..."></select>
                            </div>
                            <div class="col-md-4">
                                <label for="cod_relator" class="form-label form-label-sm mb-1 fw-semibold">
                                    <i class="fas fa-user-check text-muted me-1"></i>Relator
                                </label>
                                <select name="cod_relator" id="cod_relator" class="form-select" placeholder="Selecione um relator..."></select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4 align-items-center">
            <div class="col-md-6">
                <label class="form-label mb-2 fw-semibold">
                    <i class="fas fa-sort text-muted me-1"></i>Ordenação Padrão:
                </label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="rd_ordem" id="rd_ordem_1" value="1" checked>
                    <label class="form-check-label" for="rd_ordem_1">Mais Recentes Primeiro</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="rd_ordem" id="rd_ordem_0" value="0">
                    <label class="form-check-label" for="rd_ordem_0">Mais Antigos Primeiro</label>
                </div>
            </div>
            <div class="col-md-6 text-center text-md-end mt-3 mt-md-0">
                <button type="submit" 
                        class="btn btn-primary" 
                        id="btn-pesquisar"
                        aria-label="Pesquisar matérias legislativas">
                    <i class="fa fa-search me-1"></i> Pesquisar
                </button>
                <button type="button" 
                        class="btn btn-outline-primary ms-2 d-none" 
                        id="btn-limpar" 
                        aria-label="Limpar filtros de pesquisa">
                    <i class="fa fa-times me-1"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</form>
</main>

<div id="resumo-filtros" class="mt-3" role="status" aria-live="polite"></div>

<div id="container-principal-resultados" class="mt-4 d-none">
    <ul class="nav nav-tabs" id="resultado-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="lista-tab" data-bs-toggle="tab" data-bs-target="#resultados-pane" type="button" role="tab" aria-controls="resultados-pane" aria-selected="true">
                <i class="fa fa-list me-2"></i>Resultados
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="grafico-tab" data-bs-toggle="tab" data-bs-target="#grafico-pane" type="button" role="tab" aria-controls="grafico-pane" aria-selected="false">
                <i class="fa fa-chart-bar me-2"></i>Resumo por Tipo
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="grafico-autor-tab" data-bs-toggle="tab" data-bs-target="#grafico-autor-pane" type="button" role="tab" aria-controls="grafico-autor-pane" aria-selected="false">
                <i class="fa fa-users me-2"></i>Resumo por Autor
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="grafico-assunto-tab" data-bs-toggle="tab" data-bs-target="#grafico-assunto-pane" type="button" role="tab" aria-controls="grafico-assunto-pane" aria-selected="false">
                <i class="fa fa-tags me-2"></i>Resumo por Assunto
            </button>
        </li>
    </ul>
    <div class="tab-content" id="resultado-tabs-content">
        <div class="tab-pane fade show active" id="resultados-pane" role="tabpanel" aria-labelledby="lista-tab">
            <div id="resultados" class="pt-3" aria-live="polite"></div>
        </div>
        <div class="tab-pane fade" id="grafico-pane" role="tabpanel" aria-labelledby="grafico-tab">
            <div id="resumo-estatistico" class="p-3">
                <div class="d-flex justify-content-end mb-2">
                    <div class="btn-group" role="group" aria-label="Tipo de gráfico">
                        <button type="button" class="btn btn-sm btn-outline-primary active" id="btn-grafico-barra-tipo" data-tipo="bar">
                            <i class="fa fa-chart-bar me-1"></i>Barra
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-grafico-pizza-tipo" data-tipo="pie">
                            <i class="fa fa-chart-pie me-1"></i>Pizza
                        </button>
                    </div>
                </div>
                 <div class="canvas-container">
                    <canvas id="stats-chart" aria-label="Gráfico de resumo estatístico das matérias"></canvas>
                 </div>
            </div>
        </div>
        <div class="tab-pane fade" id="grafico-autor-pane" role="tabpanel" aria-labelledby="grafico-autor-tab">
            <div id="resumo-estatistico-autor" class="p-3">
                 <div class="canvas-container">
                    <canvas id="stats-chart-autor" aria-label="Gráfico de resumo estatístico por autor"></canvas>
                 </div>
            </div>
        </div>
        <div class="tab-pane fade" id="grafico-assunto-pane" role="tabpanel" aria-labelledby="grafico-assunto-tab">
            <div id="resumo-estatistico-assunto" class="p-3">
                <div class="d-flex justify-content-end mb-2">
                    <div class="btn-group" role="group" aria-label="Tipo de gráfico">
                        <button type="button" class="btn btn-sm btn-outline-primary active" id="btn-grafico-barra-assunto" data-tipo="bar">
                            <i class="fa fa-chart-bar me-1"></i>Barra
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-grafico-pizza-assunto" data-tipo="pie">
                            <i class="fa fa-chart-pie me-1"></i>Pizza
                        </button>
                    </div>
                </div>
                 <div class="canvas-container">
                    <canvas id="stats-chart-assunto" aria-label="Gráfico de resumo estatístico por assunto"></canvas>
                 </div>
            </div>
        </div>
    </div>
</div>

<div id="painel-sem-resultados" class="mt-4"></div>

<div class="modal fade" id="modalDocumentos" tabindex="-1" aria-labelledby="modalDocumentosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDocumentosLabel">Documentos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalDocumentosBody">
                <!-- Conteúdo carregado via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<dtml-var js_slot>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Elementos principais
    const form = document.getElementById('form-pesquisa');
    const pesquisarBtn = document.getElementById('btn-pesquisar');
    const limparBtn = document.getElementById('btn-limpar');
    const resumoFiltrosDiv = document.getElementById('resumo-filtros');
    const advancedSearchDiv = document.getElementById('advancedSearch');
    const ordemCampoInput = document.getElementById('ordem_campo');
    const ordemDirecaoInput = document.getElementById('ordem_direcao');
    
    // Variável para tipo de gráfico por tipo
    let tipoGraficoTipo = 'bar'; // 'bar' ou 'pie' - tipo de gráfico por tipo
    const desAssuntoInput = document.getElementById('des_assunto');
    const badgeFiltros = document.getElementById('badge-filtros');
    const filterClearedToastEl = document.getElementById('filter-cleared-toast');
    const numIdentBasicaInput = document.getElementById('num_ident_basica');
    const anoIdentBasicaInput = document.getElementById('ano_ident_basica');
    const resultadosDiv = document.getElementById('resultados');
    const painelSemResultados = document.getElementById('painel-sem-resultados');
    const containerPrincipal = document.getElementById('container-principal-resultados');

    // Exclusão mútua entre checkboxes de coautor e primeiro autor
    const chkCoautor = document.getElementById('chk_coautor');
    const chkPrimeiroAutor = document.getElementById('chk_primeiro_autor');
    if (chkCoautor && chkPrimeiroAutor) {
        chkCoautor.addEventListener('change', function() {
            if (this.checked) {
                chkPrimeiroAutor.checked = false;
            }
        });
        chkPrimeiroAutor.addEventListener('change', function() {
            if (this.checked) {
                chkCoautor.checked = false;
            }
        });
    }
    
    // Variáveis de estado
    let advancedFiltersLoaded = false;
    let itensPorPaginaSelect = null;
    let currentViewMode = localStorage.getItem('materiaViewMode') || 'cards';
    // Expor no window para debug
    window.statsChartInstance = null;
    window.statsChartAutorInstance = null;
    window.statsChartAssuntoInstance = null;
    let tipoGraficoAssunto = 'bar'; // 'bar' ou 'pie' - tipo de gráfico por assunto
    let graficoEventListenersAdicionados = false; // Flag para evitar adicionar listeners múltiplas vezes
    let carregandoEstatisticas = false; // Flag para evitar múltiplas chamadas simultâneas
    let bsCollapseFiltros = null;
    let filterClearedToast = null;
    const apiCache = new Map();
    let ultimoResultadoMaterias = null;

    let bsCollapseAdvancedSearch = null;
    if (document.getElementById('filtro-container')) {
        bsCollapseFiltros = new bootstrap.Collapse(document.getElementById('filtro-container'), { toggle: false });
    }
    if (advancedSearchDiv) {
        bsCollapseAdvancedSearch = new bootstrap.Collapse(advancedSearchDiv, { toggle: false });
    }

    // Inicializações
    if (document.getElementById('filtro-container')) {
        bsCollapseFiltros = new bootstrap.Collapse(document.getElementById('filtro-container'), { toggle: false });
    }
    pesquisarBtn.setAttribute('aria-label', 'Pesquisar matérias legislativas');
    limparBtn.setAttribute('aria-label', 'Limpar filtros de pesquisa');

    // Date Range Picker - Data de Apresentação
    const daterangePicker = flatpickr('#daterange_input', {
        mode: 'range',
        dateFormat: "d/m/Y",
        locale: 'pt',
        onClose: function(selectedDates) {
            const dataInicioHidden = document.getElementById('dat_apresentacao_hidden');
            const dataFimHidden = document.getElementById('dat_apresentacao2_hidden');
            if (selectedDates.length === 2) {
                dataInicioHidden.value = flatpickr.formatDate(selectedDates[0], "d/m/Y");
                dataFimHidden.value = flatpickr.formatDate(selectedDates[1], "d/m/Y");
            } else {
                dataInicioHidden.value = '';
                dataFimHidden.value = '';
            }
            dataInicioHidden.dispatchEvent(new Event('change'));
        }
    });
    
    // Date Range Picker - Data de Publicação (NOVO)
    const daterangePublicacaoPicker = flatpickr('#daterange_publicacao', {
        mode: 'range',
        dateFormat: "d/m/Y",
        locale: 'pt',
        onClose: function(selectedDates) {
            const dataInicioHidden = document.getElementById('dat_publicacao_hidden');
            const dataFimHidden = document.getElementById('dat_publicacao2_hidden');
            if (selectedDates.length === 2) {
                dataInicioHidden.value = flatpickr.formatDate(selectedDates[0], "d/m/Y");
                dataFimHidden.value = flatpickr.formatDate(selectedDates[1], "d/m/Y");
            } else {
                dataInicioHidden.value = '';
                dataFimHidden.value = '';
            }
            dataInicioHidden.dispatchEvent(new Event('change'));
        }
    });

    // Event Listeners usando delegação
    document.body.addEventListener('click', function(e) {
        if (e.target.closest('#btn-view-table')) applyViewMode('table');
        if (e.target.closest('#btn-view-cards')) applyViewMode('cards');
        if (e.target.closest('.btn-export')) {
            e.preventDefault();
            handleExportClick(e.target.closest('.btn-export'));
        }
        if (e.target.closest('.badge-documento')) {
            e.preventDefault();
            handleDocumentoClick(e.target.closest('.badge-documento'));
        }
        if (e.target === limparBtn) handleLimparClick();
        if (e.target.closest('.filter-badge .btn-close')) handleRemoveFilter(e);
        if (e.target.closest('[data-preset]')) handleDatePreset(e.target.closest('[data-preset]'));
        if (e.target.closest('#btn-limpar-filtros-no-results')) handleLimparClick();
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        realizarBusca(1);
    });

    if (filterClearedToastEl) {
        filterClearedToast = new bootstrap.Toast(filterClearedToastEl, { delay: 3000 });
    }

    async function fetchWithCache(url) {
        if (apiCache.has(url)) return apiCache.get(url);
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Erro na resposta do servidor');
            const data = await response.json();
            apiCache.set(url, data);
            return data;
        } catch (error) {
            console.error('Erro na requisição:', error);
            throw error;
        }
    }

    function validarFormulario() {
        let isValid = true;
        numIdentBasicaInput.classList.remove('is-invalid');
        numIdentBasicaInput.setAttribute('aria-invalid', 'false');
        anoIdentBasicaInput.classList.remove('is-invalid');
        anoIdentBasicaInput.setAttribute('aria-invalid', 'false');
        if (anoIdentBasicaInput.value && !/^\d{4}$/.test(anoIdentBasicaInput.value)) {
            anoIdentBasicaInput.classList.add('is-invalid');
            anoIdentBasicaInput.setAttribute('aria-invalid', 'true');
            isValid = false;
        }
        if (numIdentBasicaInput.value && !/^\d+$/.test(numIdentBasicaInput.value)) {
            numIdentBasicaInput.classList.add('is-invalid');
            numIdentBasicaInput.setAttribute('aria-invalid', 'true');
            isValid = false;
        }
        return isValid;
    }

    function haFiltrosAtivos() {
        const formData = new FormData(form);
        const ignorar = ['formato', 'rd_ordem', 'pagina', 'ordem_campo', 'ordem_direcao', 'itens_por_pagina'];
        for (let [k, v] of formData.entries()) {
            if (ignorar.includes(k)) continue;
            if (v && v !== '' && !(k === 'chk_textual' && v === '0')) return true;
        }
        return false;
    }
    if (!haFiltrosAtivos()) {
        const btnToggleFiltros = document.getElementById('btn-toggle-filtros');
        if (btnToggleFiltros) {
            btnToggleFiltros.classList.add('d-none');
        }
    }

    function showSkeletonLoading() {
        resultadosDiv.innerHTML = `
            <div class="skeleton-loading skeleton-title"></div>
            <div class="table-responsive">
                <table class="table" aria-label="Carregando resultados">
                    <thead><tr><th class="w-15"></th><th class="w-10"></th><th class="w-20"></th><th class="w-35"></th><th class="w-10"></th><th class="w-10"></th></tr></thead>
                    <tbody>
                        ${Array(5).fill('<tr>'+Array(6).fill('<td><div class="skeleton-loading skeleton-row"></div></td>').join('')+'</tr>').join('')}
                    </tbody>
                </table>
            </div>`;
        resultadosDiv.setAttribute('aria-busy', 'true');
    }

    function showInitialMessage() {
        const btnToggleFiltros = document.getElementById('btn-toggle-filtros');
        if (btnToggleFiltros) {
            btnToggleFiltros.classList.add('d-none');
        }
        painelSemResultados.innerHTML = `
            <div class="alert alert-info text-center" role="status">
                <i class="fa fa-search fa-2x mb-2"></i><br>
                Utilize os filtros acima para encontrar as matérias legislativas.
            </div>`;
        painelSemResultados.classList.remove('d-none');
        painelSemResultados.classList.add('d-block');
    }

    function showNoResults() {
        containerPrincipal.classList.add('d-none');
        containerPrincipal.classList.remove('d-block');
        painelSemResultados.innerHTML = `
            <div class="text-center p-4 p-md-5 bg-light rounded border">
                <div class="mb-3"><i class="fa fa-search-minus fa-3x text-warning" aria-hidden="true"></i></div>
                <h4 class="fw-bold">Nenhum Registro Encontrado</h4>
                <p class="text-muted mb-4">Não encontramos matérias que correspondam aos filtros aplicados.</p>
                <div class="mt-4">
                    <button class="btn btn-primary btn-lg" id="btn-limpar-filtros-no-results" aria-label="Limpar filtros e tentar nova busca">
                        <i class="fa fa-times me-2"></i>Limpar Filtros e Tentar Novamente
                    </button>
                </div>
            </div>`;
        painelSemResultados.classList.remove('d-none');
        painelSemResultados.classList.add('d-block');
        renderStatsChart(null);
        renderStatsChartAutor(null);
    }

    function renderizarErro(mensagem) {
        painelSemResultados.innerHTML = `
            <div class="alert alert-danger text-center" role="alert">
                <i class="fa fa-exclamation-triangle"></i> ${sanitizeHTML(mensagem)}
            </div>`;
        painelSemResultados.classList.remove('d-none');
        painelSemResultados.classList.add('d-block');
    }

    async function realizarBusca(page = 1, itensPorPaginaParam = null) {
        if (!validarFormulario()) return;
        const itensPorPaginaAtual = itensPorPaginaParam || (itensPorPaginaSelect ? itensPorPaginaSelect.value : '12');
        document.getElementById('pagina').value = page;
        pesquisarBtn.disabled = true;
        pesquisarBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Buscando...';
        pesquisarBtn.setAttribute('aria-busy', 'true');
        
        // Mostrar indicador de busca no campo de assunto/ementa se houver valor
        const desAssuntoFeedback = document.getElementById('des_assunto_feedback');
        if (desAssuntoInput && desAssuntoInput.value.trim().length > 0 && desAssuntoFeedback) {
            desAssuntoFeedback.classList.remove('d-none');
            desAssuntoFeedback.classList.add('d-block');
        }
        
        showSkeletonLoading();
        try {
            const formData = new FormData(form);
            const params = new URLSearchParams();
            
            // Processar todos os campos do formulário, incluindo múltiplos valores
            for (const [key, value] of formData.entries()) {
                if (key === 'daterange_input') continue;
                // Para campos múltiplos (TomSelect), adicionar todos os valores
                if (key === 'tip_id_basica' || key === 'lst_assunto_materia') {
                    const selectElement = form.elements[key];
                    if (selectElement && selectElement.tomselect) {
                        const values = selectElement.tomselect.getValue();
                        if (Array.isArray(values) && values.length > 0) {
                            values.forEach(val => params.append(key, val));
                        } else if (values) {
                            params.append(key, values);
                        }
                    } else {
                        // Fallback: usar FormData se TomSelect não estiver disponível
                        params.append(key, value);
                    }
                } else {
                    params.append(key, value);
                }
            }
            
            params.set('pagina', page);
            params.set('itens_por_pagina', itensPorPaginaAtual);
            actualizarURL(params);
            mostrarResumoFiltros(new FormData(form));
            const response = await fetchWithCache(`materias_legislativas_json?${params.toString()}`);
            ultimoResultadoMaterias = response;
            renderizarResultados(response);
            limparBtn.classList.remove('d-none');
            limparBtn.classList.add('d-inline-block');
            if (bsCollapseFiltros) bsCollapseFiltros.hide();
        } catch (error) {
            console.error('Erro na busca:', error);
            renderizarErro(error.message || 'Ocorreu um erro ao buscar os dados.');
        } finally {
            pesquisarBtn.disabled = false;
            pesquisarBtn.innerHTML = '<i class="fa fa-search"></i> Pesquisar';
            pesquisarBtn.removeAttribute('aria-busy');
            resultadosDiv.removeAttribute('aria-busy');
            
            // Ocultar indicador de busca no campo de assunto/ementa
            const desAssuntoFeedback = document.getElementById('des_assunto_feedback');
            if (desAssuntoFeedback) {
                desAssuntoFeedback.classList.add('d-none');
                desAssuntoFeedback.classList.remove('d-block');
            }
        }
    }

    function renderizarResultados(data) {
        if (!data || data.total === 0) {
            showNoResults();
            return;
        }
        containerPrincipal.classList.remove('d-none');
        containerPrincipal.classList.add('d-block');
        painelSemResultados.classList.add('d-none');
        painelSemResultados.classList.remove('d-block');
        // Sempre mostrar as abas de gráficos (serão carregados sob demanda)
        // Renderizar gráficos apenas se os dados estiverem disponíveis
        // Se não estiverem, as abas ficarão visíveis mas sem dados até serem clicadas
        if (data.stats && Object.keys(data.stats).length > 0) {
            window.ultimoStatsData = data.stats; // Armazenar dados para alternância de gráfico
            renderStatsChart(data.stats);
        } else {
            // Manter aba visível, mas sem dados (será carregado ao clicar)
            const graficoTab = document.querySelector('#grafico-tab');
            if (graficoTab) {
                graficoTab.parentElement.classList.remove('d-none');
                graficoTab.parentElement.classList.add('d-block');
            }
            renderStatsChart(null);
        }
        if (data.stats_by_author && Object.keys(data.stats_by_author).length > 0) {
            renderStatsChartAutor(data.stats_by_author);
        } else {
            // Manter aba visível, mas sem dados (será carregado ao clicar)
            const graficoAutorTab = document.querySelector('#grafico-autor-tab');
            if (graficoAutorTab) {
                graficoAutorTab.parentElement.classList.remove('d-none');
                graficoAutorTab.parentElement.classList.add('d-block');
            }
            renderStatsChartAutor(null);
        }
        if (data.stats_by_assunto && Object.keys(data.stats_by_assunto).length > 0) {
            renderStatsChartAssunto(data.stats_by_assunto);
        } else {
            // Manter aba visível, mas sem dados (será carregado ao clicar)
            const graficoAssuntoTab = document.querySelector('#grafico-assunto-tab');
            if (graficoAssuntoTab) {
                graficoAssuntoTab.parentElement.classList.remove('d-none');
                graficoAssuntoTab.parentElement.classList.add('d-block');
            }
            renderStatsChartAssunto(null);
        }
        const btnToggleFiltros = document.getElementById('btn-toggle-filtros');
        if (btnToggleFiltros) {
            btnToggleFiltros.classList.remove('d-none');
            btnToggleFiltros.classList.add('d-block');
        }
        const { page: paginaAtual, per_page: itensPorPagina, total } = data;
        const inicioFaixa = (paginaAtual - 1) * itensPorPagina + 1;
        const fimFaixa = Math.min(paginaAtual * itensPorPagina, total);
        const termosBusca = desAssuntoInput.value;
        let html = `
            <div class="d-flex flex-column flex-md-row align-items-center mb-3">
                <div class="form-group mb-2 mb-md-0 me-md-3">
                    <label for="itens_por_pagina" class="me-2">Itens por página:</label>
                    <select class="form-select d-inline-block w-auto" id="itens_por_pagina">
                        <option value="12" ${itensPorPagina == 12 ? 'selected' : ''}>12</option>
                        <option value="24" ${itensPorPagina == 24 ? 'selected' : ''}>24</option>
                        <option value="36" ${itensPorPagina == 36 ? 'selected' : ''}>36</option>
                        <option value="48" ${itensPorPagina == 48 ? 'selected' : ''}>48</option>
                        <option value="60" ${itensPorPagina == 60 ? 'selected' : ''}>60</option>
                        <option value="72" ${itensPorPagina == 72 ? 'selected' : ''}>72</option>
                        <option value="84" ${itensPorPagina == 84 ? 'selected' : ''}>84</option>
                        <option value="96" ${itensPorPagina == 96 ? 'selected' : ''}>96</option>
                    </select>
                </div>
                <div class="btn-group btn-group-sm mb-2 mb-md-0">
                    <button type="button" class="btn btn-outline-primary" id="btn-view-table" title="Tabela">
                        <i class="fa fa-table"></i> Tabela
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn-view-cards" title="Cards">
                        <i class="fa fa-th-large"></i> Cards
                    </button>
                </div>
                <div class="btn-group btn-group-sm mb-2 mb-md-0 ms-md-3">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-download"></i> Exportar
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item btn-export" href="#" data-format="csv" data-paginar-exportacao="1">
                            <i class="fa fa-file-csv text-muted"></i> CSV (página atual)
                        </a></li>
                        <li><a class="dropdown-item btn-export" href="#" data-format="excel" data-paginar-exportacao="1">
                            <i class="fa fa-file-excel text-muted"></i> Excel (página atual)
                        </a></li>
                        <li><a class="dropdown-item btn-export" href="#" data-format="pdf" data-paginar-exportacao="1">
                            <i class="fa fa-file-pdf text-muted"></i> PDF (página atual)
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item btn-export" href="#" data-format="csv" data-paginar-exportacao="0">
                            <i class="fa fa-file-csv text-muted"></i> CSV (todas as páginas)
                        </a></li>
                        <li><a class="dropdown-item btn-export" href="#" data-format="excel" data-paginar-exportacao="0">
                            <i class="fa fa-file-excel text-muted"></i> Excel (todas as páginas)
                        </a></li>
                        <li><a class="dropdown-item btn-export" href="#" data-format="pdf" data-paginar-exportacao="0">
                            <i class="fa fa-file-pdf text-muted"></i> PDF (todas as páginas)
                        </a></li>
                    </ul>
                </div>
                <p role="status" class="text-center text-md-end mb-0 ms-md-auto">
                    Exibindo ${inicioFaixa}-${fimFaixa} de <strong>${total}</strong> registros.
                </p>
            </div>`;
        if (currentViewMode === 'table') html += renderTableView(data, termosBusca);
        else html += renderCardsView(data, termosBusca);
        html += renderizarPaginacao(data);
        resultadosDiv.innerHTML = html;
        document.getElementById('btn-view-table').classList.toggle('active', currentViewMode === 'table');
        document.getElementById('btn-view-cards').classList.toggle('active', currentViewMode === 'cards');
        
        // Re-inicializar tooltips após renderizar resultados
        const newTooltips = resultadosDiv.querySelectorAll('[data-bs-toggle="tooltip"]');
        newTooltips.forEach(function(el) {
            if (!bootstrap.Tooltip.getInstance(el)) {
                new bootstrap.Tooltip(el);
            }
        });
        
        // Re-adicionar acessibilidade aos badges
        adicionarAcessibilidadeBadges();
        
        // Resetar flag de estatísticas carregadas quando novos resultados são renderizados
        statsCarregadas = false;
        
        // Adicionar event listeners para as abas de gráficos apenas uma vez (carregamento sob demanda)
        if (!graficoEventListenersAdicionados) {
            const graficoTab = document.querySelector('#grafico-tab');
            const graficoAutorTab = document.querySelector('#grafico-autor-tab');
            if (graficoTab) {
                graficoTab.addEventListener('shown.bs.tab', function() {
                    if (!statsCarregadas && !carregandoEstatisticas) {
                        carregarEstatisticas();
                    }
                });
            }
            if (graficoAutorTab) {
                graficoAutorTab.addEventListener('shown.bs.tab', function() {
                    if (!statsCarregadas && !carregandoEstatisticas) {
                        carregarEstatisticas();
                    }
                });
            }
            const graficoAssuntoTab = document.querySelector('#grafico-assunto-tab');
            if (graficoAssuntoTab) {
                graficoAssuntoTab.addEventListener('shown.bs.tab', function() {
                    if (!statsCarregadas && !carregandoEstatisticas) {
                        carregarEstatisticas();
                    }
                });
            }
            graficoEventListenersAdicionados = true;
        }
        
        itensPorPaginaSelect = document.getElementById('itens_por_pagina');
        if (itensPorPaginaSelect) {
            itensPorPaginaSelect.addEventListener('change', (e) => {
                realizarBusca(1, e.target.value);
            });
        }
        const triggerEl = document.querySelector('#lista-tab');
        bootstrap.Tab.getInstance(triggerEl)?.show() || new bootstrap.Tab(triggerEl).show();
        if (bsCollapseFiltros && document.getElementById('filtro-container').classList.contains('show')) {
            bsCollapseFiltros.hide();
            document.getElementById('filtro-container').addEventListener('hidden.bs.collapse', function handler() {
                scrollParaResultados();
                this.removeEventListener('hidden.bs.collapse', handler);
            });
        } else {
            scrollParaResultados();
        }
    }

    function renderTableView(data, termosBusca) {
        let html = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="5%" scope="col">Status</th>
                            <th width="12%" scope="col" class="sortable-header${ordemCampoInput.value === 'des_tipo_materia' ? ' ' + ordemDirecaoInput.value : ''}" data-sort-field="des_tipo_materia" aria-sort="${ordemCampoInput.value === 'des_tipo_materia' ? (ordemDirecaoInput.value === 'asc' ? 'ascending' : 'descending') : 'none'}">Tipo</th>
                            <th width="10%" scope="col" class="sortable-header${ordemCampoInput.value === 'num_ident_basica' ? ' ' + ordemDirecaoInput.value : ''}" data-sort-field="num_ident_basica" aria-sort="${ordemCampoInput.value === 'num_ident_basica' ? (ordemDirecaoInput.value === 'asc' ? 'ascending' : 'descending') : 'none'}">Número/Ano</th>
                            <th scope="col" class="sortable-header${ordemCampoInput.value === 'txt_ementa' ? ' ' + ordemDirecaoInput.value : ''}" data-sort-field="txt_ementa" aria-sort="${ordemCampoInput.value === 'txt_ementa' ? (ordemDirecaoInput.value === 'asc' ? 'ascending' : 'descending') : 'none'}">Ementa</th>
                            <th width="12%" scope="col" class="sortable-header${ordemCampoInput.value === 'autores' ? ' ' + ordemDirecaoInput.value : ''}" data-sort-field="autores" aria-sort="${ordemCampoInput.value === 'autores' ? (ordemDirecaoInput.value === 'asc' ? 'ascending' : 'descending') : 'none'}">Autoria</th>
                            <th width="8%" scope="col" class="sortable-header${ordemCampoInput.value === 'dat_apresentacao' ? ' ' + ordemDirecaoInput.value : ''}" data-sort-field="dat_apresentacao" aria-sort="${ordemCampoInput.value === 'dat_apresentacao' ? (ordemDirecaoInput.value === 'asc' ? 'ascending' : 'descending') : 'none'}">Apresentação</th>
                            <th width="8%" scope="col">Regime</th>
                            <th width="15%" scope="col">Ações</th>
                        </tr>
                    </thead>
                    <tbody>`;
        data.data.forEach(materia => {
            const ementaDestacada = highlightText(sanitizeHTML(materia.txt_ementa || ''), termosBusca);
            const ementaCompleta = sanitizeHTML(materia.txt_ementa || '');
            let botoesDocumentos = '';
            // Para matérias principais: mostrar todos os badges disponíveis
            if (materia.tipo_item === 'principal' || !materia.tipo_item) {
                // Badge de Pasta Digital (apenas para matérias principais com texto integral e usuários autenticados) - DEVE VIR ANTES
                if (materia.url_pasta_digital) {
                    botoesDocumentos += `<a href="${materia.url_pasta_digital}" class="badge bg-warning bg-opacity-10 text-warning-emphasis border border-warning border-opacity-25 badge-clickable text-decoration-none me-1 mb-1 d-inline-block" target="_blank" title="Pasta Digital" data-bs-toggle="tooltip"><i class="far fa-folder-open me-1"></i>Pasta Digital</a>`;
                }
                // Texto Integral
                if (materia.url_texto_integral) {
                    botoesDocumentos += `<a href="${materia.url_texto_integral}" class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-clickable text-decoration-none me-1 mb-1 d-inline-block" target="_blank" title="Texto Integral" data-bs-toggle="tooltip"><i class="far fa-file-pdf me-1"></i>Texto Integral</a>`;
                }
                // Redação Final
                if (materia.url_redacao_final) {
                    botoesDocumentos += `<a href="${materia.url_redacao_final}" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 badge-clickable text-decoration-none me-1 mb-1 d-inline-block" target="_blank" title="Redação Final" data-bs-toggle="tooltip"><i class="fas fa-file-pdf me-1"></i>Redação Final</a>`;
                }
            } else if (materia.tipo_item === 'emenda' || materia.tipo_item === 'substitutivo') {
                // Para emendas e substitutivos: mostrar apenas Texto Integral
                if (materia.url_texto_integral) {
                    botoesDocumentos += `<a href="${materia.url_texto_integral}" class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-clickable text-decoration-none me-1 mb-1 d-inline-block" target="_blank" title="Texto Integral" data-bs-toggle="tooltip"><i class="far fa-file-pdf me-1"></i>Texto Integral</a>`;
                }
            } else {
                // Para outros tipos (acessoria_principal): mostrar Texto Integral e Redação Final se disponíveis
                if (materia.url_texto_integral) {
                    botoesDocumentos += `<a href="${materia.url_texto_integral}" class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-clickable text-decoration-none me-1 mb-1 d-inline-block" target="_blank" title="Texto Integral" data-bs-toggle="tooltip"><i class="far fa-file-pdf me-1"></i>Texto Integral</a>`;
                }
                if (materia.url_redacao_final) {
                    botoesDocumentos += `<a href="${materia.url_redacao_final}" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 badge-clickable text-decoration-none me-1 mb-1 d-inline-block" target="_blank" title="Redação Final" data-bs-toggle="tooltip"><i class="fas fa-file-pdf me-1"></i>Redação Final</a>`;
                }
            }
            html += `
                <tr>
                    <td class="text-center">
                        ${materia.ind_tramitacao == 1 ? 
                            '<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25" data-bs-toggle="tooltip" title="Em Tramitação"><i class="fa fa-check-circle"></i></span>' : 
                            '<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25" data-bs-toggle="tooltip" title="Arquivada"><i class="fa fa-archive"></i></span>'
                        }
                    </td>
                    <td class="text-body">
                        ${materia.tipo_item === 'acessoria_principal' ? '<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 me-1"><i class="fa fa-file me-1"></i>Acessória</span>' : ''}
                        ${sanitizeHTML(materia.des_tipo_materia || '')}
                    </td>
                    <td class="text-body">
                        ${(materia.tipo_item === 'principal' || !materia.tipo_item) ? 
                            // Para matérias principais: mostrar apenas número e ano (sem "nº" e sem repetir o tipo)
                            `<strong>${sanitizeHTML(materia.num_ident_basica)}/${sanitizeHTML(materia.ano_ident_basica)}</strong>` :
                            // Para emendas e substitutivos: mostrar identificação completa
                            `<strong>${materia.identificacao ? sanitizeHTML(materia.identificacao) : `${sanitizeHTML(materia.num_ident_basica)}/${sanitizeHTML(materia.ano_ident_basica)}`}</strong>`
                        }
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 300px;" title="${ementaCompleta}" data-bs-toggle="tooltip">
                            ${ementaDestacada || '<em class="text-secondary">Sem ementa</em>'}
                        </div>
                    </td>
                    <td class="d-none d-md-table-cell text-body">${materia.autores ? sanitizeHTML(materia.autores) : '<em class="text-secondary">Não informada</em>'}</td>
                    <td class="d-none d-sm-table-cell text-body">${sanitizeHTML(materia.dat_apresentacao || '')}</td>
                    <td>
                        ${(materia.tipo_item === 'principal' || !materia.tipo_item) ? 
                            (materia.des_regime_tramitacao ? 
                                `<span class="badge ${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25' : 'bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25'} me-1" data-bs-toggle="tooltip" title="${sanitizeHTML(materia.des_regime_tramitacao || '')}"><i class="fa fa-clock me-1"></i>${sanitizeHTML(materia.des_regime_tramitacao)}</span>` : 
                                '<span class="text-muted">-</span>'
                            ) :
                            (materia.des_regime_tramitacao ? 
                                `<span class="badge ${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25' : 'bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25'} me-1" data-bs-toggle="tooltip" title="${sanitizeHTML(materia.des_regime_tramitacao || '')}"><i class="fa fa-clock me-1"></i>${sanitizeHTML(materia.des_regime_tramitacao)}</span>` : 
                                '<span class="text-muted">-</span>'
                            )
                        }
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-1">
                            ${botoesDocumentos}
                            ${materia.qtd_substitutivos > 0 ? `<span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 badge-documento badge-clickable mb-1" data-bs-toggle="tooltip" title="Clique para ver substitutivos" data-cod-materia="${materia.cod_materia}" data-tipo="substitutivos" data-tipo-materia="${sanitizeHTML(materia.des_tipo_materia || '')}" data-sigla-materia="${sanitizeHTML(materia.sgl_tipo_materia || '')}" data-num-materia="${sanitizeHTML(materia.num_ident_basica)}" data-ano-materia="${sanitizeHTML(materia.ano_ident_basica)}"><i class="fa fa-file-alt me-1"></i>Sub. (${materia.qtd_substitutivos})</span>` : ''}
                            ${materia.qtd_emendas > 0 ? `<span class="badge bg-warning bg-opacity-10 text-warning-emphasis border border-warning border-opacity-25 badge-documento badge-clickable mb-1" data-bs-toggle="tooltip" title="Clique para ver emendas" data-cod-materia="${materia.cod_materia}" data-tipo="emendas" data-tipo-materia="${sanitizeHTML(materia.des_tipo_materia || '')}" data-sigla-materia="${sanitizeHTML(materia.sgl_tipo_materia || '')}" data-num-materia="${sanitizeHTML(materia.num_ident_basica)}" data-ano-materia="${sanitizeHTML(materia.ano_ident_basica)}"><i class="fa fa-edit me-1"></i>Em. (${materia.qtd_emendas})</span>` : ''}
                            ${materia.qtd_documentos_acessorios > 0 ? `<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-documento badge-clickable mb-1" data-bs-toggle="tooltip" title="Clique para ver documentos acessórios" data-cod-materia="${materia.cod_materia}" data-tipo="documentos_acessorios" data-tipo-materia="${sanitizeHTML(materia.des_tipo_materia || '')}" data-sigla-materia="${sanitizeHTML(materia.sgl_tipo_materia || '')}" data-num-materia="${sanitizeHTML(materia.num_ident_basica)}" data-ano-materia="${sanitizeHTML(materia.ano_ident_basica)}"><i class="fa fa-file me-1"></i>Doc. (${materia.qtd_documentos_acessorios})</span>` : ''}
                            ${materia.qtd_pareceres > 0 ? `<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 badge-documento badge-clickable mb-1" data-bs-toggle="tooltip" title="Clique para ver pareceres" data-cod-materia="${materia.cod_materia}" data-tipo="pareceres" data-tipo-materia="${sanitizeHTML(materia.des_tipo_materia || '')}" data-sigla-materia="${sanitizeHTML(materia.sgl_tipo_materia || '')}" data-num-materia="${sanitizeHTML(materia.num_ident_basica)}" data-ano-materia="${sanitizeHTML(materia.ano_ident_basica)}"><i class="fa fa-gavel me-1"></i>Par. (${materia.qtd_pareceres})</span>` : ''}
                            <a href="${materia.detail_url}" class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-clickable text-decoration-none mb-1" title="Ver Processo Completo" data-bs-toggle="tooltip"><i class="fa fa-eye me-1"></i>Ver Processo</a>
                        </div>
                    </td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        return html;
    }

    function renderCardsView(data, termosBusca) {
        let html = '<div class="card-view-container mb-3">';
        data.data.forEach(materia => {
            const ementaDestacada = highlightText(sanitizeHTML(materia.txt_ementa || ''), termosBusca);
            let botoesDocumentos = '';
            // Para matérias principais: mostrar todos os badges disponíveis
            if (materia.tipo_item === 'principal' || !materia.tipo_item) {
                // Badge de Pasta Digital (apenas para matérias principais com texto integral e usuários autenticados) - DEVE VIR ANTES
                if (materia.url_pasta_digital) {
                    botoesDocumentos += `<a href="${materia.url_pasta_digital}" class="badge bg-warning bg-opacity-10 text-warning-emphasis border border-warning border-opacity-25 badge-clickable text-decoration-none" target="_blank" title="Pasta Digital" data-bs-toggle="tooltip"><i class="far fa-folder-open me-1"></i>Pasta Digital</a>`;
                }
                // Texto Integral
                if (materia.url_texto_integral) {
                    botoesDocumentos += `<a href="${materia.url_texto_integral}" class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-clickable text-decoration-none" target="_blank" title="Texto Integral" data-bs-toggle="tooltip"><i class="far fa-file-pdf me-1"></i>Texto Integral</a>`;
                }
                // Redação Final
                if (materia.url_redacao_final) {
                    botoesDocumentos += `<a href="${materia.url_redacao_final}" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 badge-clickable text-decoration-none" target="_blank" title="Redação Final" data-bs-toggle="tooltip"><i class="fas fa-file-pdf me-1"></i>Redação Final</a>`;
                }
            } else if (materia.tipo_item === 'emenda' || materia.tipo_item === 'substitutivo') {
                // Para emendas e substitutivos: mostrar apenas Texto Integral
                if (materia.url_texto_integral) {
                    botoesDocumentos += `<a href="${materia.url_texto_integral}" class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-clickable text-decoration-none" target="_blank" title="Texto Integral" data-bs-toggle="tooltip"><i class="far fa-file-pdf me-1"></i>Texto Integral</a>`;
                }
            } else {
                // Para outros tipos (acessoria_principal): mostrar Texto Integral e Redação Final se disponíveis
                if (materia.url_texto_integral) {
                    botoesDocumentos += `<a href="${materia.url_texto_integral}" class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-clickable text-decoration-none" target="_blank" title="Texto Integral" data-bs-toggle="tooltip"><i class="far fa-file-pdf me-1"></i>Texto Integral</a>`;
                }
                if (materia.url_redacao_final) {
                    botoesDocumentos += `<a href="${materia.url_redacao_final}" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 badge-clickable text-decoration-none" target="_blank" title="Redação Final" data-bs-toggle="tooltip"><i class="fas fa-file-pdf me-1"></i>Redação Final</a>`;
                }
            }
            html += `
                <div class="card card-materia mb-3 position-relative shadow-sm">
                    ${materia.ind_tramitacao == 1 ? `<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 shadow-sm position-absolute top-0 end-0 m-2 px-2 py-1"><i class="fa fa-check-circle me-1"></i>Em Tramitação</span>` : ''}
                    <div class="card-header bg-light">
                        <a href="${materia.detail_url}" 
                           class="text-decoration-none text-body fw-semibold d-block card-title-link ${materia.ind_tramitacao == 1 ? 'card-header-with-badge' : ''}"
                           title="Ver Processo Completo"
                           aria-label="Ver processo completo da matéria ${sanitizeHTML(materia.des_tipo_materia || '')} n° ${sanitizeHTML(materia.num_ident_basica)}/${sanitizeHTML(materia.ano_ident_basica)}">
                            <i class="fas fa-file-alt text-primary me-2"></i>
                            ${materia.tipo_item === 'acessoria_principal' ? '<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 me-1"><i class="fa fa-file me-1"></i>Acessória</span>' : ''}
                            ${materia.identificacao ? sanitizeHTML(materia.identificacao) : `${sanitizeHTML(materia.des_tipo_materia || '')} n° ${sanitizeHTML(materia.num_ident_basica)}/${sanitizeHTML(materia.ano_ident_basica)}`}
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="text-break text-body">${ementaDestacada || '<em class="text-secondary">Sem ementa</em>'}</div>
                        </div>
                        <div class="mb-4">
                            <i class="fas fa-user-edit text-primary me-1"></i>
                            <span class="text-body">
                                <strong class="text-body fw-medium">Autoria:</strong> <span class="text-body">${materia.autores ? sanitizeHTML(materia.autores) : '<em class="text-secondary">não informada</em>'}</span>
                            </span>
                        </div>
                        <div class="card-section-detalhes">
                            <div class="small">
                                <div class="mb-2">
                                    <i class="fa fa-calendar-alt text-muted me-2"></i>
                                    <strong class="text-body fw-medium">Apresentação:</strong> <span class="text-secondary">${sanitizeHTML(materia.dat_apresentacao || 'N/A')}</span>
                                </div>
                                ${materia.num_protocolo ? `
                                    <div class="mb-2">
                                        <i class="fa fa-hashtag text-muted me-2"></i>
                                        <strong class="text-body fw-medium">Protocolo:</strong> <span class="text-secondary">${materia.num_protocolo}/${materia.ano_ident_basica}</span>
                                    </div>
                                ` : ''}
                                ${(materia.tipo_item === 'principal' || !materia.tipo_item) ? `
                                    <div class="${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'text-danger' : ''}">
                                        <i class="fa fa-clock ${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'text-danger' : 'text-muted'} me-2"></i>
                                        <strong class="${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'text-danger fw-medium' : 'text-body fw-medium'}">Regime de Tramitação:</strong> <span class="${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'text-danger' : 'text-secondary'}">${materia.des_regime_tramitacao ? sanitizeHTML(materia.des_regime_tramitacao) : '<em class="text-secondary">Não informado</em>'}</span>
                                    </div>
                                ` : (materia.des_regime_tramitacao ? `
                                    <div class="${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'text-danger' : ''}">
                                        <i class="fa fa-clock ${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'text-danger' : 'text-muted'} me-2"></i>
                                        <strong class="${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'text-danger fw-medium' : 'text-body fw-medium'}">Regime de Tramitação:</strong> <span class="${materia.des_regime_tramitacao && (materia.des_regime_tramitacao.includes('Urgência') || materia.des_regime_tramitacao.includes('Urgente')) ? 'text-danger' : 'text-secondary'}">${sanitizeHTML(materia.des_regime_tramitacao)}</span>
                                    </div>
                                ` : '')}
                                ${materia.anexadas && materia.anexadas.length > 0 ? `
                                    <div class="mt-2">
                                        <i class="fa fa-paperclip text-muted me-2"></i>
                                        <strong class="text-body fw-medium">Anexada:</strong> <span class="text-secondary">${materia.anexadas.map(a => {
                                            if (typeof a === 'string') {
                                                // Compatibilidade: se for string antiga, retornar como texto
                                                return sanitizeHTML(a);
                                            } else {
                                                // Novo formato: objeto com identificacao e url
                                                return `<a href="${a.url}" class="text-primary text-decoration-none" target="_blank" title="Ver matéria ${sanitizeHTML(a.identificacao)}">${sanitizeHTML(a.identificacao)}</a>`;
                                            }
                                        }).join(', ')}</span>
                                    </div>
                                ` : ''}
                                ${materia.assunto ? `
                                    <div class="mt-2">
                                        <i class="fa fa-tag text-muted me-2"></i>
                                        <strong class="text-body fw-medium">Assunto:</strong> <span class="text-secondary">${sanitizeHTML(materia.assunto)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ${(materia.tipo_item === 'principal' || !materia.tipo_item) || (materia.ult_tramitacao && (materia.ult_tramitacao.nom_unidade || materia.ult_tramitacao.des_status || materia.ult_tramitacao.dat_fim_prazo)) || materia.norma_derivada ? `
                        <div class="card-section-status">
                            <div class="small">
                                ${(materia.tipo_item === 'principal' || !materia.tipo_item) || (materia.ult_tramitacao && materia.ult_tramitacao.nom_unidade) ? `
                                    <div class="mb-2">
                                        <i class="fa fa-map-marker-alt text-muted me-2"></i>
                                        <strong class="text-body fw-medium">Localização Atual:</strong> <span class="text-secondary">${materia.ult_tramitacao && materia.ult_tramitacao.nom_unidade ? sanitizeHTML(materia.ult_tramitacao.nom_unidade) : '<em class="text-secondary">Não informado</em>'}</span>
                                    </div>
                                ` : ''}
                                ${(materia.tipo_item === 'principal' || !materia.tipo_item) || (materia.ult_tramitacao && materia.ult_tramitacao.des_status && materia.ult_tramitacao.dat_tramitacao) ? `
                                    <div class="mb-2">
                                        <i class="fa fa-info-circle text-muted me-2"></i>
                                        <strong class="text-body fw-medium">Situação${materia.ult_tramitacao && materia.ult_tramitacao.dat_tramitacao ? ` em ${sanitizeHTML(materia.ult_tramitacao.dat_tramitacao)}` : ''}:</strong> <span class="text-secondary">${materia.ult_tramitacao && materia.ult_tramitacao.des_status ? sanitizeHTML(materia.ult_tramitacao.des_status) : '<em class="text-secondary">Não informado</em>'}</span>
                                    </div>
                                ` : ''}
                                ${materia.ult_tramitacao && materia.ult_tramitacao.dat_fim_prazo ? `
                                    <div class="mb-2">
                                        <i class="fa fa-calendar-check text-muted me-2"></i>
                                        <strong class="text-body fw-medium">Prazo:</strong> <span class="text-secondary">${sanitizeHTML(materia.ult_tramitacao.dat_fim_prazo)}</span>
                                    </div>
                                ` : ''}
                                ${materia.norma_derivada ? `
                                    <div>
                                        <i class="fa fa-gavel text-muted me-2"></i>
                                        <strong class="text-body fw-medium">Norma Derivada:</strong> 
                                        <a href="${materia.norma_derivada.url || '#'}" 
                                           class="text-primary text-decoration-none" 
                                           target="_blank"
                                           title="Ver norma ${sanitizeHTML(materia.norma_derivada.sgl_norma || '')} ${String(materia.norma_derivada.num_norma || '')}/${String(materia.norma_derivada.ano_norma || '')}">
                                            ${sanitizeHTML(materia.norma_derivada.sgl_norma || '')} ${String(materia.norma_derivada.num_norma || '')}/${String(materia.norma_derivada.ano_norma || '')}
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ${(materia.qtd_substitutivos > 0 || materia.qtd_emendas > 0 || materia.qtd_documentos_acessorios > 0 || materia.qtd_pareceres > 0 || botoesDocumentos) ? `
                    <div class="card-footer bg-transparent border-top">
                        <div class="d-flex flex-wrap gap-1">
                            ${botoesDocumentos}
                            ${materia.qtd_substitutivos > 0 ? `<span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 badge-documento badge-clickable" data-bs-toggle="tooltip" title="Clique para ver substitutivos" data-cod-materia="${materia.cod_materia}" data-tipo="substitutivos" data-tipo-materia="${sanitizeHTML(materia.des_tipo_materia || '')}" data-sigla-materia="${sanitizeHTML(materia.sgl_tipo_materia || '')}" data-num-materia="${String(materia.num_ident_basica || '')}" data-ano-materia="${String(materia.ano_ident_basica || '')}"><i class="fa fa-file-alt me-1"></i>Substitutivo${materia.qtd_substitutivos > 1 ? 's' : ''} (${materia.qtd_substitutivos})</span>` : ''}
                            ${materia.qtd_emendas > 0 ? `<span class="badge bg-warning bg-opacity-10 text-warning-emphasis border border-warning border-opacity-25 badge-documento badge-clickable" data-bs-toggle="tooltip" title="Clique para ver emendas" data-cod-materia="${materia.cod_materia}" data-tipo="emendas" data-tipo-materia="${sanitizeHTML(materia.des_tipo_materia || '')}" data-sigla-materia="${sanitizeHTML(materia.sgl_tipo_materia || '')}" data-num-materia="${String(materia.num_ident_basica || '')}" data-ano-materia="${String(materia.ano_ident_basica || '')}"><i class="fa fa-edit me-1"></i>Emenda${materia.qtd_emendas > 1 ? 's' : ''} (${materia.qtd_emendas})</span>` : ''}
                            ${materia.qtd_documentos_acessorios > 0 ? `<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 badge-documento badge-clickable" data-bs-toggle="tooltip" title="Clique para ver documentos acessórios" data-cod-materia="${materia.cod_materia}" data-tipo="documentos_acessorios" data-tipo-materia="${sanitizeHTML(materia.des_tipo_materia || '')}" data-sigla-materia="${sanitizeHTML(materia.sgl_tipo_materia || '')}" data-num-materia="${String(materia.num_ident_basica || '')}" data-ano-materia="${String(materia.ano_ident_basica || '')}"><i class="fa fa-file me-1"></i>Doc. Acessório${materia.qtd_documentos_acessorios > 1 ? 's' : ''} (${materia.qtd_documentos_acessorios})</span>` : ''}
                            ${materia.qtd_pareceres > 0 ? `<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 badge-documento badge-clickable" data-bs-toggle="tooltip" title="Clique para ver pareceres" data-cod-materia="${materia.cod_materia}" data-tipo="pareceres" data-tipo-materia="${sanitizeHTML(materia.des_tipo_materia || '')}" data-sigla-materia="${sanitizeHTML(materia.sgl_tipo_materia || '')}" data-num-materia="${String(materia.num_ident_basica || '')}" data-ano-materia="${String(materia.ano_ident_basica || '')}"><i class="fa fa-gavel me-1"></i>Parecer${materia.qtd_pareceres > 1 ? 'es' : ''} (${materia.qtd_pareceres})</span>` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>`;
        });
        html += '</div>';
        return html;
    }

    function renderizarPaginacao(data) {
        if (data.total_pages <= 1) return '';
        let html = '<nav id="nav-paginacao" aria-label="Navegação de páginas"><ul class="pagination justify-content-center flex-wrap">';
        html += `<li class="page-item ${data.page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="1" title="Primeira página">&laquo;</a>
            </li>`;
        html += `<li class="page-item ${!data.has_previous ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${data.page - 1}">&lsaquo;</a>
            </li>`;
        const maxPagesToShow = 3;
        let startPage = Math.max(1, data.page - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(data.total_pages, startPage + maxPagesToShow - 1);
        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }
        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
            if (startPage > 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === data.page ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>`;
        }
        if (endPage < data.total_pages) {
            if (endPage < data.total_pages - 1) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${data.total_pages}">${data.total_pages}</a></li>`;
        }
        html += `<li class="page-item ${!data.has_next ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${data.page + 1}">&rsaquo;</a>
            </li>`;
        html += `<li class="page-item ${data.page === data.total_pages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${data.total_pages}" title="Última página">&raquo;</a>
            </li>`;
        html += '</ul></nav>';
        return html;
    }

    function renderStatsChart(statsData) {
        const tabButton = document.querySelector('#grafico-tab');
        if (!tabButton) return;
        // Sempre mostrar a aba, mesmo sem dados (será carregado sob demanda)
        tabButton.parentElement.classList.remove('d-none');
        tabButton.parentElement.classList.add('d-block');
        
        if (!statsData || Object.keys(statsData).length === 0) {
            // Se não há dados, apenas destruir o gráfico existente, mas manter a aba visível
            // Destruir gráfico existente apenas se já existir
        if (statsChartInstance) {
            try {
                statsChartInstance.destroy();
            } catch (e) {
                // Ignorar erros ao destruir
            }
            statsChartInstance = null;
            window.statsChartInstance = null;
        }
            // Mostrar mensagem de que os dados serão carregados ao clicar
            const canvas = document.getElementById('stats-chart');
            if (canvas) {
                const container = canvas.parentElement;
                if (container && !container.querySelector('.stats-placeholder')) {
                    container.innerHTML = '<div class="stats-placeholder text-center p-4"><p class="text-muted">Clique na aba para carregar as estatísticas</p></div>';
                }
            }
            return;
        }
        // Destruir gráfico existente apenas se já existir e for diferente
        if (statsChartInstance) {
            try {
                statsChartInstance.destroy();
            } catch (e) {
                // Ignorar erros ao destruir
            }
            statsChartInstance = null;
            window.statsChartInstance = null;
        }
        
        // Restaurar o canvas se foi substituído por placeholder
        const statsContainer = document.querySelector('#resumo-estatistico .canvas-container');
        if (statsContainer && statsContainer.querySelector('.stats-placeholder')) {
            statsContainer.innerHTML = '<canvas id="stats-chart" aria-label="Gráfico de resumo estatístico das matérias"></canvas>';
        }
        const canvas = document.getElementById('stats-chart');
        if (!canvas) {
            console.error('Canvas stats-chart não encontrado!');
            return;
        }
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('Não foi possível obter contexto 2D do canvas!');
            return;
        }
        
        // Ordenar por quantidade (decrescente) e depois alfabeticamente
        const sortedEntries = Object.entries(statsData).sort((a, b) => {
            if (b[1] !== a[1]) {
                return b[1] - a[1]; // Ordenar por quantidade (decrescente)
            }
            return a[0].localeCompare(b[0]); // Se quantidade igual, ordenar alfabeticamente
        });
        const labels = sortedEntries.map(([tipo]) => tipo);
        const dataValues = sortedEntries.map(([tipo, quantidade]) => quantidade);
        
        // Usar as mesmas cores do gráfico por autor
        // Definir cores na mesma ordem que no gráfico por autor
        const coresTipos = [
            'rgba(68, 162, 210, 0.85)',   // Azul - Emenda
            'rgba(255, 159, 64, 0.85)',   // Laranja - Indicação
            'rgba(75, 192, 192, 0.85)',   // Verde-água - Moção
            'rgba(153, 102, 255, 0.85)',  // Roxo - Projeto de Lei
            'rgba(54, 162, 235, 0.85)',   // Azul claro - Requerimento
            'rgba(255, 99, 132, 0.85)',   // Rosa
            'rgba(201, 203, 207, 0.85)',  // Cinza
            'rgba(255, 205, 86, 0.85)',   // Amarelo
            'rgba(50, 205, 50, 0.85)',    // Verde limão
            'rgba(255, 99, 71, 0.85)',    // Vermelho coral
            'rgba(138, 43, 226, 0.85)',   // Azul violeta
            'rgba(255, 140, 0, 0.85)',    // Laranja escuro
            'rgba(0, 191, 255, 0.85)',    // Azul céu
            'rgba(220, 20, 60, 0.85)',    // Vermelho carmesim
            'rgba(34, 139, 34, 0.85)',    // Verde floresta
            'rgba(148, 0, 211, 0.85)'     // Violeta
        ];
        
        // Para garantir que o mesmo tipo tenha a mesma cor em ambos os gráficos,
        // precisamos obter a lista de todos os tipos ordenados por frequência global
        // Como não temos acesso direto aos dados do gráfico por autor aqui,
        // vamos criar um mapeamento baseado na ordem alfabética dos tipos
        // e depois mapear para cores na mesma ordem
        const todosTiposOrdenados = [...labels].sort(); // Ordenar alfabeticamente para consistência
        const tipoCorMap = {};
        todosTiposOrdenados.forEach((tipo, index) => {
            tipoCorMap[tipo] = coresTipos[index % coresTipos.length];
        });
        
        // Criar array de cores para cada barra baseado no tipo (usando o mapeamento)
        const backgroundColors = labels.map((tipo) => {
            return tipoCorMap[tipo] || coresTipos[0];
        });
        const borderColors = backgroundColors.map(cor => cor.replace('0.85', '1'));

        // Calcular o total de proposições
        const totalProposicoes = dataValues.reduce((sum, val) => sum + val, 0);
        
        // Calcular o valor máximo para definir o max do eixo X com margem para labels de até 4 dígitos
        let maxTotalValue = Math.max(...dataValues);
        const margin = maxTotalValue < 100 ? 40 : maxTotalValue < 500 ? Math.ceil(maxTotalValue * 0.25) : Math.ceil(maxTotalValue * 0.20);
        const maxXAxisValue = Math.ceil(maxTotalValue + margin);
        
        // Ajustar altura do container baseado no número de tipos
        // Ambos os gráficos (barra e pizza) devem ter o mesmo tamanho
        const container = canvas.parentElement;
        const numItems = labels.length;
        // Como há no máximo 15 tipos, usar altura proporcional mas limitada
        // Altura mínima: 300px, altura máxima: 450px
        // Para poucos tipos (1-5): 300px, para mais tipos: proporcional até 450px
        const minHeight = numItems <= 5 ? 300 : Math.min(300 + (numItems - 5) * 15, 450);
        container.style.minHeight = `${minHeight}px`;
        container.style.maxHeight = '450px';

        // Criar configurações baseadas no tipo de gráfico
        let chartConfig;
        if (tipoGraficoTipo === 'pie') {
            // Para gráfico de pizza com muitos tipos, agrupar tipos pequenos em "Outros"
            let pieLabels = labels;
            let pieDataValues = dataValues;
            let pieBackgroundColors = backgroundColors;
            let pieBorderColors = borderColors;
            const threshold = 0.02; // 2% do total - tipos menores que isso serão agrupados
            const minItemsToGroup = 8; // Agrupar apenas se houver mais de 8 tipos
            
            if (numItems > minItemsToGroup) {
                const total = totalProposicoes;
                const thresholdValue = total * threshold;
                const mainItems = [];
                const otherItems = [];
                let otherTotal = 0;
                
                labels.forEach((label, index) => {
                    if (dataValues[index] >= thresholdValue) {
                        mainItems.push({
                            label: label,
                            value: dataValues[index],
                            color: backgroundColors[index],
                            borderColor: borderColors[index]
                        });
                    } else {
                        otherItems.push({
                            label: label,
                            value: dataValues[index]
                        });
                        otherTotal += dataValues[index];
                    }
                });
                
                // Ordenar itens principais por valor (decrescente)
                mainItems.sort((a, b) => b.value - a.value);
                
                // Se houver itens pequenos, adicionar "Outros"
                if (otherTotal > 0) {
                    mainItems.push({
                        label: 'Outros',
                        value: otherTotal,
                        color: 'rgba(201, 203, 207, 0.85)', // Cinza
                        borderColor: 'rgba(201, 203, 207, 1)'
                    });
                }
                
                pieLabels = mainItems.map(item => item.label);
                pieDataValues = mainItems.map(item => item.value);
                pieBackgroundColors = mainItems.map(item => item.color);
                pieBorderColors = mainItems.map(item => item.borderColor);
            }
            
            // Configuração para gráfico de pizza
            chartConfig = {
                type: 'pie',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        label: 'Quantidade',
                        data: pieDataValues,
                        backgroundColor: pieBackgroundColors,
                        borderColor: pieBorderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    clip: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: numItems > 8 ? 10 : 20, // Menos padding à esquerda quando há muitos tipos
                            right: numItems > 8 ? 200 : 20 // Mais espaço para legenda quando há muitos tipos
                        }
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            position: numItems > 8 ? 'right' : 'right',
                            align: 'start',
                            labels: {
                                boxWidth: 15,
                                padding: numItems > 8 ? 8 : 12, // Menos padding quando há muitos tipos
                                font: { size: numItems > 8 ? 10 : 11 }, // Fonte menor quando há muitos tipos
                                usePointStyle: true,
                                pointStyle: 'circle',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor[i],
                                                lineWidth: 1,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: { 
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: numItems > 8 ? 10 : 11 }, // Fonte menor quando há muitos tipos
                            formatter: function(value, context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                // Mostrar porcentagem apenas se for >= 3% para evitar sobrecarga visual
                                return parseFloat(percentage) >= 3 ? percentage + '%' : '';
                            },
                            // Ajustar offset baseado no número de tipos
                            offset: numItems > 8 ? 5 : 8
                        },
                        title: {
                            display: true,
                            text: `Total: ${totalProposicoes} ${totalProposicoes === 1 ? 'proposição' : 'proposições'}`,
                            font: { size: 14, weight: 'bold' },
                            padding: { bottom: 10 }
                        }
                    },
                    animation: {
                        duration: 0
                    }
                },
                plugins: [ChartDataLabels]
            };
        } else {
            // Configuração para gráfico de barra
            chartConfig = {
                type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Quantidade',
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    barThickness: 'flex',
                    maxBarThickness: 30, // Mesma altura de barra do gráfico por autor
                    minBarLength: 0
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                clip: false,
                layout: {
                    padding: {
                        right: 250, // Espaço extra à direita para os labels de dados no final das barras (aumentado muito para números de até 4 dígitos)
                        top: 30, // Padding no topo para garantir que o primeiro label seja visível
                        bottom: 30, // Padding na base
                        left: 25 // Padding à esquerda
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        callbacks: {
                            title: function(context) {
                                if (!context || context.length === 0) return '';
                                return context[0].label || '';
                            },
                            label: function(context) {
                                const quantidade = context.parsed ? context.parsed.x : 0;
                                return `Quantidade: ${quantidade}`;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#000',
                        font: { weight: 'bold', size: 12 },
                        padding: {
                            left: 6,
                            right: 6,
                            top: 3,
                            bottom: 3
                        },
                        offset: 12, // Offset positivo para colocar o label FORA da barra (à direita)
                        clip: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: 'transparent',
                        borderWidth: 0,
                        borderRadius: 0,
                        formatter: function(value) { return value; }
                    },
                    title: {
                        display: true,
                        text: `Total: ${totalProposicoes} ${totalProposicoes === 1 ? 'proposição' : 'proposições'}`,
                        font: { size: 14, weight: 'bold' },
                        padding: { bottom: 10 }
                    }
                },
                scales: { 
                    x: { 
                        beginAtZero: true,
                        max: maxXAxisValue, // Limitar o eixo X para criar espaço para labels de até 4 dígitos
                        ticks: {
                            stepSize: maxXAxisValue > 1000 ? Math.ceil(maxXAxisValue / 20) : (maxXAxisValue > 100 ? Math.ceil(maxXAxisValue / 10) : 1),
                            maxTicksLimit: 20,
                            autoSkip: true,
                            font: { size: 11 }
                        },
                        title: {
                            display: true,
                            text: 'Quantidade de Matérias',
                            font: { size: 12, weight: 'bold' }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawOnChartArea: true
                        }
                    },
                    y: {
                        ticks: {
                            display: true,
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0,
                            font: { size: 11 },
                            stepSize: 1,
                            maxTicksLimit: undefined
                        },
                        afterFit: function(scale) {
                            // Aumentar largura para acomodar nomes de tipos
                            scale.width = Math.max(scale.width, 280);
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                    axis: 'y'
                },
                animation: {
                    duration: 0
                }
            },
            plugins: [ChartDataLabels]
        };
        }
        
        // Criar novo gráfico
        statsChartInstance = new Chart(ctx, chartConfig);
        window.statsChartInstance = statsChartInstance;
    }
    
    // Event listeners para alternar tipo de gráfico por tipo
    // Adicionar após o DOM estar carregado
    setTimeout(function() {
        const btnBarra = document.getElementById('btn-grafico-barra-tipo');
        const btnPizza = document.getElementById('btn-grafico-pizza-tipo');
        
        if (btnBarra && btnPizza) {
            btnBarra.addEventListener('click', function() {
                tipoGraficoTipo = 'bar';
                btnBarra.classList.add('active');
                btnPizza.classList.remove('active');
                // Recriar gráfico se já houver dados
                if (window.ultimoStatsData) {
                    renderStatsChart(window.ultimoStatsData);
                }
            });
            
            btnPizza.addEventListener('click', function() {
                tipoGraficoTipo = 'pie';
                btnPizza.classList.add('active');
                btnBarra.classList.remove('active');
                // Recriar gráfico se já houver dados
                if (window.ultimoStatsData) {
                    renderStatsChart(window.ultimoStatsData);
                }
            });
        }
        
        // Event listeners para alternar tipo de gráfico por assunto
        const btnBarraAssunto = document.getElementById('btn-grafico-barra-assunto');
        const btnPizzaAssunto = document.getElementById('btn-grafico-pizza-assunto');
        
        if (btnBarraAssunto && btnPizzaAssunto) {
            btnBarraAssunto.addEventListener('click', function() {
                tipoGraficoAssunto = 'bar';
                btnBarraAssunto.classList.add('active');
                btnPizzaAssunto.classList.remove('active');
                // Recriar gráfico se já houver dados
                if (window.ultimoStatsAssuntoData) {
                    renderStatsChartAssunto(window.ultimoStatsAssuntoData);
                }
            });
            
            btnPizzaAssunto.addEventListener('click', function() {
                tipoGraficoAssunto = 'pie';
                btnPizzaAssunto.classList.add('active');
                btnBarraAssunto.classList.remove('active');
                // Recriar gráfico se já houver dados
                if (window.ultimoStatsAssuntoData) {
                    renderStatsChartAssunto(window.ultimoStatsAssuntoData);
                }
            });
        }
    }, 100);

    function renderStatsChartAutor(statsData) {
        const tabButton = document.querySelector('#grafico-autor-tab');
        if (!tabButton) return;
        // Sempre mostrar a aba, mesmo sem dados (será carregado sob demanda)
        tabButton.parentElement.classList.remove('d-none');
        tabButton.parentElement.classList.add('d-block');
        
        if (!statsData || Object.keys(statsData).length === 0) {
            // Se não há dados, apenas destruir o gráfico existente, mas manter a aba visível
            // Destruir gráfico existente apenas se já existir
        if (statsChartAutorInstance) {
            try {
                statsChartAutorInstance.destroy();
            } catch (e) {
                // Ignorar erros ao destruir
            }
            statsChartAutorInstance = null;
            window.statsChartAutorInstance = null;
        }
            // Mostrar mensagem de que os dados serão carregados ao clicar
            const canvas = document.getElementById('stats-chart-autor');
            if (canvas) {
                const container = canvas.parentElement;
                if (container && !container.querySelector('.stats-placeholder')) {
                    container.innerHTML = '<div class="stats-placeholder text-center p-4"><p class="text-muted">Clique na aba para carregar as estatísticas</p></div>';
                }
            }
            return;
        }
        // Destruir gráfico existente apenas se já existir
        if (statsChartAutorInstance) {
            try {
                statsChartAutorInstance.destroy();
            } catch (e) {
                // Ignorar erros ao destruir
            }
            statsChartAutorInstance = null;
            window.statsChartAutorInstance = null;
        }
        // Restaurar o canvas se foi substituído por placeholder
        const statsAutorContainer = document.querySelector('#resumo-estatistico-autor .canvas-container');
        if (statsAutorContainer && statsAutorContainer.querySelector('.stats-placeholder')) {
            statsAutorContainer.innerHTML = '<canvas id="stats-chart-autor" aria-label="Gráfico de resumo estatístico por autor"></canvas>';
        }
        const canvas = document.getElementById('stats-chart-autor');
        if (!canvas) return;
        const container = canvas.parentElement;
        const ctx = canvas.getContext('2d');
        
        // Verificar se statsData tem a nova estrutura (com total e tipos) ou a estrutura antiga (apenas números)
        const isNewStructure = statsData && Object.keys(statsData).length > 0 && 
                               typeof Object.values(statsData)[0] === 'object' && 
                               Object.values(statsData)[0].hasOwnProperty('total');
        
        let labels, datasets, totalAutores, processedStatsData, tiposOutros;
        let tiposPrincipais, cores, tipoCorMapGlobal; // Declarar no escopo externo
        let maxXAxisValue; // Variável para armazenar o valor máximo do eixo X com margem
        let totalProposicoes = 0; // Variável para armazenar o total de proposições
        
        if (isNewStructure) {
            // Nova estrutura: { autor: { total: X, tipos: { tipo1: Y, tipo2: Z } } }
            // Coletar todos os tipos únicos e calcular frequência global de cada tipo
            const tipoFrequencia = {};
            Object.values(statsData).forEach(authorData => {
                if (authorData.tipos) {
                    Object.entries(authorData.tipos).forEach(([tipo, quantidade]) => {
                        tipoFrequencia[tipo] = (tipoFrequencia[tipo] || 0) + quantidade;
                    });
                }
            });
            
            // Ordenar tipos por frequência global e mostrar TODOS os tipos
            const sortedTipos = Object.entries(tipoFrequencia)
                .sort((a, b) => b[1] - a[1])
                .map(([tipo]) => tipo);
            // Mostrar todos os tipos, sem agrupar em "Outros"
            tiposPrincipais = sortedTipos; // Atribuir à variável do escopo externo
            tiposOutros = []; // Não há tipos agrupados
            
            // Cores para os tipos (cores mais distintas e legíveis)
            // Usar uma paleta de cores que se repete se houver muitos tipos
            // IMPORTANTE: Definir cores ANTES de criar o mapeamento
            cores = [ // Atribuir à variável do escopo externo
                'rgba(68, 162, 210, 0.85)',   // Azul - Emenda
                'rgba(255, 159, 64, 0.85)',   // Laranja - Indicação
                'rgba(75, 192, 192, 0.85)',   // Verde-água - Moção
                'rgba(153, 102, 255, 0.85)',  // Roxo - Projeto de Lei
                'rgba(54, 162, 235, 0.85)',   // Azul claro - Requerimento
                'rgba(255, 99, 132, 0.85)',   // Rosa
                'rgba(201, 203, 207, 0.85)',  // Cinza
                'rgba(255, 205, 86, 0.85)',   // Amarelo
                'rgba(50, 205, 50, 0.85)',    // Verde limão
                'rgba(255, 99, 71, 0.85)',    // Vermelho coral
                'rgba(138, 43, 226, 0.85)',   // Azul violeta
                'rgba(255, 140, 0, 0.85)',    // Laranja escuro
                'rgba(0, 191, 255, 0.85)',    // Azul céu
                'rgba(220, 20, 60, 0.85)',    // Vermelho carmesim
                'rgba(34, 139, 34, 0.85)',    // Verde floresta
                'rgba(148, 0, 211, 0.85)'     // Violeta
            ];
            
            // Criar mapeamento de tipo para cor baseado na ordem alfabética
            // Isso garante que o mesmo tipo tenha a mesma cor em ambos os gráficos
            // IMPORTANTE: Fazer isso DEPOIS de definir a variável cores
            const todosTiposAlfabetico = [...sortedTipos].sort();
            tipoCorMapGlobal = {}; // Atribuir à variável do escopo externo
            todosTiposAlfabetico.forEach((tipo, index) => {
                tipoCorMapGlobal[tipo] = cores[index % cores.length];
            });
            
            // Calcular o total de proposições de TODOS os autores ANTES de limitar aos top 30
            totalProposicoes = 0;
            Object.values(statsData).forEach(authorData => {
                totalProposicoes += authorData.total;
            });
            
            // Limitar a 30 autores mais frequentes
            // IMPORTANTE: Manter a ordem original dos dados do backend para garantir alinhamento correto
            const maxItems = 30;
            const sortedEntries = Object.entries(statsData).sort((a, b) => {
                // Ordenar por total (decrescente) e depois alfabeticamente (igual ao backend)
                if (b[1].total !== a[1].total) {
                    return b[1].total - a[1].total;
                }
                return a[0].localeCompare(b[0]);
            });
            totalAutores = sortedEntries.length;
            const topEntries = sortedEntries.slice(0, maxItems);
            // Criar objeto ordenado mantendo a ordem
            processedStatsData = {};
            topEntries.forEach(([autor, dados]) => {
                processedStatsData[autor] = dados;
            });
            labels = Object.keys(processedStatsData); // Manter ordem do processedStatsData
            
            // Calcular o valor máximo total para definir o max do eixo X com margem para labels de 4 dígitos
            let maxTotalValue = 0;
            Object.values(processedStatsData).forEach(authorData => {
                if (authorData.total > maxTotalValue) {
                    maxTotalValue = authorData.total;
                }
            });
            // Adicionar margem proporcional maior para caber labels de até 4 dígitos
            // Aumentar a margem significativamente para garantir que o label não seja cortado
            const margin = maxTotalValue < 100 ? 40 : maxTotalValue < 500 ? Math.ceil(maxTotalValue * 0.25) : Math.ceil(maxTotalValue * 0.20);
            maxXAxisValue = Math.ceil(maxTotalValue + margin);
            
            // Criar um dataset para cada tipo principal (barras empilhadas)
            // IMPORTANTE: Garantir que os dados estejam na mesma ordem dos labels
            // Usar o mapeamento global de cores para garantir consistência
            datasets = tiposPrincipais.map((tipo, index) => {
                const data = labels.map(autor => {
                    // Garantir que estamos usando o autor correto do array de labels
                    const authorData = processedStatsData[autor];
                    if (!authorData) {
                        console.warn(`Dados não encontrados para autor: ${autor}`);
                        return 0;
                    }
                    return authorData.tipos && authorData.tipos[tipo] ? authorData.tipos[tipo] : 0;
                });
                // Usar cor do mapeamento global se disponível, senão usar índice
                const cor = tipoCorMapGlobal[tipo] || cores[index % cores.length];
                return {
                    label: tipo,
                    data: data,
                    backgroundColor: cor,
                    borderColor: cor.replace('0.85', '1'),
                    borderWidth: 1,
                    barThickness: 'flex',
                    maxBarThickness: 30
                };
            });
            
            // Não agrupar tipos em "Outros" - todos os tipos são mostrados individualmente
            
            // Ajustar altura do container baseado no número de itens
            const numItems = labels.length;
            // Para barras empilhadas, não precisamos de altura extra por tipo
            container.style.minHeight = `${Math.max(600, numItems * 35)}px`;
        } else {
            // Estrutura antiga: { autor: quantidade }
            labels = Object.keys(statsData);
            const dataValues = Object.values(statsData);
            
            // Calcular o total de proposições de TODOS os autores ANTES de limitar aos top 30
            totalProposicoes = dataValues.reduce((sum, val) => sum + val, 0);
            
            // Limitar a 30 autores mais frequentes
            const maxItems = 30;
            if (labels.length > maxItems) {
                const sortedEntries = Object.entries(statsData).sort((a, b) => b[1] - a[1]);
                totalAutores = sortedEntries.length;
                const topEntries = sortedEntries.slice(0, maxItems);
                const topStats = Object.fromEntries(topEntries);
                labels = Object.keys(topStats);
                const dataValuesLimited = Object.values(topStats);
                datasets = [{
                    label: 'Quantidade',
                    data: dataValuesLimited,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }];
            } else {
                totalAutores = labels.length;
                datasets = [{
                    label: 'Quantidade',
                    data: dataValues,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }];
            }
            
            // Calcular o valor máximo total para definir o max do eixo X com margem para labels de 4 dígitos
            const dataValuesForMax = datasets[0].data;
            let maxTotalValue = Math.max(...dataValuesForMax);
            // Adicionar margem proporcional maior para caber labels de até 4 dígitos
            const margin = maxTotalValue < 100 ? 40 : maxTotalValue < 500 ? Math.ceil(maxTotalValue * 0.25) : Math.ceil(maxTotalValue * 0.20);
            maxXAxisValue = Math.ceil(maxTotalValue + margin);
            
            container.style.minHeight = `${Math.max(600, labels.length * 35)}px`;
        }
        
        // Configurações do gráfico
        const chartOptions = {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            // Desabilitar clipping para garantir que os labels não sejam cortados
            clip: false,
            layout: {
                padding: {
                    right: 250, // Espaço extra à direita para os labels de dados no final das barras (aumentado muito para números de até 4 dígitos)
                    top: 30, // Padding no topo para garantir que o primeiro label seja visível
                    bottom: 30, // Padding na base
                    left: 25 // Padding à esquerda
                }
            },
            plugins: {
                legend: { 
                    display: isNewStructure && datasets.length > 1,
                    position: 'top',
                    align: 'start',
                    labels: {
                        boxWidth: 15,
                        padding: 12,
                        font: { size: 11 },
                        usePointStyle: true,
                        pointStyle: 'rect'
                    },
                    onClick: function(e, legendItem) {
                        // Permitir clicar na legenda para mostrar/ocultar datasets
                        const index = legendItem.datasetIndex;
                        const chart = this.chart;
                        const meta = chart.getDatasetMeta(index);
                        meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                        chart.update();
                    }
                },
                tooltip: { 
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    footerFont: { size: 11 },
                    // Mostrar tooltip para toda a barra, não apenas para cada segmento
                    mode: 'index',
                    intersect: false,
                    // Garantir que o tooltip apareça apenas quando o mouse está sobre a barra correta
                    position: 'nearest',
                    // Tooltip será habilitado condicionalmente (hover para desktop, clique para tablets)
                    callbacks: {
                        title: function(context) {
                            // Garantir que estamos usando o índice correto do primeiro elemento do contexto
                            // O contexto é um array de todos os datasets na mesma posição (barra empilhada)
                            if (!context || context.length === 0) return '';
                            const firstContext = context[0];
                            // Validar que temos um dataIndex válido
                            if (firstContext.dataIndex === undefined || firstContext.dataIndex === null) return '';
                            const dataIndex = firstContext.dataIndex;
                            const chart = firstContext.chart;
                            if (!chart || !chart.data || !chart.data.labels || !chart.data.labels[dataIndex]) return '';
                            const autorLabel = chart.data.labels[dataIndex];
                            // Validar que o autor existe nos dados processados
                            if (!processedStatsData || !processedStatsData[autorLabel]) {
                                console.warn(`Autor não encontrado nos dados processados: ${autorLabel}, índice: ${dataIndex}`);
                                return autorLabel || '';
                            }
                            return autorLabel || '';
                        },
                        label: function(context) {
                            if (isNewStructure) {
                                // Verificar se há dados válidos
                                if (!context || !context.dataset || !context.dataset.label) return null;
                                const tipo = context.dataset.label;
                                const quantidade = context.parsed ? context.parsed.x : 0;
                                if (quantidade === 0) return null; // Não mostrar tipos com quantidade zero
                                // Corrigir plural: "proposição" (singular) ou "proposições" (plural)
                                return `${tipo}: ${quantidade} ${quantidade === 1 ? 'proposição' : 'proposições'}`;
                            } else {
                                return `Quantidade: ${context.parsed ? context.parsed.x : 0}`;
                            }
                        },
                        afterBody: function(context) {
                            // Não há mais agrupamento em "Outros", todos os tipos são mostrados individualmente
                            return '';
                        },
                        footer: function(context) {
                            if (isNewStructure) {
                                // Garantir que estamos usando o índice correto
                                if (!context || context.length === 0) return '';
                                const firstContext = context[0];
                                // Validar que temos um dataIndex válido
                                if (firstContext.dataIndex === undefined || firstContext.dataIndex === null) return '';
                                const dataIndex = firstContext.dataIndex;
                                const chart = firstContext.chart;
                                if (!chart || !chart.data || !chart.data.labels || !chart.data.labels[dataIndex]) return '';
                                const autorLabel = chart.data.labels[dataIndex];
                                // Validar que o autor existe nos dados processados
                                if (!processedStatsData || !processedStatsData[autorLabel]) {
                                    console.warn(`Autor não encontrado nos dados processados no footer: ${autorLabel}, índice: ${dataIndex}`);
                                    return '';
                                }
                                const authorData = processedStatsData[autorLabel];
                                if (authorData) {
                                    // Corrigir plural: "proposição" (singular) ou "proposições" (plural)
                                    return `Total: ${authorData.total} ${authorData.total === 1 ? 'proposição' : 'proposições'}`;
                                }
                            }
                            return '';
                        },
                        // Filtrar tooltips para mostrar apenas quando há dados válidos
                        filter: function(context) {
                            // Mostrar apenas se houver quantidade > 0
                            if (context.parsed && context.parsed.x > 0) {
                                return true;
                            }
                            return false;
                        }
                    }
                },
                datalabels: {
                    // Mostrar o total no final de cada barra (no último dataset da barra empilhada)
                    display: function(context) {
                        // Mostrar apenas no último dataset (topo da barra empilhada)
                        return context.datasetIndex === datasets.length - 1;
                    },
                    formatter: function(value, context) {
                        const autor = context.chart.data.labels[context.dataIndex];
                        const authorData = processedStatsData && processedStatsData[autor];
                        if (authorData && authorData.total > 0) {
                            return authorData.total;
                        }
                        return '';
                    },
                    anchor: 'end',
                    align: 'end', // Alinhar ao final da barra
                    color: '#000',
                    font: { weight: 'bold', size: 12 },
                    padding: {
                        left: 6,
                        right: 6,
                        top: 3,
                        bottom: 3
                    },
                    offset: 12, // Offset positivo maior para colocar o label FORA da barra (à direita) com mais espaço
                    clip: false, // Não cortar o label mesmo que saia da área do gráfico
                    backgroundColor: 'rgba(255, 255, 255, 0.95)', // Fundo branco quase opaco para melhor legibilidade
                    borderColor: 'transparent', // Remover borda
                    borderWidth: 0, // Remover borda
                    borderRadius: 0 // Remover borda
                },
                title: {
                    display: labels.length > 30,
                    text: `Top 30 autores (de ${totalAutores} total)`,
                    font: { size: 14, weight: 'bold' },
                    padding: { bottom: 10 }
                }
            },
            scales: { 
                x: { 
                    beginAtZero: true,
                    stacked: true, // Barras empilhadas - cada autor tem uma barra dividida por cores
                    max: maxXAxisValue, // Limitar o eixo X para criar espaço para labels de até 4 dígitos
                    ticks: {
                        stepSize: maxXAxisValue > 1000 ? Math.ceil(maxXAxisValue / 20) : (maxXAxisValue > 100 ? Math.ceil(maxXAxisValue / 10) : 1),
                        maxTicksLimit: 20,
                        autoSkip: true,
                        font: { size: 11 }
                    },
                    title: {
                        display: true,
                        text: 'Quantidade de Matérias',
                        font: { size: 12, weight: 'bold' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)',
                        drawOnChartArea: true
                    }
                },
                y: {
                    stacked: true, // Barras empilhadas no eixo Y
                    ticks: {
                        display: true,
                        autoSkip: false,
                        maxRotation: 0,
                        minRotation: 0,
                        font: { size: 11 },
                        stepSize: 1,
                        maxTicksLimit: undefined
                    },
                    afterFit: function(scale) {
                        // Aumentar largura para acomodar nomes de autores
                        scale.width = Math.max(scale.width, 280);
                    },
                    grid: {
                        display: false // Remover linhas de grade verticais para melhor legibilidade
                    }
                }
            },
            layout: {
                padding: {
                    left: 15,
                    right: 15,
                    top: 20,
                    bottom: 15
                }
            },
            interaction: {
                mode: 'index',
                intersect: false,
                // Garantir que a interação seja baseada no eixo Y (autores) para barras horizontais
                axis: 'y'
            },
            animation: {
                duration: 0
            }
        };
        
        statsChartAutorInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: chartOptions,
            plugins: [ChartDataLabels]
        });
        
        // Garantir que o canvas tenha espaço suficiente para os labels
        // Ajustar o container e forçar atualização do gráfico após a renderização
        setTimeout(() => {
            if (statsChartAutorInstance && statsChartAutorInstance.canvas) {
                const canvas = statsChartAutorInstance.canvas;
                const container = canvas.parentElement;
                const parentContainer = container ? container.parentElement : null;
                
                // Garantir que todos os containers tenham largura suficiente e não cortem o conteúdo
                if (container) {
                    container.style.width = '100%';
                    container.style.overflow = 'visible';
                    container.style.maxWidth = 'none';
                }
                if (parentContainer) {
                    parentContainer.style.width = '100%';
                    parentContainer.style.overflow = 'visible';
                    parentContainer.style.maxWidth = 'none';
                }
                
                // Ajustar o canvas para ter espaço extra
                canvas.style.maxWidth = 'none';
                
                // Forçar atualização do gráfico para aplicar o padding corretamente
                statsChartAutorInstance.update('none');
                
                // Forçar resize para garantir que o gráfico recalcule as dimensões
                setTimeout(() => {
                    statsChartAutorInstance.resize();
                }, 50);
            }
        }, 300);
        window.statsChartAutorInstance = statsChartAutorInstance;
        
        // Manter o tooltip padrão do Chart.js habilitado (comportamento hover padrão)
        // O tooltip já está configurado nas opções do gráfico com as customizações necessárias
        // Remover tooltip customizado se existir (não será mais usado)
        const existingTooltip = document.getElementById('custom-tooltip-autor');
        if (existingTooltip) {
            existingTooltip.remove();
        }
        
        // Tooltip padrão do Chart.js está habilitado e funcionará ao passar o mouse
    }

    function renderStatsChartAssunto(statsData) {
        const tabButton = document.querySelector('#grafico-assunto-tab');
        if (!tabButton) return;
        // Sempre mostrar a aba, mesmo sem dados (será carregado sob demanda)
        tabButton.parentElement.classList.remove('d-none');
        tabButton.parentElement.classList.add('d-block');
        
        if (!statsData || Object.keys(statsData).length === 0) {
            // Se não há dados, apenas destruir o gráfico existente, mas manter a aba visível
            if (window.statsChartAssuntoInstance) {
                try {
                    window.statsChartAssuntoInstance.destroy();
                } catch (e) {
                    // Ignorar erros ao destruir
                }
                window.statsChartAssuntoInstance = null;
            }
            // Mostrar mensagem de que os dados serão carregados ao clicar
            const canvas = document.getElementById('stats-chart-assunto');
            if (canvas) {
                const container = canvas.parentElement;
                if (container && !container.querySelector('.stats-placeholder')) {
                    container.innerHTML = '<div class="stats-placeholder text-center p-4"><p class="text-muted">Clique na aba para carregar as estatísticas</p></div>';
                }
            }
            return;
        }
        // Destruir gráfico existente apenas se já existir
        if (window.statsChartAssuntoInstance) {
            try {
                window.statsChartAssuntoInstance.destroy();
            } catch (e) {
                // Ignorar erros ao destruir
            }
            window.statsChartAssuntoInstance = null;
        }
        
        // Restaurar o canvas se foi substituído por placeholder
        const statsContainer = document.querySelector('#resumo-estatistico-assunto .canvas-container');
        if (statsContainer && statsContainer.querySelector('.stats-placeholder')) {
            statsContainer.innerHTML = '<canvas id="stats-chart-assunto" aria-label="Gráfico de resumo estatístico por assunto"></canvas>';
        }
        const canvas = document.getElementById('stats-chart-assunto');
        if (!canvas) {
            console.error('Canvas stats-chart-assunto não encontrado!');
            return;
        }
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('Não foi possível obter contexto 2D do canvas!');
            return;
        }
        
        // Ordenar por quantidade (decrescente) e depois alfabeticamente
        const sortedEntries = Object.entries(statsData).sort((a, b) => {
            if (b[1] !== a[1]) {
                return b[1] - a[1]; // Ordenar por quantidade (decrescente)
            }
            return a[0].localeCompare(b[0]); // Se quantidade igual, ordenar alfabeticamente
        });
        const labels = sortedEntries.map(([assunto]) => assunto);
        const dataValues = sortedEntries.map(([assunto, quantidade]) => quantidade);
        
        // Cores para os assuntos
        const coresAssuntos = [
            'rgba(68, 162, 210, 0.85)',   // Azul
            'rgba(255, 159, 64, 0.85)',   // Laranja
            'rgba(75, 192, 192, 0.85)',   // Verde-água
            'rgba(153, 102, 255, 0.85)',  // Roxo
            'rgba(54, 162, 235, 0.85)',   // Azul claro
            'rgba(255, 99, 132, 0.85)',   // Rosa
            'rgba(201, 203, 207, 0.85)',  // Cinza
            'rgba(255, 205, 86, 0.85)',   // Amarelo
            'rgba(50, 205, 50, 0.85)',    // Verde limão
            'rgba(255, 99, 71, 0.85)',    // Vermelho coral
            'rgba(138, 43, 226, 0.85)',   // Azul violeta
            'rgba(255, 140, 0, 0.85)',    // Laranja escuro
            'rgba(0, 191, 255, 0.85)',    // Azul céu
            'rgba(220, 20, 60, 0.85)',    // Vermelho carmesim
            'rgba(34, 139, 34, 0.85)',    // Verde floresta
            'rgba(148, 0, 211, 0.85)'     // Violeta
        ];
        
        // Criar array de cores para cada barra
        const backgroundColors = labels.map((assunto, index) => {
            return coresAssuntos[index % coresAssuntos.length];
        });
        const borderColors = backgroundColors.map(cor => cor.replace('0.85', '1'));

        // Calcular o total de matérias
        const totalMaterias = dataValues.reduce((sum, val) => sum + val, 0);
        
        // Calcular o valor máximo para definir o max do eixo X com margem
        let maxTotalValue = Math.max(...dataValues);
        const margin = maxTotalValue < 100 ? 40 : maxTotalValue < 500 ? Math.ceil(maxTotalValue * 0.25) : Math.ceil(maxTotalValue * 0.20);
        const maxXAxisValue = Math.ceil(maxTotalValue + margin);
        
        // Ajustar altura do container baseado no número de assuntos
        const container = canvas.parentElement;
        const numItems = labels.length;
        const minHeight = numItems <= 5 ? 300 : Math.min(300 + (numItems - 5) * 15, 450);
        container.style.minHeight = `${minHeight}px`;
        container.style.maxHeight = '450px';

        // Criar configurações baseadas no tipo de gráfico
        let chartConfig;
        if (tipoGraficoAssunto === 'pie') {
            // Para gráfico de pizza com muitos assuntos, agrupar assuntos pequenos em "Outros"
            let pieLabels = labels;
            let pieDataValues = dataValues;
            let pieBackgroundColors = backgroundColors;
            let pieBorderColors = borderColors;
            const threshold = 0.02; // 2% do total
            const minItemsToGroup = 8;
            
            if (numItems > minItemsToGroup) {
                const total = totalMaterias;
                const thresholdValue = total * threshold;
                const mainItems = [];
                const otherItems = [];
                let otherTotal = 0;
                
                labels.forEach((label, index) => {
                    if (dataValues[index] >= thresholdValue) {
                        mainItems.push({
                            label: label,
                            value: dataValues[index],
                            color: backgroundColors[index],
                            borderColor: borderColors[index]
                        });
                    } else {
                        otherTotal += dataValues[index];
                        otherItems.push(label);
                    }
                });
                
                if (otherTotal > 0 && otherItems.length > 0) {
                    mainItems.push({
                        label: `Outros (${otherItems.length})`,
                        value: otherTotal,
                        color: 'rgba(128, 128, 128, 0.85)',
                        borderColor: 'rgba(128, 128, 128, 1)'
                    });
                }
                
                pieLabels = mainItems.map(item => item.label);
                pieDataValues = mainItems.map(item => item.value);
                pieBackgroundColors = mainItems.map(item => item.color);
                pieBorderColors = mainItems.map(item => item.borderColor);
            }
            
            chartConfig = {
                type: 'pie',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        label: 'Quantidade',
                        data: pieDataValues,
                        backgroundColor: pieBackgroundColors,
                        borderColor: pieBorderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: numItems > 8 ? 'right' : 'right',
                            align: 'start',
                            labels: {
                                boxWidth: 15,
                                padding: numItems > 8 ? 8 : 12,
                                font: { size: numItems > 8 ? 10 : 11 },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor[i],
                                                lineWidth: 1,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: { 
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: numItems > 8 ? 10 : 11 },
                            formatter: function(value, context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return parseFloat(percentage) >= 3 ? percentage + '%' : '';
                            },
                            offset: numItems > 8 ? 5 : 8
                        },
                        title: {
                            display: true,
                            text: `Total: ${totalMaterias} ${totalMaterias === 1 ? 'matéria' : 'matérias'}`,
                            font: { size: 14, weight: 'bold' },
                            padding: { bottom: 10 }
                        }
                    },
                    animation: {
                        duration: 0
                    }
                },
                plugins: [ChartDataLabels]
            };
        } else {
            // Configuração para gráfico de barra
            chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade',
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        barThickness: 'flex',
                        maxBarThickness: 30,
                        minBarLength: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    clip: false,
                    layout: {
                        padding: {
                            right: 250,
                            top: 30,
                            bottom: 30,
                            left: 25
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `Quantidade: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#000',
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value) {
                                return value;
                            },
                            offset: 12,
                            clip: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: 'transparent',
                            borderWidth: 0,
                            borderRadius: 0
                        },
                        title: {
                            display: true,
                            text: `Total: ${totalMaterias} ${totalMaterias === 1 ? 'matéria' : 'matérias'}`,
                            font: { size: 14, weight: 'bold' },
                            padding: { bottom: 10 }
                        }
                    },
                    scales: { 
                        x: { 
                            beginAtZero: true,
                            max: maxXAxisValue,
                            ticks: {
                                stepSize: maxXAxisValue > 1000 ? Math.ceil(maxXAxisValue / 20) : (maxXAxisValue > 100 ? Math.ceil(maxXAxisValue / 10) : 1),
                                maxTicksLimit: 20,
                                autoSkip: true,
                                font: { size: 11 }
                            },
                            title: {
                                display: true,
                                text: 'Quantidade de Matérias',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawOnChartArea: true
                            }
                        },
                        y: {
                            ticks: {
                                display: true,
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0,
                                font: { size: 11 },
                                stepSize: 1,
                                maxTicksLimit: undefined
                            },
                            afterFit: function(scale) {
                                scale.width = Math.max(scale.width, 280);
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 0
                    }
                },
                plugins: [ChartDataLabels]
            };
        }
        
        window.statsChartAssuntoInstance = new Chart(ctx, chartConfig);
        
        // Armazenar dados para poder recriar o gráfico ao alternar tipo
        window.ultimoStatsAssuntoData = statsData;
        
        // Ajustar o container após renderização
        setTimeout(() => {
            if (window.statsChartAssuntoInstance && window.statsChartAssuntoInstance.canvas) {
                const canvas = window.statsChartAssuntoInstance.canvas;
                const container = canvas.parentElement;
                const parentContainer = container ? container.parentElement : null;
                
                if (container) {
                    container.style.width = '100%';
                    container.style.overflow = 'visible';
                    container.style.maxWidth = 'none';
                }
                if (parentContainer) {
                    parentContainer.style.width = '100%';
                    parentContainer.style.overflow = 'visible';
                    parentContainer.style.maxWidth = 'none';
                }
                
                canvas.style.maxWidth = 'none';
                window.statsChartAssuntoInstance.update('none');
                
                setTimeout(() => {
                    window.statsChartAssuntoInstance.resize();
                }, 50);
            }
        }, 300);
    }

    let statsCarregadas = false; // Flag para controlar se as estatísticas já foram carregadas
    
    async function carregarEstatisticas() {
        if (statsCarregadas) return; // Já foram carregadas, não precisa carregar novamente
        if (carregandoEstatisticas) {
            console.log('Estatísticas já estão sendo carregadas, aguardando...');
            return; // Já está carregando, não iniciar outra requisição
        }
        carregandoEstatisticas = true;
        
        const graficoTab = document.querySelector('#grafico-tab');
        const graficoAutorTab = document.querySelector('#grafico-autor-tab');
        if (!graficoTab || !graficoAutorTab) return;
        
        // Mostrar indicador de carregamento sem remover o canvas
        const graficoPane = document.querySelector('#grafico-pane');
        const graficoAutorPane = document.querySelector('#grafico-autor-pane');
        
        // Garantir que os containers existam
        if (graficoPane && !graficoPane.querySelector('#resumo-estatistico')) {
            graficoPane.innerHTML = '<div id="resumo-estatistico" class="p-3" style="position: relative;"><div class="canvas-container"><canvas id="stats-chart" aria-label="Gráfico de resumo estatístico das matérias"></canvas></div></div>';
        }
        if (graficoAutorPane && !graficoAutorPane.querySelector('#resumo-estatistico-autor')) {
            graficoAutorPane.innerHTML = '<div id="resumo-estatistico-autor" class="p-3" style="position: relative;"><div class="canvas-container"><canvas id="stats-chart-autor" aria-label="Gráfico de resumo estatístico por autor"></canvas></div></div>';
        }
        
        const graficoContainer = graficoPane ? graficoPane.querySelector('#resumo-estatistico') : null;
        const graficoAutorContainer = graficoAutorPane ? graficoAutorPane.querySelector('#resumo-estatistico-autor') : null;
        
        // Adicionar overlay de carregamento sem remover o conteúdo existente
        if (graficoContainer) {
            let loadingOverlay = graficoContainer.querySelector('.loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay position-absolute w-100 h-100 d-flex align-items-center justify-content-center';
                loadingOverlay.style.cssText = 'top: 0; left: 0; background: rgba(255,255,255,0.9); z-index: 10;';
                loadingOverlay.innerHTML = '<div class="text-center"><i class="fa fa-spinner fa-spin fa-2x"></i><p class="mt-2">Carregando estatísticas...</p></div>';
                if (!graficoContainer.style.position) {
                    graficoContainer.style.position = 'relative';
                }
                graficoContainer.appendChild(loadingOverlay);
            }
        }
        if (graficoAutorContainer) {
            let loadingOverlay = graficoAutorContainer.querySelector('.loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay position-absolute w-100 h-100 d-flex align-items-center justify-content-center';
                loadingOverlay.style.cssText = 'top: 0; left: 0; background: rgba(255,255,255,0.9); z-index: 10;';
                loadingOverlay.innerHTML = '<div class="text-center"><i class="fa fa-spinner fa-spin fa-2x"></i><p class="mt-2">Carregando estatísticas...</p></div>';
                if (!graficoAutorContainer.style.position) {
                    graficoAutorContainer.style.position = 'relative';
                }
                graficoAutorContainer.appendChild(loadingOverlay);
            }
        }
        
        try {
            const params = new URLSearchParams(new FormData(form));
            params.delete('daterange_input');
            params.set('calcular_estatisticas', '1');
            params.set('pagina', '1');
            params.set('itens_por_pagina', '1'); // Não precisamos dos dados, só das estatísticas
            
            const response = await fetchWithCache(`materias_legislativas_json?${params.toString()}`);
            
            console.log('Resposta das estatísticas:', response);
            console.log('Stats disponível:', response?.stats);
            console.log('Stats by author disponível:', response?.stats_by_author);
            
            // Remover TODOS os overlays de carregamento (pode haver múltiplos)
            const allLoadingOverlays = document.querySelectorAll('.loading-overlay');
            allLoadingOverlays.forEach(overlay => {
                overlay.remove();
                console.log('Overlay removido');
            });
            
            // Também remover qualquer placeholder que possa estar bloqueando
            const placeholders = document.querySelectorAll('.stats-placeholder');
            placeholders.forEach(placeholder => {
                placeholder.remove();
                console.log('Placeholder removido');
            });
            
            // Restaurar a estrutura HTML dos containers se foi substituída
            if (graficoPane && !graficoPane.querySelector('#resumo-estatistico')) {
                graficoPane.innerHTML = '<div id="resumo-estatistico" class="p-3"><div class="canvas-container"><canvas id="stats-chart" aria-label="Gráfico de resumo estatístico das matérias"></canvas></div></div>';
                console.log('Estrutura HTML do gráfico por tipo restaurada');
            }
            if (graficoAutorPane && !graficoAutorPane.querySelector('#resumo-estatistico-autor')) {
                graficoAutorPane.innerHTML = '<div id="resumo-estatistico-autor" class="p-3"><div class="canvas-container"><canvas id="stats-chart-autor" aria-label="Gráfico de resumo estatístico por autor"></canvas></div></div>';
                console.log('Estrutura HTML do gráfico por autor restaurada');
            }
            
            // Garantir que os canvas existam
            let statsChartCanvas = document.getElementById('stats-chart');
            if (!statsChartCanvas) {
                const statsContainer = document.querySelector('#resumo-estatistico .canvas-container');
                if (statsContainer) {
                    statsContainer.innerHTML = '<canvas id="stats-chart" aria-label="Gráfico de resumo estatístico das matérias"></canvas>';
                    statsChartCanvas = document.getElementById('stats-chart');
                    console.log('Canvas stats-chart criado');
                } else {
                    console.error('Container #resumo-estatistico .canvas-container não encontrado!');
                }
            }
            
            let statsChartAutorCanvas = document.getElementById('stats-chart-autor');
            if (!statsChartAutorCanvas) {
                const statsAutorContainer = document.querySelector('#resumo-estatistico-autor .canvas-container');
                if (statsAutorContainer) {
                    statsAutorContainer.innerHTML = '<canvas id="stats-chart-autor" aria-label="Gráfico de resumo estatístico por autor"></canvas>';
                    statsChartAutorCanvas = document.getElementById('stats-chart-autor');
                    console.log('Canvas stats-chart-autor criado');
                } else {
                    console.error('Container #resumo-estatistico-autor .canvas-container não encontrado!');
                }
            }
            
            // Garantir que não há overlays bloqueando antes de renderizar
            const remainingOverlays = document.querySelectorAll('.loading-overlay');
            remainingOverlays.forEach(overlay => {
                overlay.style.display = 'none';
                overlay.remove();
                console.log('Overlay remanescente removido');
            });
            
            // Renderizar imediatamente após garantir que os canvas existem
            const statsChartEl = document.getElementById('stats-chart');
            const statsChartAutorEl = document.getElementById('stats-chart-autor');
            
            console.log('Canvas stats-chart encontrado:', !!statsChartEl);
            console.log('Canvas stats-chart-autor encontrado:', !!statsChartAutorEl);
            
            if (response && response.stats && Object.keys(response.stats).length > 0) {
                console.log('Renderizando gráfico por tipo com dados:', response.stats);
                if (!statsChartEl) {
                    console.error('Canvas stats-chart não encontrado! Criando...');
                    const statsContainer = document.querySelector('#resumo-estatistico .canvas-container');
                    if (statsContainer) {
                        statsContainer.innerHTML = '<canvas id="stats-chart" aria-label="Gráfico de resumo estatístico das matérias"></canvas>';
                    }
                }
                try {
                    window.ultimoStatsData = response.stats; // Armazenar dados para alternância de gráfico
                    renderStatsChart(response.stats);
                    console.log('Gráfico por tipo renderizado com sucesso');
                    // Não chamar update() - o gráfico já foi criado com os dados corretos
                } catch (e) {
                    console.error('Erro ao renderizar gráfico por tipo:', e);
                }
            } else {
                console.log('Sem dados de stats para renderizar ou stats vazio');
            }
            
            if (response && response.stats_by_author && Object.keys(response.stats_by_author).length > 0) {
                console.log('Renderizando gráfico por autor com dados:', response.stats_by_author);
                if (!statsChartAutorEl) {
                    console.error('Canvas stats-chart-autor não encontrado! Criando...');
                    const statsAutorContainer = document.querySelector('#resumo-estatistico-autor .canvas-container');
                    if (statsAutorContainer) {
                        statsAutorContainer.innerHTML = '<canvas id="stats-chart-autor" aria-label="Gráfico de resumo estatístico por autor"></canvas>';
                    }
                }
                try {
                    renderStatsChartAutor(response.stats_by_author);
                    console.log('Gráfico por autor renderizado com sucesso');
                    // Não chamar update() aqui, pois o gráfico já foi criado com os dados
                } catch (e) {
                    console.error('Erro ao renderizar gráfico por autor:', e);
                }
            } else {
                console.log('Sem dados de stats_by_author para renderizar ou stats_by_author vazio');
            }
            
            if (response && response.stats_by_assunto && Object.keys(response.stats_by_assunto).length > 0) {
                console.log('Renderizando gráfico por assunto com dados:', response.stats_by_assunto);
                const statsAssuntoEl = document.getElementById('stats-chart-assunto');
                if (!statsAssuntoEl) {
                    // Canvas será criado dinamicamente se não existir
                    const graficoAssuntoPane = document.querySelector('#grafico-assunto-pane');
                    if (graficoAssuntoPane && !graficoAssuntoPane.querySelector('#resumo-estatistico-assunto')) {
                        graficoAssuntoPane.innerHTML = '<div id="resumo-estatistico-assunto" class="p-3"><div class="d-flex justify-content-end mb-2"><div class="btn-group" role="group" aria-label="Tipo de gráfico"><button type="button" class="btn btn-sm btn-outline-primary active" id="btn-grafico-barra-assunto" data-tipo="bar"><i class="fa fa-chart-bar me-1"></i>Barra</button><button type="button" class="btn btn-sm btn-outline-primary" id="btn-grafico-pizza-assunto" data-tipo="pie"><i class="fa fa-chart-pie me-1"></i>Pizza</button></div></div><div class="canvas-container"><canvas id="stats-chart-assunto" aria-label="Gráfico de resumo estatístico por assunto"></canvas></div></div>';
                    }
                    const statsAssuntoContainer = document.querySelector('#resumo-estatistico-assunto .canvas-container');
                    if (statsAssuntoContainer) {
                        statsAssuntoContainer.innerHTML = '<canvas id="stats-chart-assunto" aria-label="Gráfico de resumo estatístico por assunto"></canvas>';
                    }
                }
                try {
                    renderStatsChartAssunto(response.stats_by_assunto);
                    console.log('Gráfico por assunto renderizado com sucesso');
                } catch (e) {
                    console.error('Erro ao renderizar gráfico por assunto:', e);
                }
            } else {
                console.log('Sem dados de stats_by_assunto para renderizar ou stats_by_assunto vazio');
            }
            
            statsCarregadas = true;
            carregandoEstatisticas = false;
        } catch (error) {
            console.error('Erro ao carregar estatísticas:', error);
            carregandoEstatisticas = false;
            // Remover overlay de carregamento
            if (graficoContainer) {
                const loadingOverlay = graficoContainer.querySelector('.loading-overlay');
                if (loadingOverlay) loadingOverlay.remove();
            }
            if (graficoAutorContainer) {
                const loadingOverlay = graficoAutorContainer.querySelector('.loading-overlay');
                if (loadingOverlay) loadingOverlay.remove();
            }
            // Mostrar mensagem de erro
            if (graficoContainer) {
                graficoContainer.innerHTML = '<div class="alert alert-danger text-center p-4">Erro ao carregar estatísticas.</div>';
            }
            if (graficoAutorContainer) {
                graficoAutorContainer.innerHTML = '<div class="alert alert-danger text-center p-4">Erro ao carregar estatísticas.</div>';
            }
        }
    }
    
    function scrollParaResultados() {
        // Considera header fixo (#page-topbar, 80px) e .topnav (54.75px) se visível
        const header = document.getElementById('page-topbar');
        const topnav = document.querySelector('.topnav');
        let offset = 0;
        if (header) offset += header.offsetHeight || 80;
        if (topnav && window.getComputedStyle(topnav).display !== 'none') offset += topnav.offsetHeight || 54.75;
        const res = resultadosDiv.getBoundingClientRect().top + window.scrollY - offset - 15;
        window.scrollTo({ top: res, behavior: 'smooth' });
    }

    function applyViewMode(mode) {
        if (!ultimoResultadoMaterias) return;
        currentViewMode = mode;
        localStorage.setItem('materiaViewMode', mode);
        renderizarResultados(ultimoResultadoMaterias);
        setTimeout(scrollParaResultados, 150);
    }

    function handleExportClick(btn) {
        const params = new URLSearchParams(new FormData(form));
        params.set('formato', btn.dataset.format);
        params.set('paginar_exportacao', btn.dataset.paginarExportacao || '0');
        if (btn.dataset.paginarExportacao === '1') {
            params.set('pagina', document.getElementById('pagina').value || '1');
            params.set('itens_por_pagina', itensPorPaginaSelect ? itensPorPaginaSelect.value : '12');
        } else {
            params.delete('pagina');
            params.delete('itens_por_pagina');
        }
        const exportUrl = `${form.getAttribute('action')}?${params.toString()}`;
        window.open(exportUrl, '_blank');
    }

    async function handleDocumentoClick(badge) {
        const codMateria = badge.dataset.codMateria;
        const tipo = badge.dataset.tipo;
        if (!codMateria || !tipo) return;
        
        const modal = new bootstrap.Modal(document.getElementById('modalDocumentos'));
        const modalBody = document.getElementById('modalDocumentosBody');
        const modalTitle = document.getElementById('modalDocumentosLabel');
        
        const tipoTitulos = {
            'substitutivos': 'Substitutivos',
            'emendas': 'Emendas',
            'pareceres': 'Pareceres de Comissão',
            'documentos_acessorios': 'Documentos Acessórios'
        };
        
        // Obter identificação da matéria
        const tipoMateria = badge.dataset.tipoMateria || '';
        const numMateria = badge.dataset.numMateria || '';
        const anoMateria = badge.dataset.anoMateria || '';
        const siglaMateria = badge.dataset.siglaMateria || '';
        
        // Formatar identificação: sigla número/ano (ex: PLC 10/2015)
        let identificacaoMateria = '';
        if (numMateria && anoMateria) {
            let sigla = siglaMateria;
            
            // Se não tiver sigla, tentar extrair do tipo
            if (!sigla && tipoMateria) {
                // Extrair sigla do tipo (ex: "Projeto de Lei Complementar" -> "PLC")
                // Pegar primeira letra de palavras significativas (mais de 2 caracteres, começando com maiúscula)
                const palavras = tipoMateria.split(' ').filter(p => p.length > 2 && /^[A-Z]/.test(p));
                sigla = palavras.map(p => p[0]).join('').substring(0, 5) || tipoMateria.substring(0, 10);
            }
            
            identificacaoMateria = sigla 
                ? `${sigla} ${numMateria}/${anoMateria}`
                : `${numMateria}/${anoMateria}`;
        }
        
        // Montar título do modal
        const tituloTipo = tipoTitulos[tipo] || 'Documentos';
        modalTitle.textContent = identificacaoMateria 
            ? `${tituloTipo} - ${identificacaoMateria}`
            : tituloTipo;
        modalBody.innerHTML = '<div class="text-center p-5"><i class="fa fa-spinner fa-spin fa-2x"></i><p class="mt-2">Carregando documentos...</p></div>';
        modal.show();
        
        try {
            const data = await fetchWithCache(`materia_documentos_json?cod_materia=${codMateria}&tipo=${tipo}`);
            const documentos = data[tipo] || [];
            
            if (documentos.length === 0) {
                modalBody.innerHTML = `<p class="text-center text-muted">Nenhum ${tipoTitulos[tipo].toLowerCase()} encontrado.</p>`;
                return;
            }
            
            let html = '<ul class="list-group">';
            documentos.forEach(doc => {
                let titulo = '';
                let subtitulo = '';
                
                if (tipo === 'substitutivos') {
                    titulo = `Substitutivo nº ${doc.num_substitutivo}`;
                    if (doc.autores) subtitulo = `Autoria: ${doc.autores}`;
                    if (doc.dat_apresentacao) subtitulo += (subtitulo ? ' - ' : '') + `Apresentado em ${doc.dat_apresentacao}`;
                    if (doc.txt_ementa) subtitulo += (subtitulo ? ' - ' : '') + doc.txt_ementa.substring(0, 100) + (doc.txt_ementa.length > 100 ? '...' : '');
                } else if (tipo === 'emendas') {
                    titulo = `${doc.des_tipo_emenda || 'Emenda'} nº ${doc.num_emenda || doc.cod_emenda}`;
                    if (doc.autores) subtitulo = `Autoria: ${doc.autores}`;
                    if (doc.dat_apresentacao) subtitulo += (subtitulo ? ' - ' : '') + `Apresentada em ${doc.dat_apresentacao}`;
                } else if (tipo === 'pareceres') {
                    titulo = `Parecer ${doc.comissao || ''} nº ${doc.num_parecer}/${doc.ano_parecer}`.trim();
                    const partesSubtitulo = [];
                    if (doc.relator) partesSubtitulo.push(`<i class="fa fa-user me-1"></i><strong>Relator:</strong> ${sanitizeHTML(doc.relator)}`);
                    if (doc.des_fim_relatoria) partesSubtitulo.push(`<i class="fa fa-check-circle me-1"></i><strong>Resultado:</strong> ${sanitizeHTML(doc.des_fim_relatoria)}`);
                    subtitulo = partesSubtitulo.join(' <span class="text-muted">|</span> ');
                } else if (tipo === 'documentos_acessorios') {
                    titulo = doc.nom_documento || doc.des_tipo_documento || 'Documento';
                    const partesSubtitulo = [];
                    if (doc.dat_documento) {
                        partesSubtitulo.push(`<i class="fa fa-calendar-alt me-1"></i>${sanitizeHTML(doc.dat_documento)}`);
                    }
                    if (doc.nom_autor_documento) {
                        partesSubtitulo.push(`<i class="fa fa-user-edit me-1"></i><strong>Autoria:</strong> ${sanitizeHTML(doc.nom_autor_documento)}`);
                    }
                    subtitulo = partesSubtitulo.join(' <span class="text-muted">|</span> ');
                }
                
                html += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                ${doc.url ? `<a href="${doc.url}" target="_blank" class="text-decoration-none">` : '<span>'}
                                <i class="fa fa-file-pdf text-danger me-2"></i>
                                <strong>${sanitizeHTML(titulo)}</strong>
                                ${doc.url ? '</a>' : '</span>'}
                                ${subtitulo ? `<div class="mt-2"><small class="text-muted">${subtitulo}</small></div>` : ''}
                            </div>
                            ${doc.url ? '<i class="fa fa-external-link-alt text-muted ms-2"></i>' : ''}
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            modalBody.innerHTML = html;
        } catch (error) {
            console.error('Erro ao carregar documentos:', error);
            modalBody.innerHTML = `<div class="alert alert-danger">Erro ao carregar documentos: ${sanitizeHTML(error.message)}</div>`;
        }
    }

    function handleLimparClick() {
        form.reset();
        document.querySelectorAll('select').forEach(el => {
            if (el.tomselect) {
                el.tomselect.clear();
                el.tomselect.sync();
            } else {
                el.value = '';
            }
        });
        if (daterangePicker) daterangePicker.clear();
        if (typeof daterangePublicacaoPicker !== 'undefined' && daterangePublicacaoPicker) daterangePublicacaoPicker.clear();
        document.getElementById('dat_apresentacao_hidden').value = '';
        document.getElementById('dat_apresentacao2_hidden').value = '';
        document.getElementById('dat_publicacao_hidden').value = '';
        document.getElementById('dat_publicacao2_hidden').value = '';
        ordemCampoInput.value = '';
        ordemDirecaoInput.value = '';
        document.getElementById('pagina').value = '1';
        containerPrincipal.classList.add('d-none');
        containerPrincipal.classList.remove('d-block');
        resumoFiltrosDiv.classList.add('d-none');
        resumoFiltrosDiv.classList.remove('d-block');
        limparBtn.classList.add('d-none');
        limparBtn.classList.remove('d-inline-block');
        const btnToggleFiltros = document.getElementById('btn-toggle-filtros');
        if (btnToggleFiltros) {
            btnToggleFiltros.classList.add('d-none');
        }
        showInitialMessage();
        if (filterClearedToast) filterClearedToast.show();
        if (bsCollapseFiltros && !document.getElementById('filtro-container').classList.contains('show')) {
            bsCollapseFiltros.show();
        }
        if (bsCollapseAdvancedSearch && advancedSearchDiv.classList.contains('show')) {
            bsCollapseAdvancedSearch.hide();
        }
        contarFiltrosAtivos();
        mostrarResumoFiltros(new FormData(form));
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    function handleRemoveFilter(event) {
        event.stopPropagation();
        const badge = event.target.closest('.filter-badge');
        if (!badge) return;
        const keyToRemove = badge.dataset.filterKey;
        const valueToRemove = badge.dataset.filterValue;
        const element = form.elements[keyToRemove];

        if ((keyToRemove === 'tip_id_basica' || keyToRemove === 'lst_assunto_materia') && element && element.tomselect) {
            let atual = element.tomselect.getValue();
            if (Array.isArray(atual)) {
                atual = atual.filter(v => v != valueToRemove);
            } else {
                atual = atual == valueToRemove ? [] : [atual];
            }
            element.tomselect.setValue(atual);

            setTimeout(() => {
                contarFiltrosAtivos();
                mostrarResumoFiltros(new FormData(form));
                if (!haFiltrosAtivos()) {
                    handleLimparClick();
                } else {
                    realizarBusca(1);
                }
            }, 10);
            return;
        }

        if (element) {
            if (element.tomselect) {
                if (element.tomselect.isMultiple) {
                    const valuesToKeep = element.tomselect.getValue().filter(val => !valueToRemove.split(',').includes(val.toString()));
                    element.tomselect.setValue(valuesToKeep);
                } else {
                    element.tomselect.clear();
                }
            } else if (element.type === 'checkbox') {
                element.checked = false;
            } else if (element.tagName === 'SELECT') {
                element.value = '';
            } else if (element.type === 'text' || element.type === 'number') {
                element.value = '';
            }
        }
        if (keyToRemove === 'dat_apresentacao') {
            if (typeof daterangePicker !== 'undefined' && daterangePicker) {
                daterangePicker.clear();
            }
            document.getElementById('dat_apresentacao_hidden').value = '';
            document.getElementById('dat_apresentacao2_hidden').value = '';
        }
        if (keyToRemove === 'dat_publicacao') {
            if (typeof daterangePublicacaoPicker !== 'undefined' && daterangePublicacaoPicker) {
                daterangePublicacaoPicker.clear();
            }
            document.getElementById('dat_publicacao_hidden').value = '';
            document.getElementById('dat_publicacao2_hidden').value = '';
        }

        setTimeout(() => {
            contarFiltrosAtivos();
            mostrarResumoFiltros(new FormData(form));
            if (!haFiltrosAtivos()) {
                handleLimparClick();
            } else {
                realizarBusca(1);
            }
        }, 10);
    }

    function handleDatePreset(btn) {
        const preset = btn.dataset.preset;
        if (!preset) return;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let startDate, endDate;
        switch (preset) {
            case 'hoje':
                startDate = today;
                endDate = today;
                break;
            case 'semana':
                endDate = new Date(today);
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 6);
                break;
            case 'mes_atual':
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                break;
            case 'mes_passado':
                const prevMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                startDate = new Date(prevMonth.getFullYear(), prevMonth.getMonth(), 1);
                endDate = new Date(prevMonth.getFullYear(), prevMonth.getMonth() + 1, 0);
                break;
        }
        if (startDate && endDate) {
            daterangePicker.setDate([startDate, endDate], true);
            const onCloseCallback = daterangePicker.config.onClose[0];
            if (onCloseCallback) {
                onCloseCallback(daterangePicker.selectedDates, '', daterangePicker);
            }
        }
    }

    function actualizarURL(params) {
        const queryString = params.toString();
        const newUrl = queryString ? `${window.location.pathname}?${queryString}` : window.location.pathname;
        window.history.pushState({ path: newUrl }, '', newUrl);
    }

    function contarFiltrosAtivos() {
        let count = 0;
        // Campos que devem ser ignorados (sistema e ordenação)
        const camposIgnorados = ['formato', 'rd_ordem', 'pagina', 'ordem_campo', 'ordem_direcao', 'itens_por_pagina'];
        // Campos básicos que NÃO devem ser contados como filtros avançados
        const camposBasicos = [
            'tip_id_basica',      // Tipo de Matéria
            'num_ident_basica',   // Número
            'ano_ident_basica',   // Ano
            'cod_autor',           // Autoria (básico)
            'chk_coautor',         // Checkbox de coautor
            'chk_primeiro_autor',  // Checkbox de primeiro autor
            'des_assunto',         // Assunto ou Ementa
            'chk_textual'          // Checkbox de pesquisa textual
        ];
        
        for (let el of form.elements) {
            if (!el.name || camposIgnorados.includes(el.name) || camposBasicos.includes(el.name)) continue;
            
            // Verificar campos TomSelect (selects múltiplos)
            if (el.tomselect && el.tomselect.getValue && el.tomselect.getValue().length > 0) { 
                count++; 
                continue; 
            }
            
            // Verificar checkboxes
            if (el.type === 'checkbox' && el.checked) { 
                count++; 
                continue; 
            }
            
            // Verificar selects normais (exceto o valor padrão vazio)
            if (el.tagName === 'SELECT' && el.value !== '') { 
                count++; 
                continue; 
            }
            
            // Verificar inputs de texto e número
            if ((el.type === 'text' || el.type === 'number') && el.value.trim() !== '') { 
                count++; 
                continue; 
            }
        }
        
        // Contar datas de apresentação (filtro avançado)
        const dataApres1 = document.getElementById('dat_apresentacao_hidden')?.value;
        const dataApres2 = document.getElementById('dat_apresentacao2_hidden')?.value;
        if (dataApres1 && dataApres2) count++;
        
        // Contar datas de publicação (filtro avançado)
        const dataPub1 = document.getElementById('dat_publicacao_hidden')?.value;
        const dataPub2 = document.getElementById('dat_publicacao2_hidden')?.value;
        if (dataPub1 && dataPub2) count++;
        
        badgeFiltros.textContent = count;
        let newTitle = count > 0 ? `${count} filtro(s) avançado(s) ativo(s)` : "Nenhum filtro avançado ativo";
        const tooltipInstance = bootstrap.Tooltip.getInstance(badgeFiltros);
        if (tooltipInstance) {
            tooltipInstance.setContent({ '.tooltip-inner': newTitle });
        } else {
            new bootstrap.Tooltip(badgeFiltros, { title: newTitle });
        }
    }

    function mostrarResumoFiltros(formData) {
        let filtrosAtivosBadges = [];
        const labels = {
            'tip_id_basica': 'Tipo', // ...
            'num_ident_basica': 'Número', 'ano_ident_basica': 'Ano',
            'des_assunto': 'Assunto/Ementa', 'lst_assunto_materia': 'Assunto/Classificação', 'num_protocolo': 'Protocolo', 'num_processo': 'Processo',
            'cod_autor': 'Autoria', 'tip_autor': 'Tipo Autor', 'chk_coautor': 'Coautor', 'chk_primeiro_autor': '1º Autor',
            'cod_relator': 'Relator', 'cod_status': 'Situação', 'cod_unid_tramitacao': 'Localização',
            'cod_unid_tramitacao2': 'Tramitou Em', 'dat_apresentacao': 'Data Apres.',
            'dat_publicacao': 'Data Publicação', 'ind_tramitacao': 'Em Tramitação', 'chk_textual': 'Pesquisa Textual'
        };
        const activeParams = new URLSearchParams(formData);

        // BADGES INDIVIDUAIS PARA TIPO DE MATÉRIA
        const tiposSelect = form.elements['tip_id_basica'];
        if (tiposSelect && tiposSelect.tomselect && tiposSelect.tomselect.items.length > 0) {
            tiposSelect.tomselect.items.forEach(val => {
                let label = tiposSelect.tomselect.options[val]?.text || val;
                filtrosAtivosBadges.push(
                    `<span class="filter-badge" data-filter-key="tip_id_basica" data-filter-value="${val}">
                        <strong>${labels['tip_id_basica']}</strong>: ${sanitizeHTML(label)}
                        <button type="button" class="btn-close" aria-label="Remover filtro Tipo"></button>
                    </span>`
                );
            });
        }

        // BADGES INDIVIDUAIS PARA ASSUNTO/CLASSIFICAÇÃO
        const assuntoSelect = form.elements['lst_assunto_materia'];
        if (assuntoSelect && assuntoSelect.tomselect && assuntoSelect.tomselect.items.length > 0) {
            assuntoSelect.tomselect.items.forEach(val => {
                let label = assuntoSelect.tomselect.options[val]?.descricao || val;
                filtrosAtivosBadges.push(
                    `<span class="filter-badge" data-filter-key="lst_assunto_materia" data-filter-value="${val}">
                        <strong>${labels['lst_assunto_materia']}</strong>: ${sanitizeHTML(label)}
                        <button type="button" class="btn-close" aria-label="Remover filtro Assunto"></button>
                    </span>`
                );
            });
        }

        // Outros campos (exceto tip_id_basica e lst_assunto_materia)
        Object.keys(labels).forEach(key => {
            if (key === 'tip_id_basica' || key === 'lst_assunto_materia') return;
            let valorExibido = '', originalValue = '';
            if (key === 'dat_apresentacao') {
                const startDate = activeParams.get('dat_apresentacao');
                const endDate = activeParams.get('dat_apresentacao2');
                if (startDate && endDate) {
                    valorExibido = `${startDate} a ${endDate}`;
                    originalValue = `${startDate},${endDate}`;
                }
            } else if (key === 'dat_publicacao') {
                const startDate = activeParams.get('dat_publicacao');
                const endDate = activeParams.get('dat_publicacao2');
                if (startDate && endDate) {
                    valorExibido = `${startDate} a ${endDate}`;
                    originalValue = `${startDate},${endDate}`;
                }
            } else if (key === 'chk_coautor' || key === 'chk_primeiro_autor') {
                const el = form.elements[key];
                if (el && el.checked) {
                    valorExibido = 'Sim';
                    originalValue = '1';
                }
            } else if (key !== 'dat_apresentacao2' && key !== 'dat_publicacao2') {
                const el = form.elements[key];
                if (el) {
                    if (el.tomselect && el.tomselect.items.length > 0) {
                        valorExibido = el.tomselect.items.map(item => el.tomselect.options[item].text).join(', ');
                        originalValue = el.tomselect.getValue();
                    } else if (el.type === 'checkbox' && el.checked) {
                        valorExibido = 'Sim';
                        originalValue = '1';
                    } else if (el.tagName === 'SELECT' && el.value !== '' && el.options[el.selectedIndex]) {
                        valorExibido = el.options[el.selectedIndex].text;
                        originalValue = el.value;
                    } else if ((el.type === 'text' || el.type === 'number') && el.value.trim() !== '') {
                        valorExibido = el.value.trim();
                        originalValue = el.value.trim();
                    }
                }
            }
            if (valorExibido) {
                filtrosAtivosBadges.push(
                    `<span class="filter-badge" data-filter-key="${key}" data-filter-value="${Array.isArray(originalValue) ? originalValue.join(',') : originalValue}">
                        <strong>${labels[key]}</strong>: ${sanitizeHTML(valorExibido)}
                        <button type="button" class="btn-close" aria-label="Remover filtro ${labels[key]}"></button>
                    </span>`
                );
            }
        });

        if (filtrosAtivosBadges.length > 0) {
            resumoFiltrosDiv.classList.remove('d-none');
            resumoFiltrosDiv.classList.add('d-block');
            resumoFiltrosDiv.innerHTML = `
                <div class="alert alert-info py-2" role="status">
                    <strong>Filtros Ativos:</strong> ${filtrosAtivosBadges.join('')}
                </div>`;
        } else {
            resumoFiltrosDiv.classList.add('d-none');
            resumoFiltrosDiv.classList.remove('d-block');
            resumoFiltrosDiv.innerHTML = '';
        }
    }

    function popularFormPelaURL() {
        const params = new URLSearchParams(window.location.search);
        if (!params.toString()) return;
        const uniqueKeys = [...new Set(params.keys())];
        uniqueKeys.forEach(key => {
            const el = form.elements[key];
            if (el) {
                if (el.tomselect) {
                    const allValues = params.getAll(key);
                    el.tomselect.setValue(allValues, true);
                }
                else if (el.type === 'radio') {
                    const radioWithValue = document.querySelector(`input[name="${key}"][value="${params.get(key)}"]`);
                    if (radioWithValue) radioWithValue.checked = true;
                }
                else if (el.type === 'checkbox') {
                    el.checked = (params.get(key) === '1');
                }
                else {
                    el.value = params.get(key);
                }
            }
        });
        const startDateParam = params.get('dat_apresentacao');
        const endDateParam = params.get('dat_apresentacao2');
        if (startDateParam || endDateParam) {
            daterangePicker.setDate([startDateParam, endDateParam], false);
            document.getElementById('dat_apresentacao_hidden').value = startDateParam || '';
            document.getElementById('dat_apresentacao2_hidden').value = endDateParam || '';
        }
        const startDatePubParam = params.get('dat_publicacao');
        const endDatePubParam = params.get('dat_publicacao2');
        if (startDatePubParam || endDatePubParam) {
            if (typeof daterangePublicacaoPicker !== 'undefined' && daterangePublicacaoPicker) {
                daterangePublicacaoPicker.setDate([startDatePubParam, endDatePubParam], false);
            }
            document.getElementById('dat_publicacao_hidden').value = startDatePubParam || '';
            document.getElementById('dat_publicacao2_hidden').value = endDatePubParam || '';
        }
        ordemCampoInput.value = params.get('ordem_campo') || '';
        ordemDirecaoInput.value = params.get('ordem_direcao') || '';
        const hasAdvancedFilterInURL = ['num_protocolo', 'num_processo', 'cod_status', 'cod_unid_tramitacao', 
                                      'cod_unid_tramitacao2', 'ind_tramitacao', 'chk_textual'].some(field => params.has(field)) || 
                                      startDateParam || endDateParam;
        if (hasAdvancedFilterInURL) {
            carregarFiltrosAvancados();
        }
        contarFiltrosAtivos();
        realizarBusca(
           parseInt(params.get('pagina') || '1'),  
           params.get('itens_por_pagina') || '12'
        );
    }

    advancedSearchDiv.addEventListener('show.bs.collapse', carregarFiltrosAvancados, { once: true });

    async function carregarTiposMateria() {
        const selectElement = document.getElementById('tip_id_basica');
        if (!selectElement) return;
        
        // Verificar se já existe uma instância TomSelect
        let tomselect = selectElement.tomselect;
        if (!tomselect) {
            selectElement.dataset.tomselect = true;
            tomselect = new TomSelect(selectElement, {
                plugins: ['remove_button'],
                placeholder: 'Carregando tipos de matéria...',
                maxItems: null,
                maxOptions: null,
                // Garantir estilo consistente
                render: {
                    option: function(data, escape) {
                        return '<div>' + escape(data.text || '') + '</div>';
                    },
                    item: function(data, escape) {
                        return '<div>' + escape(data.text || '') + '</div>';
                    }
                },
                onInitialize: function() { this.wrapper.dataset.tomselectInitialized = true; }
            });
        }
        
        tomselect.disable();
        try {
            const data = await fetchWithCache('tipos_materia_json');
            
            tomselect.clear();
            tomselect.clearOptions();
            
            // Adicionar grupos e opções
            if (data.principais && data.principais.length) {
                tomselect.addOptionGroup('principais', { label: 'Matérias Principais' });
                data.principais.forEach(item => tomselect.addOption({ 
                    value: item.id, 
                    text: item.text, 
                    optgroup: 'principais' 
                }));
            }
            
            // Matérias Acessórias (inclui tipos acessórios cadastrados + Emenda e Substitutivo)
            if (data.acessorias && data.acessorias.length) {
                tomselect.addOptionGroup('acessorias', { label: 'Matérias Acessórias' });
                // Usar Set para evitar duplicação por valor
                const valoresAdicionados = new Set();
                data.acessorias.forEach(item => {
                    // Verificar se o valor já foi adicionado (evitar duplicação)
                    if (!valoresAdicionados.has(item.id)) {
                        tomselect.addOption({ 
                            value: item.id, 
                            text: item.text, 
                            optgroup: 'acessorias' 
                        });
                        valoresAdicionados.add(item.id);
                    }
                });
            }
            
            tomselect.enable();
            tomselect.settings.placeholder = 'Selecione um ou mais tipos...';
            tomselect.sync();
        } catch (error) {
            console.error("Falha ao carregar Tipos de Matéria:", error);
            tomselect.settings.placeholder = 'Erro ao carregar tipos!';
            tomselect.sync();
        }
    }

    async function carregarSelectSimples(endpoint, selector, placeholder) {
        const selectElement = document.querySelector(selector);
        if (!selectElement) return;
        
        // Detectar qual campo usar baseado no endpoint
        let labelField = 'text';
        let searchField = 'text';
        if (endpoint.includes('assuntos_materia') || endpoint.includes('assuntos_norma')) {
            labelField = 'descricao';
            searchField = 'descricao';
        }
        
        const tomselect = new TomSelect(selectElement, {
            valueField: 'id',
            labelField: labelField,
            searchField: searchField,
            placeholder: 'Carregando...',
            plugins: ['clear_button'],
            maxOptions: null,
            // Garantir estilo consistente com selects múltiplos
            render: {
                option: function(data, escape) {
                    // Usar ambos os campos como fallback (descricao para assuntos, text para outros)
                    const label = data.descricao || data.text || '';
                    return '<div>' + escape(label) + '</div>';
                },
                item: function(data, escape) {
                    // Usar ambos os campos como fallback (descricao para assuntos, text para outros)
                    const label = data.descricao || data.text || '';
                    return '<div>' + escape(label) + '</div>';
                }
            }
        });
        tomselect.disable();
        try {
            const data = await fetchWithCache(endpoint);
            // Verificar o primeiro item para confirmar o campo correto
            if (data && data.length > 0) {
                const firstItem = data[0];
                // Se o campo esperado não existir, ajustar dinamicamente
                if (!firstItem[labelField] && firstItem.descricao) {
                    labelField = 'descricao';
                    searchField = 'descricao';
                    tomselect.settings.labelField = labelField;
                    tomselect.settings.searchField = searchField;
                } else if (!firstItem[labelField] && firstItem.text) {
                    labelField = 'text';
                    searchField = 'text';
                    tomselect.settings.labelField = labelField;
                    tomselect.settings.searchField = searchField;
                }
            }
            tomselect.clear();
            tomselect.clearOptions();
            tomselect.addOptions(data);
            tomselect.enable();
            tomselect.settings.placeholder = placeholder;
            tomselect.sync();
        } catch (error) {
            console.error(`Falha ao carregar dados de ${endpoint}:`, error);
            tomselect.settings.placeholder = 'Erro ao carregar!';
            tomselect.sync();
        }
    }
    
    async function carregarSelectMultiplo(endpoint, selector, placeholder) {
        const selectElement = document.querySelector(selector);
        if (!selectElement) return;
        const tomselect = new TomSelect(selectElement, {
            valueField: 'id',
            labelField: 'descricao',
            searchField: 'descricao',
            placeholder: 'Carregando...',
            plugins: ['clear_button', 'remove_button'],
            maxOptions: null,
            // Garantir estilo consistente
            render: {
                option: function(data, escape) {
                    return '<div>' + escape(data.descricao || data.text || '') + '</div>';
                },
                item: function(data, escape) {
                    return '<div>' + escape(data.descricao || data.text || '') + '</div>';
                }
            }
        });
        tomselect.disable();
        try {
            const data = await fetchWithCache(endpoint);
            tomselect.clear();
            tomselect.clearOptions();
            tomselect.addOptions(data);
            tomselect.enable();
            tomselect.settings.placeholder = placeholder;
            tomselect.sync();
        } catch (error) {
            console.error(`Falha ao carregar dados de ${endpoint}:`, error);
            tomselect.settings.placeholder = 'Erro ao carregar!';
            tomselect.sync();
        }
    }

    async function carregarTiposAutor() {
        const selectElement = document.getElementById('tip_autor');
        if (!selectElement) return;
        const tomselect = new TomSelect(selectElement, {
            valueField: 'id',
            labelField: 'text',
            searchField: 'text',
            placeholder: 'Carregando tipos de autor...',
            plugins: ['clear_button'],
            maxOptions: null,
            // Garantir estilo consistente
            render: {
                option: function(data, escape) {
                    return '<div>' + escape(data.text || '') + '</div>';
                },
                item: function(data, escape) {
                    return '<div>' + escape(data.text || '') + '</div>';
                }
            }
        });
        tomselect.disable();
        try {
            const data = await fetchWithCache('tipos_autor_json');
            tomselect.clear();
            tomselect.clearOptions();
            if (Array.isArray(data) && data.length > 0) {
                tomselect.addOptions(data);
            }
            tomselect.enable();
            tomselect.settings.placeholder = 'Selecione um tipo de autor...';
            tomselect.sync();
        } catch (error) {
            console.error("Falha ao carregar Tipos de Autor:", error);
            tomselect.settings.placeholder = 'Erro ao carregar!';
            tomselect.enable();
            tomselect.sync();
        }
    }
    
    async function carregarRelatores() {
        // Relatores são apenas parlamentares
        await carregarSelectSimples('relatores_json', '#cod_relator', 'Selecione um relator...');
    }

    function carregarFiltrosAvancados() {
        if (advancedFiltersLoaded) return;
        carregarSelectSimples('status_tramitacao_json', '#cod_status', 'Selecione uma situação...');
        carregarSelectSimples('unidades_tramitacao_json', '#cod_unid_tramitacao', 'Selecione a localização atual...');
        carregarSelectSimples('unidades_tramitacao_json', '#cod_unid_tramitacao2', 'Selecione onde tramitou...');
        carregarTiposAutor();
        carregarRelatores();
        advancedFiltersLoaded = true;
    }

    function highlightText(text, query) {
        if (!query || !text) return text;
        const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        
        // Função para normalizar acentos (remove acentos para comparação)
        const normalizeAccents = (str) => {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        };
        
        // Lista de stop words para filtrar antes do highlight (mesmas do backend)
        const stopWords = new Set([
            'a', 'à', 'ao', 'aos', 'as', 'da', 'das', 'de', 'do', 'dos', 'e', 'em', 'na', 'nas', 'no', 'nos',
            'o', 'os', 'um', 'uma', 'uns', 'umas',
            'para', 'por', 'com', 'sem', 'sob', 'sobre', 'entre', 'contra', 'ate', 'desde', 'perante', 'mediante',
            'que', 'se', 'me', 'te', 'nos', 'vos', 'lhe', 'lhes', 'este', 'esta', 'estes', 'estas',
            'esse', 'essa', 'esses', 'essas', 'aquele', 'aquela', 'aqueles', 'aquelas',
            'ou', 'mas', 'porem', 'todavia', 'contudo', 'entretanto', 'logo', 'portanto', 'assim', 'entao',
            'tambem', 'tampouco', 'nao', 'nem'
        ]);
        
        // Filtrar stop words e palavras muito curtas (1-2 caracteres)
        // Guardar termos originais (com acentos) para usar no highlight
        const termsOriginal = query.split(/\s+/)
            .filter(Boolean)
            .filter(term => term.length > 2 && !stopWords.has(normalizeAccents(term.toLowerCase())));
            
        if (termsOriginal.length === 0) return text;
        
        // Para cada termo, criar um padrão regex que corresponde ao termo exato (com acentos)
        // Usar uma abordagem que funciona melhor com caracteres acentuados
        // Em vez de \b (que não funciona bem com acentos), usar lookahead/lookbehind ou substituição manual
        let resultText = text;
        
        // Processar termos do maior para o menor para evitar sobreposição
        const sortedTerms = [...termsOriginal].sort((a, b) => b.length - a.length);
        
        // Processar cada termo e destacar, considerando variações de acentos
        // Normalizar termos de busca para comparação, mas destacar texto original
        sortedTerms.forEach(term => {
            const termNormalized = normalizeAccents(term.toLowerCase());
            
            // Processar texto palavra por palavra, normalizando para comparar
            // Dividir texto preservando delimitadores
            const parts = resultText.split(/(<[^>]*>|[a-zA-Z\u00C0-\u017F]+|[^a-zA-Z\u00C0-\u017F]+)/);
            const processedParts = parts.map(part => {
                // Se já está dentro de uma tag mark ou é uma tag HTML, não processar
                if (part.startsWith('<') || part.includes('<mark>') || part.includes('</mark>')) {
                    return part;
                }
                
                // Se é uma palavra (contém letras)
                if (part.match(/^[a-zA-Z\u00C0-\u017F]+$/)) {
                    const partNormalized = normalizeAccents(part.toLowerCase());
                    
                    // Verificar se a palavra normalizada contém o termo normalizado
                    if (partNormalized.includes(termNormalized)) {
                        // Encontrar onde o termo aparece na palavra normalizada
                        const termIndex = partNormalized.indexOf(termNormalized);
                        if (termIndex !== -1) {
                            // Destacar a palavra inteira (já que corresponde)
                            return '<mark>' + part + '</mark>';
                        }
                    }
                }
                
                return part;
            });
            
            resultText = processedParts.join('');
        });
        
        // Limpar highlights aninhados
        resultText = resultText.replace(/<mark>([^<]*)<mark>([^<]*)<\/mark>([^<]*)<\/mark>/gi, '<mark>$1$2$3</mark>');
        
        return resultText;
    }

    function sanitizeHTML(str) {
        if (!str) return '';
        const temp = document.createElement('div');
        temp.textContent = str;
        return temp.innerHTML;
    }
    
    function decodeHTML(html) {
        if (!html) return '';
        const txt = document.createElement('textarea');
        txt.innerHTML = html;
        return txt.value;
    }

    Promise.all([
        carregarTiposMateria(),
        carregarSelectSimples('autores_json', '#cod_autor', 'Selecione um autor...'),
        carregarSelectSimples('assuntos_materia_json', '#lst_assunto_materia', 'Selecione um assunto...')
    ]).then(() => {
        if (window.location.search) {
            popularFormPelaURL();
        } else {
            contarFiltrosAtivos();
            showInitialMessage();
        }
    }).catch(error => {
        console.error("Erro ao carregar dados iniciais:", error);
        renderizarErro("Não foi possível carregar os filtros. Recarregue a página.");
    });

    advancedSearchDiv.addEventListener('show.bs.collapse', carregarFiltrosAvancados, { once: true });

    resultadosDiv.addEventListener('click', function(e) {
        const pageLink = e.target.closest('.page-link');
        if (pageLink && pageLink.hasAttribute('data-page')) {
            e.preventDefault();
            const page = parseInt(pageLink.getAttribute('data-page'), 10);
            if (!isNaN(page)) {
                realizarBusca(page, itensPorPaginaSelect ? itensPorPaginaSelect.value : '12');
            }
        }
    });

    resultadosDiv.addEventListener('click', function(event) {
        const th = event.target.closest('.sortable-header');
        if (!th) return;
        const campo = th.dataset.sortField;
        if (!campo) return;
        let direcao = 'asc';
        if (ordemCampoInput.value === campo) {
            direcao = ordemDirecaoInput.value === 'asc' ? 'desc' : 'asc';
        }
        ordemCampoInput.value = campo;
        ordemDirecaoInput.value = direcao;
        realizarBusca(1);
    });

    // ============================================
    // MELHORIAS DE UX: VALIDAÇÃO EM TEMPO REAL
    // ============================================
    
    // Validação de número (apenas números) com feedback melhorado
    const numIdentBasica = document.getElementById('num_ident_basica');
    if (numIdentBasica) {
        // Bloquear caracteres não numéricos em tempo real
        numIdentBasica.addEventListener('keypress', function(e) {
            // Permitir apenas números (0-9)
            if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(e.key)) {
                e.preventDefault();
            }
        });
        
        // Também validar no evento input para copiar/colar
        numIdentBasica.addEventListener('input', function(e) {
            // Remover qualquer caractere não numérico
            const value = e.target.value.replace(/\D/g, '');
            if (e.target.value !== value) {
                e.target.value = value;
            }
            
            const feedbackEl = document.getElementById('num_ident_basica_feedback');
            if (value && !/^\d+$/.test(value)) {
                e.target.classList.add('is-invalid');
                e.target.setAttribute('aria-invalid', 'true');
                if (feedbackEl) {
                    feedbackEl.textContent = 'Por favor, insira apenas números.';
                    feedbackEl.classList.add('d-block');
                }
            } else {
                e.target.classList.remove('is-invalid');
                e.target.setAttribute('aria-invalid', 'false');
                if (feedbackEl) {
                    feedbackEl.classList.remove('d-block');
                }
            }
        });
    }
    
    // Validação de ano (4 dígitos, entre 1900 e 2100) com feedback melhorado
    const anoIdentBasica = document.getElementById('ano_ident_basica');
    if (anoIdentBasica) {
        // Bloquear caracteres não numéricos e limitar a 4 dígitos em tempo real
        anoIdentBasica.addEventListener('keypress', function(e) {
            // Permitir apenas números (0-9)
            if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(e.key)) {
                e.preventDefault();
            }
            // Limitar a 4 dígitos
            if (e.target.value.length >= 4 && /[0-9]/.test(e.key)) {
                e.preventDefault();
            }
        });
        
        // Também validar no evento input para copiar/colar
        anoIdentBasica.addEventListener('input', function(e) {
            // Remover qualquer caractere não numérico e limitar a 4 dígitos
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            if (e.target.value !== value) {
                e.target.value = value;
            }
            
            const feedbackEl = document.getElementById('ano_ident_basica_feedback');
            if (value && (!/^\d{4}$/.test(value) || parseInt(value) < 1900 || parseInt(value) > 2100)) {
                e.target.classList.add('is-invalid');
                e.target.setAttribute('aria-invalid', 'true');
                if (feedbackEl) {
                    if (!/^\d{4}$/.test(value)) {
                        feedbackEl.textContent = 'Por favor, insira um ano válido com 4 dígitos (ex: 2025).';
                    } else {
                        feedbackEl.textContent = 'Por favor, insira um ano entre 1900 e 2100.';
                    }
                    feedbackEl.classList.add('d-block');
                }
            } else {
                e.target.classList.remove('is-invalid');
                e.target.setAttribute('aria-invalid', 'false');
                if (feedbackEl) {
                    feedbackEl.classList.remove('d-block');
                }
            }
        });
    }
    
    // O indicador "Buscando..." será mostrado apenas durante a busca real (quando o botão Pesquisar é clicado)
    // Não há busca automática ao digitar, então não mostramos o indicador durante a digitação

    // ============================================
    // MELHORIAS DE UX: ATALHOS DE TECLADO
    // ============================================
    
    document.addEventListener('keydown', function(e) {
        // Ctrl+K / Cmd+K: Foco no primeiro campo de busca
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const assuntoInput = document.getElementById('des_assunto');
            if (assuntoInput) {
                assuntoInput.focus();
                assuntoInput.select();
            }
        }
        
        // Enter: Executar busca (se não estiver em textarea ou input de múltiplas linhas)
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && !e.target.isContentEditable) {
            if (e.target.closest('#form-pesquisa') && !e.target.closest('.btn')) {
                e.preventDefault();
                pesquisarBtn?.click();
            }
        }
        
        // Esc: Limpar filtros (se não estiver em input/textarea)
        if (e.key === 'Escape' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
            if (haFiltrosAtivos()) {
                limparBtn?.click();
            }
        }
        
        // /: Foco no primeiro campo (se não estiver em input)
        if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
            e.preventDefault();
            const primeiroCampo = form.querySelector('input[type="text"], select');
            if (primeiroCampo) {
                primeiroCampo.focus();
            }
        }
    });

    // ============================================
    // MELHORIAS DE UX: MODO SIMPLES/AVANÇADO
    // ============================================
    
    // Toggle para modo simples/avançado
    const modoSimplesKey = 'pesquisa_materias_modo_simples';
    const modoSimples = localStorage.getItem(modoSimplesKey) !== 'false'; // default: true
    
    function aplicarModoSimples(ativo) {
        const filtrosAvancados = document.getElementById('advancedSearch');
        const btnToggleFiltros = document.getElementById('btn-toggle-filtros');
        
        if (ativo) {
            // Modo simples: ocultar filtros avançados
            if (filtrosAvancados && filtrosAvancados.classList.contains('show')) {
                const bsCollapse = bootstrap.Collapse.getInstance(filtrosAvancados);
                if (bsCollapse) bsCollapse.hide();
            }
            // Ocultar botão de toggle de filtros avançados
            const btnAdvanced = document.querySelector('[data-bs-target="#advancedSearch"]');
            if (btnAdvanced) btnAdvanced.style.display = 'none';
        } else {
            // Modo avançado: mostrar botão de filtros avançados
            const btnAdvanced = document.querySelector('[data-bs-target="#advancedSearch"]');
            if (btnAdvanced) {
                btnAdvanced.classList.remove('d-none');
                btnAdvanced.classList.add('d-block');
            }
        }
        
        localStorage.setItem(modoSimplesKey, ativo.toString());
    }
    
    // Aplicar modo inicial
    aplicarModoSimples(modoSimples);
    
    // Adicionar botão de toggle modo simples/avançado (opcional, pode ser adicionado no HTML)
    // Por enquanto, o modo simples é aplicado automaticamente na primeira carga

    // ============================================
    // MELHORIAS DE ACESSIBILIDADE
    // ============================================
    
    // Adicionar aria-labels onde necessário (já adicionados no HTML)
    // Adicionar skip links se necessário
    
    // Melhorar navegação por teclado em badges de documentos
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('badge-documento')) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.target.click();
            }
        }
    });
    
    // Adicionar role="button" e tabindex aos badges clicáveis (quando renderizados)
    function adicionarAcessibilidadeBadges() {
        document.querySelectorAll('.badge-documento').forEach(badge => {
            if (!badge.hasAttribute('role')) {
                badge.setAttribute('role', 'button');
                badge.setAttribute('tabindex', '0');
            }
        });
    }
    
    // Observar mudanças no DOM para adicionar acessibilidade aos badges dinâmicos
    const observer = new MutationObserver(function(mutations) {
        adicionarAcessibilidadeBadges();
    });
    observer.observe(document.body, { childList: true, subtree: true });
    
    // Adicionar acessibilidade aos badges existentes
    adicionarAcessibilidadeBadges();
});
</script>
