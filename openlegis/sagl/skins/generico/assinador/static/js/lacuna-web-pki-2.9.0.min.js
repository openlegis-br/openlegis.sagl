void 0===window.lacunaWebPKIExtension&&(window.lacunaWebPKIExtension=null),function(e){var i,t,n;if(e.Promise=function(e,i){this.successCallback=function(){},this.failCallback=null,this.angularScope=e,this.ngZone=i},e.Promise.prototype.success=function(e){return this.successCallback=e,this},e.Promise.prototype.error=function(e){return this.failCallback=function(i){e(i.message,i.error,i.origin,i.code)},this},e.Promise.prototype.fail=function(e){return this.failCallback=e,this},e.Promise.prototype._invokeSuccess=function(i,t){if(t>0){var n=this;setTimeout(function(){n._invokeSuccess(i)},t)}else{var r=this.successCallback||function(){e._log("Success ignored (no callback registered)")};this._apply(function(){r(i)})}},e.Promise.prototype._invokeError=function(e,i){if(i>0){var t=this;setTimeout(function(){t._invokeError(e)},i)}else{var n=this.failCallback||function(e){throw"Web PKI error originated at "+e.origin+": "+e.message+"\n"+e.complete+"\ncode: "+e.code};this._apply(function(){n({userMessage:e.userMessage||e.message,message:e.message,error:e.complete,origin:e.origin,code:e.code})})}},e.Promise.prototype._apply=function(e){if(this.angularScope){var i=this.angularScope.$root.$$phase;"$apply"==i||"$digest"==i?e():this.angularScope.$apply(function(){e()})}else this.ngZone?this.ngZone.run(function(){e()}):e()},e._installUrl="https://get.webpkiplugin.com/",e._chromeExtensionId="dcngeagmmhegagicpcmpinaoklddcgon",e._firefoxExtensionId="webpki@lacunasoftware.com",e._chromeExtensionFirstVersionWithSelfUpdate="2.0.20",e._extensionRequiredVersion="2.11.7",e._chromeNativeWinRequiredVersion="2.6.2",e._chromeNativeLinuxRequiredVersion="2.7.4",e._chromeNativeMacRequiredVersion="2.7.4",e._ieAddonRequiredVersion="2.4.2",e._chromeInstallationStates={INSTALLED:0,EXTENSION_NOT_INSTALLED:1,EXTENSION_OUTDATED:2,NATIVE_NOT_INSTALLED:3,NATIVE_OUTDATED:4},e._certKeyUsages={crlSign:2,dataEncipherment:16,decipherOnly:32768,digitalSignature:128,encipherOnly:1,keyAgreement:8,keyCertSign:4,keyEncipherment:32,nonRepudiation:64},e.apiVersions={v1_0:"1.0",v1_1:"1.1",v1_2:"1.2",v1_3:"1.3",v1_4:"1.4",latest:"latest"},e._apiMap={nativeWin:{},nativeLinux:{},nativeMac:{},ieAddon:{},extension:{}},e._apiMap.nativeWin[e.apiVersions.v1_0]="2.1.0",e._apiMap.nativeWin[e.apiVersions.v1_1]="2.3.0",e._apiMap.nativeWin[e.apiVersions.v1_2]="2.4.1",e._apiMap.nativeWin[e.apiVersions.v1_3]="2.5.0",e._apiMap.nativeWin[e.apiVersions.v1_4]="2.6.2",e._apiMap.ieAddon[e.apiVersions.v1_0]="2.0.4",e._apiMap.ieAddon[e.apiVersions.v1_1]="2.1.1",e._apiMap.ieAddon[e.apiVersions.v1_2]="2.2.4",e._apiMap.ieAddon[e.apiVersions.v1_3]="2.3.0",e._apiMap.ieAddon[e.apiVersions.v1_4]="2.4.2",e._apiMap.nativeLinux[e.apiVersions.v1_0]="2.0.0",e._apiMap.nativeLinux[e.apiVersions.v1_1]="2.4.0",e._apiMap.nativeLinux[e.apiVersions.v1_2]="2.6.2",e._apiMap.nativeLinux[e.apiVersions.v1_3]="2.7.0",e._apiMap.nativeLinux[e.apiVersions.v1_4]="2.7.4",e._apiMap.nativeMac[e.apiVersions.v1_0]="2.3.0",e._apiMap.nativeMac[e.apiVersions.v1_1]="2.4.0",e._apiMap.nativeMac[e.apiVersions.v1_2]="2.6.1",e._apiMap.nativeMac[e.apiVersions.v1_3]="2.7.0",e._apiMap.nativeMac[e.apiVersions.v1_4]="2.7.4",e._apiMap.extension[e.apiVersions.v1_0]="2.3.2",e._apiMap.extension[e.apiVersions.v1_1]="2.7.0",e._apiMap.extension[e.apiVersions.v1_2]="2.9.1",e._apiMap.extension[e.apiVersions.v1_3]="2.10.1",e._apiMap.extension[e.apiVersions.v1_4]="2.11.7",e._apiMap.nativeWin[e.apiVersions.latest]=e._chromeNativeWinRequiredVersion,e._apiMap.ieAddon[e.apiVersions.latest]=e._ieAddonRequiredVersion,e._apiMap.nativeLinux[e.apiVersions.latest]=e._chromeNativeLinuxRequiredVersion,e._apiMap.nativeMac[e.apiVersions.latest]=e._chromeNativeMacRequiredVersion,e._apiMap.extension[e.apiVersions.latest]=e._extensionRequiredVersion,e._nativeInfo={},e.installationStates={INSTALLED:0,NOT_INSTALLED:1,OUTDATED:2,BROWSER_NOT_SUPPORTED:3},e.padesPolicies={basic:"basic",brazilAdrBasica:"brazilAdrBasica"},e.cadesPolicies={bes:"cadesBes",brazilAdrBasica:"brazilAdrBasica"},e.xmlPolicies={xmlDSig:"xmlDSig",xadesBes:"xadesBes",brazilNFe:"brazilNFe",brazilAdrBasica:"brazilAdrBasica"},e.cadesAcceptablePolicies={pkiBrazil:["brazilAdrBasica","brazilAdrTempo","brazilAdrValidacao","brazilAdrCompleta","brazilAdrArquivamento"]},e.xmlAcceptablePolicies={pkiBrazil:["brazilAdrBasica","brazilAdrTempo"]},e.standardTrustArbitrators={pkiBrazil:{type:"standard",standardArbitrator:"pkiBrazil"},pkiItaly:{type:"standard",standardArbitrator:"pkiItaly"},pkiPeru:{type:"standard",standardArbitrator:"pkiPeru"},windows:{type:"standard",standardArbitrator:"windows"}},e.xmlInsertionOptions={appendChild:"appendChild",prependChild:"prependChild",appendSibling:"appendSibling",prependSibling:"prependSibling"},e.outputModes={showSaveFileDialog:"showSaveFileDialog",saveInFolder:"saveInFolder",autoSave:"autoSave",returnContent:"returnContent"},e.trustArbitratorTypes={trustedRoot:"trustedRoot",tsl:"tsl",standard:"standard"},e.padesPaperSizes={custom:"custom",a0:"a0",a1:"a1",a2:"a2",a3:"a3",a4:"a4",a5:"a5",a6:"a6",a7:"a7",a8:"a8",letter:"letter",legal:"legal",ledger:"ledger"},e.padesHorizontalAlign={left:"left",center:"center",rigth:"rigth"},e.padesVerticalAlign={top:"top",center:"center",bottom:"bottom"},e.padesMeasurementUnits={centimeters:"centimeters",pdfPoints:"pdfPoints"},e.padesPageOrientations={auto:"auto",portrait:"portrait",landscape:"landscape"},e.markElementTypes={text:"text",image:"image"},e.markTextStyle={normal:0,bold:1,italic:2},e.passwordPolicies={lettersAndNumbers:1,upperAndLowerCase:2,specialCharacters:4},e.pkcs11Modules={safeSign:{win:"aetpkss1.dll",linux:"libaetpkss.so.3",mac:"libaetpkss.dylib"},safeNet:{win:"eTPKCS11.dll",linux:"libeToken.so",mac:"libeToken.dylib"}},e.errorCodes={UNDEFINED:"undefined",INTERNAL:"internal",USER_CANCELLED:"user_cancelled",OS_NOT_SUPPORTED:"os_not_supported",ADDON_TIMEOUT:"addon_timeout",ADDON_NOT_DETECTED:"addon_not_detected",ADDON_SEND_COMMAND_FAILURE:"addon_send_command_failure",CERTIFICATE_NOT_FOUND:"certificate_not_found",COMMAND_UNKNOWN:"command_unknown",COMMAND_NOT_SUPPORTED:"command_not_supported",COMMAND_PARAMETER_NOT_SET:"command_parameter_not_set",COMMAND_INVALID_PARAMETER:"command_invalid_parameter",NATIVE_CONNECT_FAILURE:"native_connect_failure",NATIVE_DISCONNECTED:"native_disconnected",NATIVE_NO_RESPONSE:"native_no_response",REST_PKI_GET_PENDING_SIGNATURE:"rest_pki_get_pending_signature",REST_PKI_POST_SIGNATURE:"rest_pki_post_signature",REST_PKI_INVALID_CERTIFICATE:"rest_pki_invalid_certificate",LICENSE_NOT_SET:"license_not_set",LICENSE_INVALID:"license_invalid",LICENSE_RESTRICTED:"license_restricted",LICENSE_EXPIRED:"license_expired",LICENSE_DOMAIN_NOT_ALLOWED:"license_domain_not_allowed",VALIDATION_ERROR:"validation_error",P11_ERROR:"p11_error",P11_TOKEN_NOT_FOUND:"p11_token_not_found",P11_NOT_SUPPORTED:"p11_not_supported",KEYSET_NOT_FOUND:"keyset_not_found",ALGORITHM_NOT_SUPPORTED:"algorithm_not_supported",SIGNED_PDF_TO_MARK:"signed_pdf_to_mark",JSON_ERROR:"json_error",IO_ERROR:"io_error",KEYCHAIN_ERROR:"keychain_error",KEYCHAIN_SIGN_ERROR:"keychain_sign_error",DECODE_ERROR:"decode_error",CSP_KEYSET_NOT_DEFINED:"csp_keyset_not_defined",CSP_INVALID_ALGORITHM:"csp_invalid_algorithm",CSP_INVALID_PROVIDER_TYPE:"csp_invalid_provider_type"},e._compareVersions=function(e,i){var t=e.split("."),n=i.split(".");function r(e){return/^\d+$/.test(e)}function a(e){for(var i=0;i<e.length;++i)if(!r(e[i]))return!1;return!0}if(!a(t)||!a(n))return NaN;for(var s=0;s<t.length;++s){if(n.length===s)return 1;var o=parseInt(t[s],10),l=parseInt(n[s],10);if(o!==l){if(o>l)return 1;return -1}}return t.length!=n.length?-1:0},e._log=function(e){window.console&&window.console.log(e)},e._parseDataUrl=function(i){var t=/^data:(.+);base64,(.+)$/.exec(i);return t?{mimeType:t[1],content:t[2]}:(e._log("failed to parse data url"),null)},e._downloadResource=function(i,t){e._log("resolving resource reference: "+i);var n=new XMLHttpRequest;n.open("GET",i),n.responseType="blob",n.onload=function(){var i=new FileReader;i.onloadend=function(){e._log("resource reference resolved"),t(e._parseDataUrl(i.result))},i.readAsDataURL(n.response)},n.send()},e._getRequestOsP11Modules=function(i){if(!i||!i.length)return null;osModules=[];for(var t=0;t<i.length;t++)"Windows"===e._nativeInfo.os?osModules.push(i[t].win):"Linux"===e._nativeInfo.os?osModules.push(i[t].linux):"Darwin"===e._nativeInfo.os&&osModules.push(i[t].mac);return osModules},e._createContext=function(i){var t=new e.Promise(this.angularScope,this.ngZone);return i&&i.success&&t.success(i.success),i&&i.fail?t.fail(i.fail):i&&i.error?t.error(i.error):t.fail(this.defaultFailCallback),{promise:t,license:this.license}},e.init=function(i){i?"function"==typeof i&&(i={ready:i}):i={},i.license&&(this.license=i.license),i.defaultError&&(this.defaultFailCallback=function(e){i.defaultError(e.message,e.error,e.origin,e.code)}),i.defaultFail&&(this.defaultFailCallback=i.defaultFail),i.angularScope&&(this.angularScope=i.angularScope),i.ngZone&&(this.ngZone=i.ngZone),i.brand&&(this.brand=i.brand),i.restPkiUrl&&(this.restPkiUrl=i.restPkiUrl);var t=this,n=function(n){n.isInstalled?i.ready?i.ready():e._log("Web PKI ready (no callback registered)"):i.notInstalled?i.notInstalled(n.status,n.message,n.browserSpecificStatus):t.redirectToInstallPage()},r=this._createContext({success:n,fail:i.fail,error:i.error});return e._requestHandler.checkInstalled(r,i.requiredApiVersion),r.promise},e.getVersion=function(i){var t=this._createContext(i);return e._requestHandler.sendCommand(t,"getVersion",null),t.promise},e.listCertificates=function(i){if(i){if(i.filter&&"function"!=typeof i.filter){if("boolean"==typeof i.filter)throw'args.filter must be a function (hint: if you used "pki.filters.xxx()", try removing the "()")';throw"args.filter must be a function, received "+typeof i.filter}}else i={};var t=this._createContext(i);return e._requestHandler.sendCommand(t,"listCertificates",null,function(t){return e._processCertificates(t,i.filter,i.selectId,i.selectOptionFormatter)}),t.promise},e._processCertificates=function(i,t,n,r){for(var a=[],s=0;s<i.length;s++){var o=i[s];if(o.validityStart=new Date(o.validityStart),o.validityEnd=new Date(o.validityEnd),o.keyUsage=e._processKeyUsage(o.keyUsage),o.pkiBrazil&&o.pkiBrazil.dateOfBirth){var l=o.pkiBrazil.dateOfBirth;o.pkiBrazil.dateOfBirth=new Date(parseInt(l.slice(0,4),10),parseInt(l.slice(5,7),10)-1,parseInt(l.slice(8,10),10))}t?t(o)&&a.push(o):a.push(o)}if(a.sort(function(e,i){return e.subjectName>i.subjectName?1:e.subjectName<i.subjectName?-1:e.validityEnd>i.validityEnd?-1:e.validityEnd<i.validityEnd?1:0}),n){r||(r=function(e){return e.subjectName+" (issued by "+e.issuerName+")"});for(var c=document.getElementById(n);c.options.length>0;)c.remove(0);for(var u=0;u<a.length;u++){var d=a[u],p=document.createElement("option");p.value=d.thumbprint,p.text=r(d),c.add(p)}}return a},e._processKeyUsage=function(i){return{crlSign:(i&e._certKeyUsages.crlSign)!=0,dataEncipherment:(i&e._certKeyUsages.dataEncipherment)!=0,decipherOnly:(i&e._certKeyUsages.decipherOnly)!=0,digitalSignature:(i&e._certKeyUsages.digitalSignature)!=0,encipherOnly:(i&e._certKeyUsages.encipherOnly)!=0,keyAgreement:(i&e._certKeyUsages.keyAgreement)!=0,keyCertSign:(i&e._certKeyUsages.keyCertSign)!=0,keyEncipherment:(i&e._certKeyUsages.keyEncipherment)!=0,nonRepudiation:(i&e._certKeyUsages.nonRepudiation)!=0}},e.filters={isPkiBrazilPessoaFisica:function(e){if(void 0===e)throw'filter called without cert argument (hint: if you are using "pki.filters.isPkiBrazilPessoaFisica()", try "pki.filters.isPkiBrazilPessoaFisica")';return e.pkiBrazil&&""!==(e.pkiBrazil.cpf||"")&&""===(e.pkiBrazil.cnpj||"")},hasPkiBrazilCpf:function(e){if(void 0===e)throw'filter called without cert argument (hint: if you are using "pki.filters.hasPkiBrazilCpf()", try "pki.filters.hasPkiBrazilCpf")';return e.pkiBrazil&&""!==(e.pkiBrazil.cpf||"")},hasPkiBrazilCnpj:function(e){if(void 0===e)throw'filter called without cert argument (hint: if you are using "pki.filters.hasPkiBrazilCnpj()", try "pki.filters.hasPkiBrazilCnpj")';return e.pkiBrazil&&""!==(e.pkiBrazil.cnpj||"")},pkiBrazilCpfEquals:function(e){if("string"!=typeof e)throw'cpf must be a string (hint: if you are using "pki.filters.pkiBrazilCpfEquals", try "pki.filters.pkiBrazilCpfEquals(\'somecpf\')")';return function(i){return i.pkiBrazil&&i.pkiBrazil.cpf===e}},pkiBrazilCnpjEquals:function(e){if("string"!=typeof e)throw'cnpj must be a string (hint: if you are using "pki.filters.pkiBrazilCnpjEquals", try "pki.filters.pkiBrazilCnpjEquals(\'somecnpj\')")';return function(i){return i.pkiBrazil&&i.pkiBrazil.cnpj===e}},hasPkiItalyCodiceFiscale:function(e){if(void 0===e)throw'filter called without cert argument (hint: if you are using "pki.filters.hasPkiItalyCodiceFiscale()", try "pki.filters.hasPkiItalyCodiceFiscale")';return e.pkiItaly&&""!==(e.pkiItaly.codiceFiscale||"")},pkiItalyCodiceFiscaleEquals:function(e){if("string"!=typeof e)throw'cf must be a string (hint: if you are using "pki.filters.pkiItalyCodiceFiscaleEquals", try "pki.filters.pkiItalyCodiceFiscaleEquals(\'someCodice\')")';return function(i){return i.pkiItaly&&i.pkiItaly.codiceFiscale===e}},isWithinValidity:function(e){if(void 0===e)throw'filter called without cert argument (hint: if you are using "pki.filters.isWithinValidity()", try "pki.filters.isWithinValidity")';var i=new Date;return e.validityStart<=i&&i<=e.validityEnd},all:function(){var e;return e=1===arguments.length&&"object"==typeof arguments[0]?arguments[0]:arguments,function(i){for(var t=0;t<e.length;t++)if(!(0,e[t])(i))return!1;return!0}},any:function(){var e;return e=1===arguments.length&&"object"==typeof arguments[0]?arguments[0]:arguments,function(i){for(var t=0;t<e.length;t++)if((0,e[t])(i))return!0;return!1}}},e.readCertificate=function(i){"string"==typeof i&&(i={thumbprint:i});var t=this._createContext(i);return e._requestHandler.sendCommand(t,"readCertificate",{certificateThumbprint:i.thumbprint}),t.promise},e.pollNative=function(i){i||(i={});var t=this._createContext(i),n=i.requiredApiVersion;if(n||(n=e.apiVersions.latest),!e._apiMap.nativeWin[n])throw"Unknown JSlib API version: "+n;return e._requestHandler.sendCommand(t,"pollNative",{requiredNativeWinVersion:e._apiMap.nativeWin[n],requiredNativeLinuxVersion:e._apiMap.nativeLinux[n],requiredNativeMacVersion:e._apiMap.nativeMac[n]}),t.promise},e.signHash=function(i){var t=this._createContext(i),n={certificateThumbprint:i.thumbprint,hash:i.hash,digestAlgorithm:i.digestAlgorithm};return e._requestHandler.sendCommand(t,"signHash",n),t.promise},e.signData=function(i){var t=this._createContext(i),n={certificateThumbprint:i.thumbprint,data:i.data,digestAlgorithm:i.digestAlgorithm};return e._requestHandler.sendCommand(t,"signData",n),t.promise},e.signWithRestPki=function(i){var t=this._createContext(i),n={certificateThumbprint:i.thumbprint,token:i.token,restPkiUrl:this.restPkiUrl};return e._requestHandler.sendCommand(t,"signWithRestPki",n),t.promise},e.preauthorizeSignatures=function(i){i||(i={});var t=this._createContext(i),n={certificateThumbprint:i.certificateThumbprint,signatureCount:i.signatureCount};return e._requestHandler.sendCommand(t,"preauthorizeSignatures",n),t.promise},e.showFolderBrowser=function(i){i?"string"==typeof i&&(i={message:i}):i={};var t=this._createContext(i),n={message:i.message};return e._requestHandler.sendCommand(t,"showFolderBrowser",n),t.promise},e.showFileBrowser=function(i){i||(i={});var t=this._createContext(i),n={multiselect:i.multiselect,filters:i.filters,dialogTitle:i.dialogTitle};return e._requestHandler.sendCommand(t,"showFileBrowser",n),t.promise},e.downloadToFolder=function(i){i||(i={});var t=i.url||"";if(0>t.indexOf("://")){var n=document.createElement("a");n.href=t,t=n.href}var r=this._createContext(i),a={url:t,folderId:i.folderId,filename:i.filename};return e._requestHandler.sendCommand(r,"downloadToFolder",a),r.promise},e.openFolder=function(i){i?"string"==typeof i&&(i={folderId:i}):i={};var t=this._createContext(i);return e._requestHandler.sendCommand(t,"openFolder",i.folderId),t.promise},e.openFile=function(i){i?"string"==typeof i&&(i={fileId:i}):i={};var t=this._createContext(i);return e._requestHandler.sendCommand(t,"openFile",i.fileId),t.promise},e.redirectToInstallPage=function(){document.location.href=e._installUrl+(this.brand||"")+"?returnUrl="+encodeURIComponent(document.URL)+"&jslib=2.9.0"},e.updateExtension=function(i){i||(i={});var t=this._createContext(i);return e._requestHandler.sendCommand(t,"updateExtension",null),t.promise},e._createCommonSignerRequest=function(e){if(!e.output)throw"An output parameter must be passed to signer methods";return{fileId:e.fileId,content:e.content,certificateThumbprint:e.certificateThumbprint,output:{mode:e.output.mode,folderId:e.output.folderId,dialogTitle:e.output.dialogTitle,fileNameSuffix:e.output.fileNameSuffix},trustArbitrators:e.trustArbitrators,clearPolicyTrustArbitrators:e.clearPolicyTrustArbitrators,policy:e.policy}},e.signPdf=function(i){var t=this._createContext(i),n=e._createCommonSignerRequest(i);return n.visualRepresentation=i.visualRepresentation,n.pdfMarks=i.pdfMarks,n.bypassMarksIfSigned=i.bypassMarksIfSigned,n.visualRepresentation&&n.visualRepresentation.image&&n.visualRepresentation.image.resource&&!n.visualRepresentation.image.resource.content&&n.visualRepresentation.image.resource.url&&!/^(https?:)?\/\//.exec(n.visualRepresentation.image.resource.url)?e._downloadResource(n.visualRepresentation.image.resource.url,function(i){n.visualRepresentation.image.resource=i,e._requestHandler.sendCommand(t,"signPdf",n)}):e._requestHandler.sendCommand(t,"signPdf",n),t.promise},e.signCades=function(i){var t=this._createContext(i),n=e._createCommonSignerRequest(i);return n.cmsToCosignFileId=i.cmsToCosignFileId,n.autoDetectCosign=i.autoDetectCosign,n.includeEncapsulatedContent=null===i.includeEncapsulatedContent||void 0===i.includeEncapsulatedContent||i.includeEncapsulatedContent,e._requestHandler.sendCommand(t,"signCades",n),t.promise},e.signFullXml=function(i){var t=this._createContext(i),n=e._createCommonSignerRequest(i);return n.signerType="fullXml",e._signXmlCommon(i,n,t),t.promise},e.signXmlElement=function(i){var t=this._createContext(i),n=e._createCommonSignerRequest(i);return n.signerType="xmlElement",n.toSignElementId=i.toSignElementId,n.toSignElementsIds=i.toSignElementsIds,n.toSignElementsXPath=i.toSignElementsXPath,n.idResolutionTable=i.idResolutionTable,e._signXmlCommon(i,n,t),t.promise},e._signXmlCommon=function(i,t,n){t.signatureElementId=i.signatureElementId,i.signatureElementLocation&&(t.signatureElementLocation={xpath:i.signatureElementLocation.xpath,insertionOption:i.signatureElementLocation.insertionOption}),t.namespaces=i.namespaces,e._requestHandler.sendCommand(n,"signXml",t)},e._createCommonOpenRequest=function(e){return{signatureFileId:e.signatureFileId,signatureContent:e.signatureContent,validate:e.validate,dateReference:e.dateReference,trustArbitrators:e.trustArbitrators,clearPolicyTrustArbitrators:e.clearPolicyTrustArbitrators,specificPolicy:e.specificPolicy}},e.openPades=function(i){var t=this._createContext(i),n=e._createCommonOpenRequest(i);return e._requestHandler.sendCommand(t,"openPades",n),t.promise},e.openCades=function(i){var t=this._createContext(i),n=e._createCommonOpenRequest(i);return n.originalFileId=i.originalFileId,n.originalContent=i.originalContent,n.acceptablePolicies=i.acceptablePolicies,e._requestHandler.sendCommand(t,"openCades",n),t.promise},e.openXmlSignature=function(i){var t=this._createContext(i),n=e._createCommonOpenRequest(i);return n.idResolutionTable=i.idResolutionTable,n.acceptablePolicies=i.acceptablePolicies,e._requestHandler.sendCommand(t,"openXmlSignature",n),t.promise},e.listTokens=function(i){var t=this._createContext(i),n={pkcs11Modules:e._getRequestOsP11Modules(i.pkcs11Modules)};return e._requestHandler.sendCommand(t,"listTokens",n),t.promise},e.generateTokenRsaKeyPair=function(i){var t=this._createContext(i),n={pkcs11Modules:e._getRequestOsP11Modules(i.pkcs11Modules),subjectName:i.subjectName,tokenSerialNumber:i.tokenSerialNumber,keyLabel:i.keyLabel,keySize:i.keySize};return e._requestHandler.sendCommand(t,"generateTokenRsaKeyPair",n),t.promise},e.generateSoftwareRsaKeyPair=function(i){var t=this._createContext(i),n={subjectName:i.subjectName,keySize:i.keySize};return e._requestHandler.sendCommand(t,"generateSoftwareRsaKeyPair",n),t.promise},e.importTokenCertificate=function(i){var t=this._createContext(i),n={pkcs11Modules:e._getRequestOsP11Modules(i.pkcs11Modules),tokenSerialNumber:i.tokenSerialNumber,certificateContent:i.certificateContent,certificateLabel:i.certificateLabel};return e._requestHandler.sendCommand(t,"importTokenCertificate",n),t.promise},e.importCertificate=function(i){var t=this._createContext(i),n={certificateContent:i.certificateContent,passwordPolicies:i.passwordPolicies,passwordMinLength:i.passwordMinLength,savePkcs12:i.savePkcs12};return e._requestHandler.sendCommand(t,"importCertificate",n),t.promise},e.sendAuthenticatedRequest=function(i){var t=this._createContext(i),n={certificateThumbprint:i.certificateThumbprint,method:i.method,headers:i.headers,body:i.body,url:i.url};return e._requestHandler.sendCommand(t,"sendAuthenticatedRequest",n),t.promise},e.detectedBrowser=(n=(t=navigator.userAgent).match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[],/trident/i.test(n[1])?"IE "+((i=/\brv[ :]+(\d+)/g.exec(t)||[])[1]||""):"Chrome"===n[1]&&null!==(i=t.match(/\b(OPR|Edge)\/(\d+)/))?i.slice(1).join(" ").replace("OPR","Opera"):(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(i=t.match(/version\/(\d+)/i))&&n.splice(1,1,i[1]),n.join(" "))),void 0===e._requestHandler){var r="0.0.0",a=null,s=null,o=null,l=null,c=null,u=null,d=null,p=null,f=function(i){if(i||(i=e.apiVersions.v1_3),!e._apiMap.nativeWin[i])throw"Unknown JSlib API version: "+i;s=e._apiMap.nativeWin[i],o=e._apiMap.nativeLinux[i],l=e._apiMap.nativeMac[i],c=e._apiMap.ieAddon[i],r=e._apiMap.extension[i],d&&(a=e._chromeExtensionFirstVersionWithSelfUpdate)};u=e.detectedBrowser.indexOf("IE")>=0,d=e.detectedBrowser.indexOf("Chrome")>=0,p=e.detectedBrowser.indexOf("Firefox")>=0,u?e._requestHandler=new function(){var i={},t=0,n=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)},r=function(e,r){var a=n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n();return i[a]={promise:e,pollStart:t,responseProcessor:r},a},a=function(){return window.lacunaWebPKIExtension},s=function(){if(a()){var e=a().GetAvailableResults();if(null===e)throw"Add-on method GetAvailableResults failed";var n=JSON.parse(e),r=[];for(var o in i){var l=i[o],c=!1;if(l.sendFailed)c=!0;else{for(var u=null,d=0;d<n.length;d++)if(n[d].requestId==o){u=n[d];break}null!==u?(u.success?(l.responseProcessor&&(u.response=l.responseProcessor(u.response)),l.promise._invokeSuccess(u.response)):l.promise._invokeError(u.exception),c=!0):t>=l.pollStart+120&&(l.promise._invokeError({message:"The operation has timed out",complete:"The operation has timed out",origin:"helper",code:"addon_timeout"}),c=!0)}c&&r.push(o)}for(var p=0;p<r.length;p++)delete i[r[p]];t+=1}setTimeout(s,500)},o=function(i,t){if(e._log("checking extension"),null===a()){t>1?setTimeout(function(){o(i,t-1)},200):i.promise._invokeSuccess({isInstalled:!1,status:e.installationStates.NOT_INSTALLED,message:"The Web PKI add-on is not installed"});return}var n=new e.Promise(null);n.success(function(t){e._nativeInfo={os:"Windows",installedVersion:t},0>e._compareVersions(t,c)?i.promise._invokeSuccess({isInstalled:!1,status:e.installationStates.OUTDATED,message:"The Web PKI add-on is outdated (installed version: "+t+", latest version: "+c+")"}):i.promise._invokeSuccess({isInstalled:!0})}),n.fail(function(e){i.promise._invokeError(e)}),l({license:i.license,promise:n},"getVersion",null)},l=function(e,t,n,s){if(a()){var o,l=r(e.promise,s),c={requestId:l,license:e.license,command:t,request:n};try{var u=a().SendCommand(JSON.stringify(c));!1===u&&(o="Failed to send command to add-on")}catch(d){o="Exception when sending command to add-on: "+d}o&&(e.promise._invokeError({message:"Failed to send command to add-on",complete:o,origin:"helper",code:"addon_send_command_failure"},200),i[l].sendFailed=!0)}else e.promise._invokeError({message:"Add-on not detected",complete:"Add-on not detected",origin:"helper",code:"addon_not_detected"},200)},u=function(e,i){f(i),setTimeout(function(){o(e,25)},200)};this.sendCommand=l,this.checkInstalled=u,s()}:e._requestHandler=new function(){var i="com.lacunasoftware.WebPKI.RequestEvent",t="com.lacunasoftware.WebPKI.ResponseEvent",n={},c=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)},u=function(e,i){var t=c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c();return n[t]={promise:e,responseProcessor:i},t},p=function(e,t,n,r){var a={requestId:u(e.promise,r),license:e.license,command:t,request:n};if(d){var s=new CustomEvent("build",{detail:a});s.initEvent(i),document.dispatchEvent(s)}else window.postMessage({port:i,message:a},"*")},m=function(e,i){f(i),setTimeout(function(){g(e,25)},200)},g=function(i,t){if(e._log("polling extension"),null===(document.getElementById(e._chromeExtensionId)||document.getElementById(e._firefoxExtensionId.replace(/[^A-Za-z0-9_]/g,"_")))){t>1?setTimeout(function(){g(i,t-1)},200):i.promise._invokeSuccess({isInstalled:!1,status:e.installationStates.NOT_INSTALLED,message:"The Web PKI extension is not installed",browserSpecificStatus:e._chromeInstallationStates.EXTENSION_NOT_INSTALLED});return}v(i)},v=function(i){e._log("checking extension version");var t=new e.Promise(null);t.success(function(t){if(0>e._compareVersions(t,r)){var n=null!==a&&e._compareVersions(t,a)>=0;i.promise._invokeSuccess({isInstalled:!1,status:e.installationStates.OUTDATED,browserSpecificStatus:e._chromeInstallationStates.EXTENSION_OUTDATED,message:"The Web PKI extension is outdated (installed version: "+t+", required version: "+r+")",chromeExtensionCanSelfUpdate:n})}else h(i)}),t.fail(function(e){i.promise._invokeError(e)}),p({license:i.license,promise:t},"getExtensionVersion",null)},h=function(i){e._log("initializing extension");var t=new e.Promise(null);t.success(function(t){t.isReady?(e._nativeInfo=t.nativeInfo,"Windows"===t.nativeInfo.os&&0>e._compareVersions(t.nativeInfo.installedVersion,s)?i.promise._invokeSuccess({isInstalled:!1,status:e.installationStates.OUTDATED,browserSpecificStatus:e._chromeInstallationStates.NATIVE_OUTDATED,message:"The Web PKI native component is outdated (installed version: "+t.nativeInfo.installedVersion+", required version: "+s+")",platformInfo:t.platformInfo,nativeInfo:t.nativeInfo}):"Linux"===t.nativeInfo.os&&0>e._compareVersions(t.nativeInfo.installedVersion,o)?i.promise._invokeSuccess({isInstalled:!1,status:e.installationStates.OUTDATED,browserSpecificStatus:e._chromeInstallationStates.NATIVE_OUTDATED,message:"The Web PKI native component is outdated (installed version: "+t.nativeInfo.installedVersion+", required version: "+o+")",platformInfo:t.platformInfo,nativeInfo:t.nativeInfo}):"Darwin"===t.nativeInfo.os&&0>e._compareVersions(t.nativeInfo.installedVersion,l)?i.promise._invokeSuccess({isInstalled:!1,status:e.installationStates.OUTDATED,browserSpecificStatus:e._chromeInstallationStates.NATIVE_OUTDATED,message:"The Web PKI native component is outdated (installed version: "+t.nativeInfo.installedVersion+", required version: "+l+")",platformInfo:t.platformInfo,nativeInfo:t.nativeInfo}):i.promise._invokeSuccess({isInstalled:!0})):i.promise._invokeSuccess({isInstalled:!1,status:E(t.status),browserSpecificStatus:t.status,message:t.message,platformInfo:t.platformInfo,nativeInfo:t.nativeInfo})}),t.fail(function(e){i.promise._invokeError(e)}),p({license:i.license,promise:t},"initialize",null)},E=function(i){return i===e._chromeInstallationStates.INSTALLED?e.installationStates.INSTALLED:i===e._chromeInstallationStates.EXTENSION_OUTDATED||i===e._chromeInstallationStates.NATIVE_OUTDATED?e.installationStates.OUTDATED:e.installationStates.NOT_INSTALLED},I=function(e){var i=n[e.requestId];delete n[e.requestId],e.success?(i.responseProcessor&&(e.response=i.responseProcessor(e.response)),i.promise._invokeSuccess(e.response)):i.promise._invokeError(e.exception)};this.sendCommand=p,this.checkInstalled=m,d?document.addEventListener(t,function(e){I(e.detail)}):window.addEventListener("message",function(e){e&&e.data&&e.data.port===t&&I(e.data.message)})}}}((LacunaWebPKI=function(e){this.license=null,this.defaultFailCallback=null,this.angularScope=null,this.ngZone=null,this.brand=null,this.restPkiUrl=null,e&&(this.license=e)}).prototype),"object"==typeof exports&&(Object.defineProperties?Object.defineProperties(exports,{default:{value:LacunaWebPKI},__esModule:{value:!0},LacunaWebPKI:{value:LacunaWebPKI}}):(exports.default=LacunaWebPKI,exports.__esModule=!0,exports.LacunaWebPKI=LacunaWebPKI));
